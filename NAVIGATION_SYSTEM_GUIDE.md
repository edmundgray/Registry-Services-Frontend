# Dynamic Navigation System Guide

This document explains how the new dynamic sidebar menu and breadcrumb navigation system works in the Registry Services application.

## Overview

The application now features a modern, dynamic navigation system consisting of:

1. **Dynamic Sidebar Menu** - Role-based navigation with authentication integration
2. **Breadcrumb Navigation** - Context-aware workflow tracking with step indicators
3. **Mobile Responsive Design** - Optimized for all screen sizes

## Architecture

### Core Components

- **`sidebarManager.js`** - Handles dynamic sidebar generation and management
- **`breadcrumbManager.js`** - Manages breadcrumb navigation and context tracking
- **`authManager.js`** - Authentication state management (existing, enhanced integration)

### Key Features

- âœ… **Role-based Navigation** - Menu items appear/hide based on user authentication
- âœ… **Context-aware Breadcrumbs** - Tracks navigation source and workflow progress
- âœ… **Unsaved Changes Detection** - Prevents accidental navigation with unsaved data
- âœ… **Mobile Responsive** - Adapts to different screen sizes
- âœ… **Debug Infrastructure** - Built-in logging and test pages for troubleshooting

---

## Dynamic Sidebar System

### How It Works

The sidebar is dynamically generated based on user authentication state and current page context.

### Implementation

#### 1. HTML Structure
Replace hardcoded sidebar with a container:

```html
<!-- OLD: Hardcoded sidebar -->
<div class="sidebar">
    <ul>
        <li><a href="...">...</a></li>
        <!-- Static menu items -->
    </ul>
</div>

<!-- NEW: Dynamic sidebar container -->
<div id="sidebarContainer">
    <!-- Sidebar will be dynamically generated by sidebarManager.js -->
</div>
```

#### 2. JavaScript Integration
Add to your HTML page head:

```html
<script src="../JS/sidebarManager.js"></script>
<script src="../JS/breadcrumbManager.js"></script>
```

Initialize in your page's DOMContentLoaded handler:

```javascript
document.addEventListener('DOMContentLoaded', function() {
    // Initialize authentication manager
    window.authManager.init();
    
    // Initialize dynamic sidebar
    window.sidebarManager.initializeSidebar(window.authManager);
});
```

### Menu Structure

The sidebar automatically includes:

#### Public Items (Always Visible)
- **eInvoicing Specification Registry** - Main registry page
- **Core Invoice Model** (Read-only) - Public specification viewing
- **Extension Component Data Model** (Read-only) - Public extension viewing

#### Protected Items (Authentication Required)
- **Governing Entities** - Entity management
- **My Specifications** - User's personal specifications
- **Add New Specification** - Create new specifications
- **Workflow Steps** (Child elements):
  - Identifying Information
  - Additional Requirements  
  - Specification Preview

#### Dynamic Authentication Item
- **Login/Logout** - Changes based on authentication state

### Role-Based Visibility

```javascript
// Example: Items with 'protected' class require authentication
<li class="protected">
    <a href="mySpecifications.html">
        <span class="icon"><i class="fa-solid fa-folder"></i></span>
        <span class="text">My Specifications</span>
    </a>
</li>
```

---

## Breadcrumb Navigation System

### How It Works

The breadcrumb system tracks user navigation context using `sessionStorage` and displays contextual navigation paths with workflow step indicators.

### Key Concepts

#### Navigation Context
The system tracks:
- **Source** - Where the user came from (`registry`, `mySpecs`)
- **Action** - What they're doing (`view`, `edit`, `new`)  
- **Current Page** - Which step in the workflow
- **Specification ID** - Which specification they're working with

#### Workflow Steps
The system recognizes these workflow pages in order:
1. **Identifying Information** (Step 1 of 5)
2. **Core Invoice Model** (Step 2 of 5)
3. **Extension Component Data Model** (Step 3 of 5) 
4. **Additional Requirements** (Step 4 of 5)
5. **Specification Preview** (Step 5 of 5)

### Implementation

#### 1. HTML Structure
Add breadcrumb container to your page:

```html
<div class="page-Content">
    <div id="breadcrumbContainer" class="breadcrumb-container">
        <!-- Breadcrumb will be dynamically generated by breadcrumbManager.js -->
    </div>
    <h1>Your Page Title</h1>
    <!-- Rest of page content -->
</div>
```

#### 2. JavaScript Integration
Initialize breadcrumbs in your page:

```javascript
document.addEventListener('DOMContentLoaded', function() {
    // Initialize breadcrumb system
    window.breadcrumbManager.init();
    
    // Set context for workflow pages
    const editingSpecId = localStorage.getItem("selectedSpecification");
    if (editingSpecId) {
        const context = {
            currentPage: 'coreInvoiceModel.html',
            specId: editingSpecId,
            action: editingSpecId === 'new' ? 'new' : 'edit'
        };
        
        // Preserve existing source context if set
        const existingContext = window.breadcrumbManager.getContext();
        if (existingContext && existingContext.source) {
            context.source = existingContext.source;
        } else {
            context.source = 'mySpecs'; // Default
        }
        
        window.breadcrumbManager.setContext(context);
    }
});
```

### Breadcrumb Examples

#### Example 1: Registry Navigation
User clicks "View" from Registry â†’ navigates to workflow:

```
Registry > View Spec (Step 1 of 5)
Registry > View Spec (Step 2 of 5)  
Registry > View Spec (Step 3 of 5)
```

#### Example 2: My Specifications Navigation  
User clicks "Edit" from My Specs â†’ navigates to workflow:

```
My Specs > Edit Spec (Step 1 of 5)
My Specs > Edit Spec (Step 2 of 5)
My Specs > Edit Spec (Step 3 of 5)
```

#### Example 3: New Specification
User creates new specification:

```  
My Specs > New Spec (Step 1 of 5)
My Specs > New Spec (Step 2 of 5)
My Specs > New Spec (Step 3 of 5)
```

### Context Setting Examples

#### Registry Page - Clear Context
```javascript
// Clear any existing workflow context on registry pages
if (window.breadcrumbManager) {
    window.breadcrumbManager.clearContext();
}
```

#### Navigation Functions - Set Source Context
```javascript
// In registryTable.js - when user clicks "View" button
function setViewContext(specId) {
    const context = {
        source: 'registry',
        action: 'view', 
        specId: specId
    };
    window.breadcrumbManager.setContext(context);
}

// In mySpecifications.html - when user clicks "Edit" button  
function editSpecification(specId) {
    const context = {
        source: 'mySpecs',
        action: 'edit',
        specId: specId
    };
    window.breadcrumbManager.setContext(context);
    localStorage.setItem("selectedSpecification", specId);
    window.location.href = 'IdentifyingInformation.html';
}
```

#### Workflow Pages - Preserve and Update Context
```javascript
// In workflow pages - preserve source, update current page
const context = {
    currentPage: 'additionalRequirements.html',
    specId: editingSpecId,
    action: editingSpecId === 'new' ? 'new' : 'edit'
};

// Preserve existing source context
const existingContext = window.breadcrumbManager.getContext();
if (existingContext && existingContext.source) {
    context.source = existingContext.source;
} else {
    context.source = 'mySpecs'; // Default fallback
}

window.breadcrumbManager.setContext(context);
```

---

## CSS Styling

### Breadcrumb Styles
The breadcrumbs use responsive CSS classes:

```css
.breadcrumb-container {
    margin-bottom: 20px;
    padding: 10px 0;
    border-bottom: 1px solid #e0e0e0;
}

.breadcrumb {
    display: flex;
    align-items: center;
    flex-wrap: wrap;
    gap: 8px;
    font-size: 14px;
    color: #666;
}

.breadcrumb-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.breadcrumb-link {
    color: #1976d2;
    text-decoration: none;
    padding: 4px 8px;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.breadcrumb-link:hover {
    background-color: #f5f5f5;
    text-decoration: underline;
}

.breadcrumb-current {
    font-weight: 500;
    color: #333;
}

.breadcrumb-separator {
    color: #999;
    font-size: 12px;
}

/* Mobile responsive */
@media (max-width: 768px) {
    .breadcrumb {
        font-size: 12px;
        gap: 4px;
    }
    
    .breadcrumb-link {
        padding: 2px 4px;
    }
}
```

---

## Unsaved Changes Detection

The breadcrumb system integrates with form state management to prevent accidental navigation:

### Implementation
```javascript
// Make form dirty state globally accessible
let isFormDirty = false;
window.isFormDirty = false;

// Update dirty state on form changes
document.querySelector('#myForm').addEventListener('change', () => {
    isFormDirty = true;
    window.isFormDirty = true;
});

// Breadcrumb navigation checks for unsaved changes
// This is handled automatically by breadcrumbManager.js
```

### User Experience
- When user clicks breadcrumb link with unsaved changes:
  - Shows confirmation dialog: "You have unsaved changes. Are you sure you want to leave?"
  - If confirmed â†’ navigates to selected page
  - If cancelled â†’ stays on current page

---

## Debug and Testing

### Debug Tools
Access debug information via:
- **Debug Link** - Available on registry page: `ðŸ”§ Debug Tools`
- **Browser Console** - Extensive logging available
- **Test Pages** - Dedicated testing interfaces

### Test Pages
The system includes comprehensive test pages:

#### Sidebar Testing
- **`test-sidebar.html`** - Interactive sidebar testing
- Tests authentication state changes
- Verifies role-based visibility
- Menu item functionality testing

#### Breadcrumb Testing  
- **`test-breadcrumbs.html`** - Basic breadcrumb functionality
- **`breadcrumb-complete-test.html`** - Complete workflow testing
- **`debug-breadcrumb.html`** - Debug interface with context manipulation

### Debug Logging
Enable detailed logging by opening browser console:

```javascript
// Example debug output
DEBUG: Breadcrumb context set: {source: "registry", action: "view", specId: "SPEC-001"}
DEBUG: Navigation source detected: registry
DEBUG: Building breadcrumb path for workflow step 2 of 5
DEBUG: User authentication state: {isAuthenticated: true, role: "user"}
```

---

## Migration Guide

### From Hardcoded to Dynamic Sidebar

#### Step 1: Update HTML
```html
<!-- Replace this -->
<div class="sidebar">
    <ul>
        <!-- hardcoded menu items -->
    </ul>  
</div>

<!-- With this -->
<div id="sidebarContainer">
    <!-- Sidebar will be dynamically generated by sidebarManager.js -->
</div>
```

#### Step 2: Add Script References
```html
<script src="../JS/sidebarManager.js"></script>
<script src="../JS/breadcrumbManager.js"></script>
```

#### Step 3: Add Initialization
```javascript
document.addEventListener('DOMContentLoaded', function() {
    window.authManager.init();
    window.sidebarManager.initializeSidebar(window.authManager);
    window.breadcrumbManager.init();
});
```

#### Step 4: Add Breadcrumb Container (Workflow Pages)
```html
<div class="page-Content">
    <div id="breadcrumbContainer" class="breadcrumb-container">
        <!-- Breadcrumb will be dynamically generated -->
    </div>
    <!-- rest of content -->
</div>
```

### Navigation Function Updates

Update navigation functions to set breadcrumb context:

```javascript
// Before
function editSpecification(specId) {
    localStorage.setItem("selectedSpecification", specId);
    window.location.href = 'IdentifyingInformation.html';
}

// After  
function editSpecification(specId) {
    // Set breadcrumb context
    const context = {
        source: 'mySpecs',
        action: 'edit',
        specId: specId
    };
    window.breadcrumbManager.setContext(context);
    
    localStorage.setItem("selectedSpecification", specId);
    window.location.href = 'IdentifyingInformation.html';
}
```

---

## API Reference

### SidebarManager

#### Methods
- `initializeSidebar(authManager)` - Initialize sidebar with auth integration
- `updateSidebar(authManager)` - Update sidebar when auth state changes
- `getCurrentUser(authManager)` - Get current user information

### BreadcrumbManager

#### Methods
- `init()` - Initialize breadcrumb system
- `setContext(context)` - Set navigation context
- `updateContext(updates)` - Update existing context
- `getContext()` - Get current context
- `clearContext()` - Clear navigation context
- `render()` - Re-render breadcrumbs

#### Context Object
```javascript
{
    source: 'registry' | 'mySpecs',
    action: 'view' | 'edit' | 'new', 
    currentPage: 'filename.html',
    specId: 'specification-id'
}
```

---

## Best Practices

### 1. Context Management
- **Always set source context** when navigating from registry/mySpecs
- **Preserve existing context** in workflow pages
- **Clear context** on registry pages to prevent stale data

### 2. Error Handling
- Check for manager availability before calling methods
- Provide fallback behavior if navigation systems fail
- Use try-catch blocks for navigation operations

### 3. Performance
- Initialize managers only once per page
- Use efficient context updates rather than full re-initialization
- Minimize breadcrumb re-renders

### 4. Accessibility
- Breadcrumbs include proper ARIA labels
- Sidebar items have semantic navigation structure
- Mobile-responsive design ensures usability across devices

---

## Troubleshooting

### Common Issues

#### Breadcrumbs Not Showing
1. Check breadcrumb container exists: `<div id="breadcrumbContainer">`
2. Verify breadcrumbManager.js is loaded
3. Ensure `init()` is called in DOMContentLoaded
4. Check browser console for errors

#### Wrong Navigation Source
1. Verify context is set before navigation
2. Check `setContext()` is called with correct source
3. Ensure context preservation logic in workflow pages

#### Sidebar Not Updating
1. Check authentication manager initialization
2. Verify `updateSidebar()` is called on auth state changes
3. Ensure sidebarManager.js is loaded

### Debug Commands
Open browser console and try:

```javascript
// Check current breadcrumb context
console.log(window.breadcrumbManager.getContext());

// Check authentication state  
console.log(window.authManager.isAuthenticated);

// Manually update breadcrumbs
window.breadcrumbManager.render();

// Test sidebar update
window.sidebarManager.updateSidebar(window.authManager);
```

---

## Future Enhancements

Potential improvements for the navigation system:

- **Keyboard Navigation** - Arrow key navigation support
- **Search Integration** - Quick navigation search
- **Favorites/Bookmarks** - User-customizable shortcuts
- **Navigation History** - Browser-like back/forward navigation
- **Progressive Web App** - Offline navigation capabilities

---

*This navigation system provides a modern, maintainable foundation for the Registry Services application with room for future enhancements and scalability.*
