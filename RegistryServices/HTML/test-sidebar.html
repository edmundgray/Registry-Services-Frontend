<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../CSS/style.css">
    
    <script src="../JS/auth/authManager.js"></script>
    <script>
        window.authManager = new AuthManager();
        function authenticatedFetch(url, options = {}) {
            const headers = { ...(options.headers || {}), ...window.authManager.getAuthHeaders() };
            return fetch(url, { ...options, headers });
        }
    </script>
    <script src="../JS/sidebarManager.js"></script>
    <script src="../JS/javascript.js"></script>
    
    <title>Sidebar Test</title>
</head>
<body>
    <div id="sidebarContainer">
        <!-- Sidebar will be dynamically generated -->
    </div>

    <div class="page-Content">
        <h1>Sidebar Test Page</h1>
        <p>This page is for testing the dynamic sidebar functionality.</p>
        
        <div id="authWarning" style="display: none; margin: 20px 0; padding: 15px; background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 5px; color: #856404;">
            <strong>⚠️ Warning:</strong> Existing authentication data detected! This might affect testing. 
            <button onclick="window.resetAuth(); document.getElementById('authWarning').style.display='none';" 
                    style="margin-left: 10px; padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">
                Clear & Reset
            </button>
        </div>
        
        <div style="margin: 20px 0; padding: 15px; background: #f0f0f0; border-radius: 5px;">
            <h3>Debug Functions:</h3>
            <button onclick="window.resetAuth()" style="margin: 5px; padding: 8px 15px; background: #dc3545; color: white; border: none; border-radius: 3px;">Reset Authentication</button>
            <button onclick="window.testLogin()" style="margin: 5px; padding: 8px 15px; background: #28a745; color: white; border: none; border-radius: 3px;">Test Login Modal</button>
            <button onclick="console.log('Auth state:', window.authManager)" style="margin: 5px; padding: 8px 15px; background: #007bff; color: white; border: none; border-radius: 3px;">Log Auth State</button>
            <button onclick="demoLogin('edmund', 'User')" style="margin: 5px; padding: 8px 15px; background: #6f42c1; color: white; border: none; border-radius: 3px;">Quick Login Edmund</button>
            <button onclick="demoLogin('admin', 'Admin')" style="margin: 5px; padding: 8px 15px; background: #fd7e14; color: white; border: none; border-radius: 3px;">Quick Login Admin</button>
        </div>
        
        <div id="debugInfo" style="margin: 20px 0; padding: 15px; background: #e8f4f8; border-radius: 5px; font-family: monospace; font-size: 12px;">
            <h4>Debug Information:</h4>
            <div id="debugOutput">Loading...</div>
        </div>
    </div>

    <script>
        // Define updateUserDisplay function for this test page
        function updateUserDisplay() {
            console.log('updateUserDisplay called on test page');
            // On this test page, we'll just update our debug info instead
            updateDebugInfo();
        }

        function updateDebugInfo() {
            const debugOutput = document.getElementById('debugOutput');
            // Use the global getCurrentUser function from javascript.js which uses the global authManager
            const currentUser = getCurrentUser();
            debugOutput.innerHTML = `
                <strong>Authentication State:</strong><br>
                - isAuthenticated: ${window.authManager.isAuthenticated}<br>
                - userRole: ${window.authManager.userRole}<br>
                - username: ${window.authManager.username}<br>
                - userID: ${window.authManager.userID}<br>
                - accessToken: ${window.authManager.accessToken ? 'Present' : 'Not present'}<br><br>
                
                <strong>LocalStorage:</strong><br>
                - userRole: ${localStorage.getItem('userRole')}<br>
                - username: ${localStorage.getItem('username')}<br>
                - access_token: ${localStorage.getItem('access_token') ? 'Present' : 'Not present'}<br><br>
                
                <strong>Current User (from getCurrentUser):</strong><br>
                - isAuthenticated: ${currentUser.isAuthenticated}<br>
                - role: ${currentUser.role}<br>
                - username: ${currentUser.username}<br>
            `;
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('Test page loaded');
            
            // Check for existing auth data and show warning
            const hasExistingAuth = localStorage.getItem('userRole') || localStorage.getItem('access_token') || localStorage.getItem('username');
            if (hasExistingAuth) {
                console.log('WARNING: Existing authentication data detected');
                document.getElementById('authWarning').style.display = 'block';
            }
            
            // Initialize auth manager
            window.authManager.init();
            
            // Initialize sidebar
            window.sidebarManager.initializeSidebar(window.authManager);
            
            // Update debug info
            updateDebugInfo();
            
            // Update debug info every 2 seconds
            setInterval(updateDebugInfo, 2000);
        });
    </script>
</body>
</html>
