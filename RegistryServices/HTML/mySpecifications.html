<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
        <link rel="stylesheet" href="../CSS/style.css">
        
        <!-- Add authManager.js for global AuthManager and AUTH_CONFIG -->
        <script src="../JS/auth/authManager.js"></script>
        <script>
            // Create a global authManager instance and enhanced authenticatedFetch
            window.authManager = new AuthManager();
            async function authenticatedFetch(url, options = {}) {
                console.log('DEBUG: authenticatedFetch called with URL:', url);
                console.log('DEBUG: AuthManager state:', {
                    isAuthenticated: window.authManager.isAuthenticated,
                    accessToken: window.authManager.accessToken ? 'Present' : 'Not present',
                    username: window.authManager.username,
                    userRole: window.authManager.userRole
                });

                try {
                    // Get fresh auth headers
                    const authHeaders = window.authManager.getAuthHeaders();
                    console.log('DEBUG: Auth headers:', authHeaders);
                    
                    const headers = { ...(options.headers || {}), ...authHeaders };
                    console.log('DEBUG: Final headers for request:', headers);
                    
                    // Make the request
                    const response = await fetch(url, { ...options, headers });
                    
                    // Check for authentication errors
                    if (response.status === 401 || response.status === 403) {
                        console.log('DEBUG: Authentication error detected - session expired');
                        
                        // Handle session expiry without popups
                        handleSessionExpiry();
                        
                        // Throw error to stop further processing
                        throw new Error('Session expired - redirecting to login');
                    }
                    
                    return response;
                } catch (error) {
                    console.error('DEBUG: authenticatedFetch error:', error);
                    throw error;
                }
            }

            // Handle session expiry with notification and redirect
            function handleSessionExpiry() {
                console.log('Session expired - handling cleanup and redirect');
                
                // Show session expired notification
                showSessionExpiredNotification();
                
                // Preserve workflow data for recovery after re-login
                preserveWorkflowData();
                
                // Clear authentication data but keep workflow data
                clearAuthenticationData();
                
                // Redirect to index.html after showing notification
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 3000);
            }

            // Show session expired notification
            function showSessionExpiredNotification() {
                // Remove any existing notifications
                const existingNotification = document.getElementById('sessionExpiredNotification');
                if (existingNotification) {
                    existingNotification.remove();
                }

                const notification = document.createElement('div');
                notification.id = 'sessionExpiredNotification';
                notification.style.cssText = `
                    position: fixed; top: 20px; right: 20px; z-index: 10000;
                    background: #f8d7da; color: #721c24; padding: 20px;
                    border-radius: 8px; border: 2px solid #f5c6cb;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    max-width: 350px; font-family: Arial, sans-serif;
                `;
                notification.innerHTML = `
                    <div style="display: flex; align-items: flex-start;">
                        <i class="fa-solid fa-exclamation-triangle" style="margin-right: 15px; font-size: 20px; margin-top: 2px;"></i>
                        <div style="flex: 1;">
                            <strong style="display: block; margin-bottom: 5px;">Session Expired</strong>
                            <p style="margin: 0; font-size: 14px; line-height: 1.4;">
                                Your session has expired. Your work has been saved and you will be redirected to the login page.
                            </p>
                            <small style="display: block; margin-top: 8px; opacity: 0.8;">
                                Redirecting in 3 seconds...
                            </small>
                        </div>
                        <button onclick="this.parentNode.parentNode.remove(); window.location.href='../index.html';" 
                                style="margin-left: 10px; background: none; border: none; font-size: 18px; cursor: pointer; color: #721c24;">
                            Ã—
                        </button>
                    </div>
                `;
                document.body.appendChild(notification);

                // Auto-remove notification after redirect
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 4000);
            }

            // Preserve workflow data for recovery after re-login
            function preserveWorkflowData() {
                try {
                    // Create a recovery object with current workflow state
                    const recoveryData = {
                        timestamp: new Date().toISOString(),
                        currentPage: window.location.pathname,
                        workflowData: {},
                        breadcrumbContext: null
                    };

                    // Preserve specification workflow data
                    if (localStorage.getItem('selectedSpecification')) {
                        recoveryData.workflowData.selectedSpecification = localStorage.getItem('selectedSpecification');
                    }

                    // Preserve any working data (numbered keys like workingData_32)
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith('workingData_')) {
                            recoveryData.workflowData[key] = localStorage.getItem(key);
                        }
                    });

                    // Preserve breadcrumb context if available
                    if (window.breadcrumbManager && typeof window.breadcrumbManager.getContext === 'function') {
                        recoveryData.breadcrumbContext = window.breadcrumbManager.getContext();
                    }

                    // Save recovery data with a special key
                    localStorage.setItem('sessionRecoveryData', JSON.stringify(recoveryData));
                    
                    console.log('DEBUG: Workflow data preserved for recovery:', recoveryData);
                } catch (error) {
                    console.error('Error preserving workflow data:', error);
                }
            }

            // Clear authentication data but preserve workflow data
            function clearAuthenticationData() {
                // Clear authentication-related items
                localStorage.removeItem('access_token');
                localStorage.removeItem('token_expiry');
                localStorage.removeItem('userId');
                localStorage.removeItem('username');
                localStorage.removeItem('userRole');
                localStorage.removeItem('userGroupID');
                localStorage.removeItem('groupName');

                console.log('DEBUG: Authentication data cleared, workflow data preserved');
            }
        </script>
        <script src="../JS/sidebarManager.js"></script>
        <script src="../JS/breadcrumbManager.js"></script>
        <script src="../JS/workflowSessionManager.js"></script>
        <script src="../JS/javascript.js"></script>
        <script src="../JS/dataManager.js"></script>
        
        <title>Registry Services</title>

        <style>
            /* Additional styles for the table */
            table {
                width: 100%;
                border-collapse: collapse;
            }
            th, td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
                font-size: 0.741rem;
            }
            th {
                background-color: #F4A261;
                font-size: 0.741rem;
                color: white;
            }
            .view-button, .edit-button {
                padding: 5px 10px;
                margin-right: 5px;
                cursor: pointer;
            }
            .view-button {
                background-color: #4CAF50; /* Green */
                color: white;
            }
        </style>
    </head>
    <body>
<!----------------------------------------------------------------------------
        Sidebar
  ------------------------------------------------------------------------------>
        <div id="sidebarContainer">
            <!-- Sidebar will be dynamically generated by sidebarManager.js -->
        </div>

<!----------------------------------------------------------------------------
        The Table
  ------------------------------------------------------------------------------>
        <div class="page-Content">
            <h1><i class="fa-solid fa-folder"></i> My Specifications</h1>
            
            <!-- User info display -->
            <div id="userInfo" style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin: 10px 0; border-left: 4px solid #2196f3;">
                <small><strong>Current User:</strong> <span id="currentUserDisplay">Loading...</span></small>
            </div>
            
            
            <br/>

            <div><button onclick="createNewSpecification();">Add New Specification</button></div>

            <br/>
<!----------------------------------------------------------------------------
        1/2 In Progress Specifications
  ------------------------------------------------------------------------------>
            <h2>In Progress</h2>
            <table id="inProgressTable">
                <!-- 1st row is for the column names -->
                <thead>
                <tr>
                    <th>Name</th>
                    <th>Purpose</th>
                    <th>Type</th>
                    <th>Sector</th>
                    <th>Country</th>
                    <th>Implementation Date</th>
                    <th>Preferred Syntax</th>
                    <th>Governing Entity</th>
                    <th>Extension Component</th>
                    <th>Conformance Level</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="draftTableBody">
                <!-- This will be populated dynamically with API data -->
                </tbody>
            </table>

            <br/><br/>
<!----------------------------------------------------------------------------
        2/2 Submitted Specifications
  ------------------------------------------------------------------------------>
            <h2>Submitted</h2>
            <table id="submittedTable">
                <!-- 1st row is for the column names -->
                <thead>
                <tr>
                    <th>Name</th>
                    <th>Purpose</th>
                    <th>Type</th>
                    <th>Sector</th>
                    <th>Country</th>
                    <th>Implementation Date</th>
                    <th>Preferred Syntax</th>
                    <th>Governing Entity</th>
                    <th>Extension Component</th>
                    <th>Conformance Level</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="submittedTableBody">
                <!-- This will be populated dynamically with API data -->
                </tbody>
            </table>

            <br/><br/>
<!----------------------------------------------------------------------------
        3/3 Other Status Specifications
  ------------------------------------------------------------------------------>
            <h2>Other</h2>
            <table id="otherTable">
                <!-- 1st row is for the column names -->
                <thead>
                <tr>
                    <th>Name</th>
                    <th>Purpose</th>
                    <th>Type</th>
                    <th>Sector</th>
                    <th>Country</th>
                    <th>Implementation Date</th>
                    <th>Preferred Syntax</th>
                    <th>Governing Entity</th>
                    <th>Extension Component</th>
                    <th>Conformance Level</th>
                    <th>Registration Status</th>
                    <th>Actions</th>
                </tr>
                </thead>
                <tbody id="otherTableBody">
                <!-- This will be populated dynamically with API data -->
                </tbody>
            </table>
        </div>
        </div>
        
<!----------------------------------------------------------------------------
        JavaScript for Specification Management
  ------------------------------------------------------------------------------>
        <script>
            // Note: Edit and Create functions are now handled by the global functions:
            // - editSpecification(identityID) - defined in javascript.js
            // - createNewSpecification() - defined in javascript.js
            // These functions use the SpecificationDataManager for proper API integration
            
            // Global variables for specification data
            let mySpecifications = [];
            let isLoadingSpecifications = false;

            // Load specifications from API
            async function loadMySpecifications() {
                if (isLoadingSpecifications) return;
                isLoadingSpecifications = true;
                
                try {
                    console.log('Loading specifications from API...');
                    
                    // Show loading indicator
                    showLoadingIndicator();
                    
                    // Determine API endpoint based on user role
                    const currentUser = getCurrentUser();
                    const isAdmin = currentUser.role === 'Admin' || currentUser.role === 'admin';
                    const endpoint = isAdmin ? '/specifications/all' : '/specifications/by-user-group';
                    const apiUrl = `${AUTH_CONFIG.baseUrl}${endpoint}`;
                    
                    console.log('DEBUG: User role:', currentUser.role);
                    console.log('DEBUG: Is Admin:', isAdmin);
                    console.log('DEBUG: API endpoint:', endpoint);
                    console.log('DEBUG: API URL being called:', apiUrl);
                    
                    const response = await authenticatedFetch(apiUrl, {
                        method: 'GET',
                        forceAuth: true
                    });

                    console.log('DEBUG: API Response status:', response.status);
                    console.log('DEBUG: API Response headers:', Object.fromEntries(response.headers.entries()));

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const apiData = await response.json();
                    console.log('DEBUG: Raw API Response:', apiData);
                    console.log('DEBUG: API Response type:', typeof apiData);
                    console.log('DEBUG: Is Array?', Array.isArray(apiData));

                    // Handle different response formats
                    mySpecifications = Array.isArray(apiData) ? apiData : (apiData.items || []);
                    console.log('DEBUG: Total specifications found:', mySpecifications.length);
                    
                    // Debug specification statuses
                    if (mySpecifications.length > 0) {
                        console.log('DEBUG: Sample specification structure:', mySpecifications[0]);
                        
                        const statusCounts = {};
                        const implementationStatusCounts = {};
                        const registrationStatusCounts = {};
                        
                        mySpecifications.forEach(spec => {
                            // Count implementation statuses
                            const implStatus = spec.implementationStatus || 'undefined';
                            implementationStatusCounts[implStatus] = (implementationStatusCounts[implStatus] || 0) + 1;
                            
                            // Count registration statuses
                            const regStatus = spec.registrationStatus || 'undefined';
                            registrationStatusCounts[regStatus] = (registrationStatusCounts[regStatus] || 0) + 1;
                            
                            // Count overall status combinations
                            const statusKey = `impl:${implStatus}, reg:${regStatus}`;
                            statusCounts[statusKey] = (statusCounts[statusKey] || 0) + 1;
                        });
                        
                        console.log('DEBUG: Implementation Status counts:', implementationStatusCounts);
                        console.log('DEBUG: Registration Status counts:', registrationStatusCounts);
                        console.log('DEBUG: Combined Status counts:', statusCounts);
                    }
                    
                    // Render the tables with real data
                    renderSpecificationTables();
                    
                    hideLoadingIndicator();
                    
                } catch (error) {
                    console.error('Error loading specifications:', error);
                    hideLoadingIndicator();
                    
                    // Show error message and clear any existing mock data
                    showErrorMessage(`Failed to load specifications from API: ${error.message}`);
                    
                    // Clear the tables to show empty state instead of mock data
                    clearTables();
                    
                    // Re-throw the error to indicate failure
                    throw error;
                }
                
                isLoadingSpecifications = false;
            }

            // Render specification tables with real data
            function renderSpecificationTables() {
                // Filter by registrationStatus only (case insensitive, exact match)
                const inProgressSpecs = mySpecifications.filter(spec => {
                    const regStatus = (spec.registrationStatus || '').toLowerCase();
                    return regStatus === 'in progress';
                });
                
                const submittedSpecs = mySpecifications.filter(spec => {
                    const regStatus = (spec.registrationStatus || '').toLowerCase();
                    return regStatus === 'submitted';
                });

                // All other specifications (including null/undefined/empty registrationStatus)
                const otherSpecs = mySpecifications.filter(spec => {
                    const regStatus = (spec.registrationStatus || '').toLowerCase();
                    return regStatus !== 'in progress' && regStatus !== 'submitted';
                });

                console.log('DEBUG: Filtered In Progress specifications:', inProgressSpecs.length);
                console.log('DEBUG: In Progress specs:', inProgressSpecs.map(s => ({
                    name: s.specificationName,
                    regStatus: s.registrationStatus,
                    identityID: s.identityID
                })));
                
                console.log('DEBUG: Filtered Submitted specifications:', submittedSpecs.length);
                console.log('DEBUG: Submitted specs:', submittedSpecs.map(s => ({
                    name: s.specificationName,
                    regStatus: s.registrationStatus,
                    identityID: s.identityID
                })));

                console.log('DEBUG: Filtered Other specifications:', otherSpecs.length);
                console.log('DEBUG: Other specs:', otherSpecs.map(s => ({
                    name: s.specificationName,
                    regStatus: s.registrationStatus,
                    identityID: s.identityID
                })));

                renderInProgressTable(inProgressSpecs);
                renderSubmittedTable(submittedSpecs);
                renderOtherTable(otherSpecs);
            }

            // Render In Progress specifications table
            function renderInProgressTable(specifications) {
                console.log('DEBUG: Rendering In Progress table with', specifications.length, 'specifications');
                
                const tableBody = document.getElementById('draftTableBody');
                if (!tableBody) {
                    console.error('Draft table body not found');
                    return;
                }

                if (specifications.length === 0) {
                    console.log('DEBUG: No In Progress specifications, showing empty message');
                    tableBody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #666;">No specifications in progress</td></tr>';
                    return;
                }

                console.log('DEBUG: Rendering', specifications.length, 'In Progress specifications to table');
                tableBody.innerHTML = specifications.map(spec => `
                    <tr>
                        <td>${spec.specificationName || 'N/A'}</td>
                        <td>${spec.purpose || 'N/A'}</td>
                        <td>${spec.specificationType || 'N/A'}</td>
                        <td>${spec.sector || 'N/A'}</td>
                        <td>${spec.country || 'N/A'}</td>
                        <td>${formatDate(spec.dateOfImplementation)}</td>
                        <td>${spec.preferredSyntax || 'N/A'}</td>
                        <td>${spec.governingEntity || 'N/A'}</td>
                        <td>${hasExtensionComponents(spec) ? 'Yes' : 'No'}</td>
                        <td>${spec.conformanceLevel || 'N/A'}</td>
                        <td>
                            <button type="button" onclick="editSpecification(${spec.identityID})" class="view-button">Edit</button>
                        </td>
                    </tr>
                `).join('');
                
                console.log('DEBUG: In Progress table HTML updated');
            }

            // Render Submitted specifications table
            function renderSubmittedTable(specifications) {
                console.log('DEBUG: Rendering Submitted table with', specifications.length, 'specifications');
                
                const tableBody = document.getElementById('submittedTableBody');
                if (!tableBody) {
                    console.error('Submitted table body not found');
                    return;
                }

                if (specifications.length === 0) {
                    console.log('DEBUG: No Submitted specifications, showing empty message');
                    tableBody.innerHTML = '<tr><td colspan="11" style="text-align: center; color: #666;">No submitted specifications</td></tr>';
                    return;
                }

                console.log('DEBUG: Rendering', specifications.length, 'Submitted specifications to table');
                tableBody.innerHTML = specifications.map(spec => `
                    <tr>
                        <td>${spec.specificationName || 'N/A'}</td>
                        <td>${spec.purpose || 'N/A'}</td>
                        <td>${spec.specificationType || 'N/A'}</td>
                        <td>${spec.sector || 'N/A'}</td>
                        <td>${spec.country || 'N/A'}</td>
                        <td>${formatDate(spec.dateOfImplementation)}</td>
                        <td>${spec.preferredSyntax || 'N/A'}</td>
                        <td>${spec.governingEntity || 'N/A'}</td>
                        <td>${hasExtensionComponents(spec) ? 'Yes' : 'No'}</td>
                        <td>${spec.conformanceLevel || 'N/A'}</td>
                        <td>
                            <button type="button" onclick="viewSpecification(${spec.identityID})" class="view-button">View</button>
                        </td>
                    </tr>
                `).join('');
                
                console.log('DEBUG: Submitted table HTML updated');
            }

            // Render Other status specifications table
            function renderOtherTable(specifications) {
                console.log('DEBUG: Rendering Other table with', specifications.length, 'specifications');
                
                const tableBody = document.getElementById('otherTableBody');
                if (!tableBody) {
                    console.error('Other table body not found');
                    return;
                }

                if (specifications.length === 0) {
                    console.log('DEBUG: No Other specifications, showing empty message');
                    tableBody.innerHTML = '<tr><td colspan="12" style="text-align: center; color: #666;">No other specifications</td></tr>';
                    return;
                }

                console.log('DEBUG: Rendering', specifications.length, 'Other specifications to table');
                tableBody.innerHTML = specifications.map(spec => {
                    // Determine action button based on registration status
                    let actionButton = '';
                    const regStatus = (spec.registrationStatus || '').toLowerCase();
                    
                    if (regStatus === 'under review') {
                        actionButton = `<button type="button" onclick="editSpecification(${spec.identityID})" class="view-button">Edit</button>`;
                    } else if (regStatus === 'verified') {
                        actionButton = `<button type="button" onclick="viewSpecification(${spec.identityID})" class="view-button">View</button>`;
                    } else {
                        // Fallback for all other statuses (including null/undefined/empty)
                        actionButton = `<button type="button" onclick="viewSpecification(${spec.identityID})" class="view-button">View</button>`;
                    }
                    
                    return `
                        <tr>
                            <td>${spec.specificationName || 'N/A'}</td>
                            <td>${spec.purpose || 'N/A'}</td>
                            <td>${spec.specificationType || 'N/A'}</td>
                            <td>${spec.sector || 'N/A'}</td>
                            <td>${spec.country || 'N/A'}</td>
                            <td>${formatDate(spec.dateOfImplementation)}</td>
                            <td>${spec.preferredSyntax || 'N/A'}</td>
                            <td>${spec.governingEntity || 'N/A'}</td>
                            <td>${hasExtensionComponents(spec) ? 'Yes' : 'No'}</td>
                            <td>${spec.conformanceLevel || 'N/A'}</td>
                            <td>${spec.registrationStatus || 'N/A'}</td>
                            <td>${actionButton}</td>
                        </tr>
                    `;
                }).join('');
                
                console.log('DEBUG: Other table HTML updated with conditional action buttons');
            }

            // Utility functions
            function formatDate(dateString) {
                if (!dateString) return 'N/A';
                try {
                    const date = new Date(dateString);
                    return date.toLocaleDateString();
                } catch (e) {
                    return 'N/A';
                }
            }

            function hasExtensionComponents(spec) {
                // Handle new direct array format (no longer wrapped in { items: [...] })
                return spec.specificationExtensionComponents && 
                       Array.isArray(spec.specificationExtensionComponents) &&
                       spec.specificationExtensionComponents.length > 0;
            }

            function viewSpecification(identityID) {
                console.log('Viewing specification with ID:', identityID);
                
                if (!identityID) {
                    console.error('No identityID provided for viewing specification');
                    alert('Error: No specification ID provided');
                    return;
                }
                
                // Store the specification ID for the view page
                localStorage.setItem('viewSpecificationId', identityID);
                
                // Navigate to the view specification page with the ID as a URL parameter
                const viewUrl = `viewSpecification.html?id=${identityID}`;
                console.log('DEBUG: Navigating to view page:', viewUrl);
                
                window.location.href = viewUrl;
            }

            // Loading and error display functions
            function showLoadingIndicator() {
                const pageContent = document.querySelector('.page-Content');
                let loadingDiv = document.getElementById('loadingIndicator');
                
                if (!loadingDiv) {
                    loadingDiv = document.createElement('div');
                    loadingDiv.id = 'loadingIndicator';
                    loadingDiv.innerHTML = `
                        <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.9); margin: 20px 0; border-radius: 5px;">
                            <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px; color: #007bff;"></i>
                            <p style="margin-top: 10px;">Loading your specifications...</p>
                        </div>
                    `;
                    pageContent.appendChild(loadingDiv);
                }
            }

            function hideLoadingIndicator() {
                const loadingDiv = document.getElementById('loadingIndicator');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
            }

            function showErrorMessage(message) {
                const pageContent = document.querySelector('.page-Content');
                let errorDiv = document.getElementById('errorMessage');
                
                if (!errorDiv) {
                    errorDiv = document.createElement('div');
                    errorDiv.id = 'errorMessage';
                    errorDiv.style.cssText = 'background: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin: 20px 0; border: 2px solid #f5c6cb; font-weight: bold;';
                    pageContent.appendChild(errorDiv);
                }
                
                errorDiv.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div style="display: flex; align-items: center;">
                            <i class="fa-solid fa-exclamation-triangle" style="margin-right: 10px; font-size: 18px;"></i>
                            <div>
                                <strong>Error:</strong> ${message}
                                <br><small>Please check your connection and try refreshing the page, or contact support if the issue persists.</small>
                            </div>
                        </div>
                        <div>
                            <button onclick="retryLoadSpecifications()" style="padding: 8px 15px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; margin-left: 15px;">
                                <i class="fa-solid fa-refresh"></i> Retry
                            </button>
                        </div>
                    </div>
                `;
                
                // Don't auto-hide error messages - user should acknowledge them
            }

            // Function to retry loading specifications
            function retryLoadSpecifications() {
                console.log('Retrying to load specifications...');
                
                // Clear the error message
                const errorDiv = document.getElementById('errorMessage');
                if (errorDiv) {
                    errorDiv.remove();
                }
                
                // Reset loading state and try again
                isLoadingSpecifications = false;
                mySpecifications = [];
                
                if (typeof loggedInStatus !== 'undefined' && loggedInStatus) {
                    loadMySpecifications().catch(error => {
                        console.error('Retry failed:', error);
                        // Error handling is already done in loadMySpecifications
                    });
                } else {
                    showErrorMessage('Please log in to view your specifications.');
                }
            }

            // Function to update user display
            function updateUserDisplay() {
                const userInfoElement = document.getElementById('currentUserDisplay');
                if (!userInfoElement) return;
                
                const currentUser = getCurrentUser();
                
                if (currentUser.isAuthenticated) {
                    const displayName = currentUser.username || 'Unknown User';
                    const role = currentUser.role || 'User';
                    const groupInfo = currentUser.userGroupID ? ` | Group: ${currentUser.groupName || currentUser.userGroupID}` : '';
                    userInfoElement.innerHTML = `${displayName} (${role})${groupInfo}`;
                    console.log('DEBUG: User display updated:', { 
                        displayName, 
                        role, 
                        userGroupID: currentUser.userGroupID,
                        groupName: currentUser.groupName,
                        fullUserData: currentUser
                    });
                } else {
                    userInfoElement.innerHTML = 'Not logged in';
                    console.log('DEBUG: User not authenticated');
                }
            }

            // Clear tables when API fails
            function clearTables() {
                const draftTableBody = document.getElementById('draftTableBody');
                const submittedTableBody = document.getElementById('submittedTableBody');
                const otherTableBody = document.getElementById('otherTableBody');
                
                if (draftTableBody) {
                    draftTableBody.innerHTML = '';
                }
                
                if (submittedTableBody) {
                    submittedTableBody.innerHTML = '';
                }

                if (otherTableBody) {
                    otherTableBody.innerHTML = '';
                }
            }

            // Legacy function - kept for backward compatibility if needed
            function autofillSpecification(specName) {
                console.warn('autofillSpecification is deprecated. Use editSpecification(identityID) instead.');
                localStorage.setItem("selectedSpecification", specName);
                localStorage.setItem("returnToPage", "mySpecifications.html"); // Set return page
                
                // Set breadcrumb context for new specification workflow
                if (window.breadcrumbManager) {
                    const context = {
                        source: 'mySpecs',
                        action: 'new',
                        currentPage: 'IdentifyingInformation.html',
                        specId: 'new'
                    };
                    window.breadcrumbManager.setContext(context);
                }
                
                window.location.href = "IdentifyingInformation.html";
            }

            // Initialize when page loads
            document.addEventListener('DOMContentLoaded', function() {
                console.log('MySpecifications page loaded, fetching data...');
                
                // Initialize authentication manager
                window.authManager.init();
                
                // Check for and recover workflow data from previous session
                checkForWorkflowRecovery();
                
                // Initialize session management for this page
                if (typeof WorkflowSessionManager !== 'undefined' && window.workflowSessionManager) {
                    window.workflowSessionManager.init('general-navigation');
                    console.log('DEBUG: Session management initialized for mySpecifications page');
                }
                
                // Initialize dynamic sidebar
                window.sidebarManager.initializeSidebar(window.authManager);
                
                // Initialize breadcrumb system (clear any existing context on this page)
                if (window.breadcrumbManager) {
                    window.breadcrumbManager.clearContext();
                }
                
                // Debug: Show current user information
                const currentUser = getCurrentUser();
                console.log('DEBUG: Current user info:', currentUser);
                console.log('DEBUG: Auth manager state:', {
                    isAuthenticated: window.authManager.isAuthenticated,
                    userRole: window.authManager.userRole,
                    username: window.authManager.username,
                    userID: window.authManager.userID,
                    accessToken: window.authManager.accessToken ? 'Present' : 'Not present'
                });
                
                // Update user display
                updateUserDisplay();
                
                // Check if user is logged in before loading data
                if (typeof loggedInStatus !== 'undefined' && loggedInStatus) {
                    loadMySpecifications().catch(error => {
                        console.error('Failed to load specifications on page load:', error);
                        // Error handling is already done in loadMySpecifications
                    });
                } else {
                    console.log('User not logged in, showing login message');
                    // If user is not logged in, clear tables and show login message
                    clearTables();
                    showErrorMessage('Please log in to view your specifications.');
                }
            });

            // Check for workflow recovery data from previous session
            function checkForWorkflowRecovery() {
                try {
                    const recoveryDataStr = localStorage.getItem('sessionRecoveryData');
                    if (!recoveryDataStr) {
                        return; // No recovery data available
                    }

                    const recoveryData = JSON.parse(recoveryDataStr);
                    const recoveryAge = new Date() - new Date(recoveryData.timestamp);
                    const maxRecoveryAge = 24 * 60 * 60 * 1000; // 24 hours

                    // Only recover if data is less than 24 hours old
                    if (recoveryAge > maxRecoveryAge) {
                        console.log('DEBUG: Recovery data too old, clearing');
                        localStorage.removeItem('sessionRecoveryData');
                        return;
                    }

                    // Check if user is authenticated to show recovery options
                    if (window.authManager && window.authManager.isAuthenticated) {
                        showWorkflowRecoveryNotification(recoveryData);
                    } else {
                        console.log('DEBUG: User not authenticated, keeping recovery data for later');
                    }

                } catch (error) {
                    console.error('Error checking workflow recovery:', error);
                    localStorage.removeItem('sessionRecoveryData'); // Clear corrupted data
                }
            }

            // Show workflow recovery notification
            function showWorkflowRecoveryNotification(recoveryData) {
                // Don't show if no meaningful workflow data
                if (!recoveryData.workflowData || Object.keys(recoveryData.workflowData).length === 0) {
                    localStorage.removeItem('sessionRecoveryData');
                    return;
                }

                const notification = document.createElement('div');
                notification.id = 'workflowRecoveryNotification';
                notification.style.cssText = `
                    position: fixed; top: 20px; right: 20px; z-index: 10000;
                    background: #d1ecf1; color: #0c5460; padding: 20px;
                    border-radius: 8px; border: 2px solid #bee5eb;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    max-width: 400px; font-family: Arial, sans-serif;
                `;
                
                const workflowKeys = Object.keys(recoveryData.workflowData);
                const hasSpecification = recoveryData.workflowData.selectedSpecification;
                const workingDataCount = workflowKeys.filter(k => k.startsWith('workingData_')).length;

                notification.innerHTML = `
                    <div style="display: flex; align-items: flex-start;">
                        <i class="fa-solid fa-info-circle" style="margin-right: 15px; font-size: 20px; margin-top: 2px;"></i>
                        <div style="flex: 1;">
                            <strong style="display: block; margin-bottom: 8px;">Workflow Recovery Available</strong>
                            <p style="margin: 0 0 10px 0; font-size: 14px; line-height: 1.4;">
                                Your previous work session was preserved:
                            </p>
                            <ul style="margin: 0 0 15px 0; padding-left: 20px; font-size: 13px;">
                                ${hasSpecification ? `<li>Selected specification: ${recoveryData.workflowData.selectedSpecification}</li>` : ''}
                                ${workingDataCount > 0 ? `<li>Working data from ${workingDataCount} form(s)</li>` : ''}
                                <li>Session from: ${new Date(recoveryData.timestamp).toLocaleString()}</li>
                            </ul>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="restoreWorkflowData()" 
                                        style="padding: 8px 12px; background: #0c5460; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    Restore Work
                                </button>
                                <button onclick="discardRecoveryData()" 
                                        style="padding: 8px 12px; background: #6c757d; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px;">
                                    Start Fresh
                                </button>
                            </div>
                        </div>
                        <button onclick="this.parentNode.parentNode.remove();" 
                                style="margin-left: 10px; background: none; border: none; font-size: 18px; cursor: pointer; color: #0c5460;">
                            Ã—
                        </button>
                    </div>
                `;
                document.body.appendChild(notification);

                // Auto-remove after 30 seconds if no action taken
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 30000);
            }

            // Restore workflow data from recovery
            function restoreWorkflowData() {
                try {
                    const recoveryDataStr = localStorage.getItem('sessionRecoveryData');
                    if (!recoveryDataStr) return;

                    const recoveryData = JSON.parse(recoveryDataStr);
                    
                    // Restore workflow data
                    Object.keys(recoveryData.workflowData).forEach(key => {
                        localStorage.setItem(key, recoveryData.workflowData[key]);
                    });

                    // Restore breadcrumb context if available
                    if (recoveryData.breadcrumbContext && window.breadcrumbManager && typeof window.breadcrumbManager.setContext === 'function') {
                        window.breadcrumbManager.setContext(recoveryData.breadcrumbContext);
                    }

                    // Remove recovery notification
                    const notification = document.getElementById('workflowRecoveryNotification');
                    if (notification) notification.remove();

                    // Clear recovery data
                    localStorage.removeItem('sessionRecoveryData');

                    // Show success message
                    showRecoverySuccessMessage();

                    console.log('DEBUG: Workflow data restored successfully');
                } catch (error) {
                    console.error('Error restoring workflow data:', error);
                }
            }

            // Discard recovery data and start fresh
            function discardRecoveryData() {
                localStorage.removeItem('sessionRecoveryData');
                const notification = document.getElementById('workflowRecoveryNotification');
                if (notification) notification.remove();
                console.log('DEBUG: Recovery data discarded');
            }

            // Show recovery success message
            function showRecoverySuccessMessage() {
                const successMsg = document.createElement('div');
                successMsg.style.cssText = `
                    position: fixed; top: 20px; right: 20px; z-index: 10000;
                    background: #d4edda; color: #155724; padding: 15px;
                    border-radius: 5px; border: 2px solid #c3e6cb;
                    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
                `;
                successMsg.innerHTML = `
                    <i class="fa-solid fa-check-circle" style="margin-right: 10px;"></i>
                    <strong>Work Restored Successfully</strong>
                `;
                document.body.appendChild(successMsg);

                setTimeout(() => {
                    if (successMsg.parentNode) {
                        successMsg.parentNode.removeChild(successMsg);
                    }
                }, 3000);
            }

            // Make recovery functions globally accessible
            window.restoreWorkflowData = restoreWorkflowData;
            window.discardRecoveryData = discardRecoveryData;

            // Refresh specifications when user logs in
            if (typeof updateVisibility === 'function') {
                const originalUpdateVisibility = updateVisibility;
                updateVisibility = function() {
                    originalUpdateVisibility();
                    
                    // Update sidebar whenever visibility changes
                    window.sidebarManager.updateSidebar(window.authManager);
                    
                    // Update user display whenever visibility changes
                    updateUserDisplay();
                    
                    // If user just logged in, load specifications
                    if (loggedInStatus && mySpecifications.length === 0 && !isLoadingSpecifications) {
                        // Clear any existing error messages
                        const errorDiv = document.getElementById('errorMessage');
                        if (errorDiv) {
                            errorDiv.remove();
                        }
                        
                        console.log('DEBUG: User logged in, triggering specification load');
                        setTimeout(() => {
                            loadMySpecifications().catch(error => {
                                console.error('Failed to load specifications after login:', error);
                                // Error handling is already done in loadMySpecifications
                            });
                        }, 100); // Small delay to ensure auth state is fully updated
                    } else if (!loggedInStatus) {
                        // User logged out, clear data and show login message
                        mySpecifications = [];
                        clearTables();
                        showErrorMessage('Please log in to view your specifications.');
                    }
                };
            }
            
            // Function to manually trigger specification reload after login
            function reloadSpecificationsAfterLogin() {
                console.log('DEBUG: Manual reload triggered after login');
                console.log('DEBUG: Auth manager state at reload:', {
                    isAuthenticated: window.authManager.isAuthenticated,
                    accessToken: window.authManager.accessToken ? 'Present' : 'Not present',
                    username: window.authManager.username,
                    role: window.authManager.userRole
                });
                
                if (window.authManager.isAuthenticated && window.authManager.accessToken) {
                    // Clear any existing error messages
                    const errorDiv = document.getElementById('errorMessage');
                    if (errorDiv) {
                        errorDiv.remove();
                    }
                    
                    // Reset specifications and reload
                    mySpecifications = [];
                    isLoadingSpecifications = false;
                    
                    loadMySpecifications().catch(error => {
                        console.error('Failed to reload specifications:', error);
                    });
                } else {
                    console.warn('Cannot reload specifications - user not properly authenticated');
                }
            }
            
            // Make the reload function globally accessible
            window.reloadSpecificationsAfterLogin = reloadSpecificationsAfterLogin;
        </script>
    </body>
</html>