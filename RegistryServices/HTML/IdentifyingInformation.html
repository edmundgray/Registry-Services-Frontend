<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
        <link rel="stylesheet" href="../CSS/style.css">
        
        <!-- Add authManager.js for global AuthManager and AUTH_CONFIG -->
        <script src="../JS/auth/authManager.js"></script>
        <script>
            // Create a global authManager instance and enhanced authenticatedFetch
            window.authManager = new AuthManager();
            
            async function authenticatedFetch(url, options = {}) {
                console.log('DEBUG: authenticatedFetch called with URL:', url);
                console.log('DEBUG: AuthManager state:', {
                    isAuthenticated: window.authManager.isAuthenticated,
                    accessToken: window.authManager.accessToken ? 'Present' : 'Not present',
                    username: window.authManager.username,
                    userRole: window.authManager.userRole
                });

                try {
                    // Get fresh auth headers
                    const authHeaders = window.authManager.getAuthHeaders();
                    console.log('DEBUG: Auth headers:', authHeaders);
                    
                    const headers = { ...(options.headers || {}), ...authHeaders };
                    console.log('DEBUG: Final headers for request:', headers);
                    
                    // Make the request
                    const response = await fetch(url, { ...options, headers });
                    
                    // Check for authentication errors
                    if (response.status === 401 || response.status === 403) {
                        console.log('DEBUG: Authentication error detected - session expired');
                        
                        // Handle session expiry without popups
                        handleSessionExpiry();
                        
                        // Throw error to stop further processing
                        throw new Error('Session expired - redirecting to login');
                    }
                    
                    return response;
                } catch (error) {
                    console.error('DEBUG: authenticatedFetch error:', error);
                    throw error;
                }
            }

            // Handle session expiry with notification and redirect
            function handleSessionExpiry() {
                console.log('Session expired - handling cleanup and redirect');
                
                // Show session expired notification
                showSessionExpiredNotification();
                
                // Preserve workflow data for recovery after re-login
                preserveWorkflowData();
                
                // Clear authentication data but keep workflow data
                clearAuthenticationData();
                
                // Redirect to index.html after showing notification
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 3000);
            }

            // Show session expired notification
            function showSessionExpiredNotification() {
                // Remove any existing notifications
                const existingNotification = document.getElementById('sessionExpiredNotification');
                if (existingNotification) {
                    existingNotification.remove();
                }

                const notification = document.createElement('div');
                notification.id = 'sessionExpiredNotification';
                notification.style.cssText = `
                    position: fixed; top: 20px; right: 20px; z-index: 10000;
                    background: #f8d7da; color: #721c24; padding: 20px;
                    border-radius: 8px; border: 2px solid #f5c6cb;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    max-width: 350px; font-family: Arial, sans-serif;
                `;
                notification.innerHTML = `
                    <div style="display: flex; align-items: flex-start;">
                        <i class="fa-solid fa-exclamation-triangle" style="margin-right: 15px; font-size: 20px; margin-top: 2px;"></i>
                        <div style="flex: 1;">
                            <strong style="display: block; margin-bottom: 5px;">Session Expired</strong>
                            <p style="margin: 0; font-size: 14px; line-height: 1.4;">
                                Your session has expired. Your work has been saved and you will be redirected to the login page.
                            </p>
                            <small style="display: block; margin-top: 8px; opacity: 0.8;">
                                Redirecting in 3 seconds...
                            </small>
                        </div>
                        <button onclick="this.parentNode.parentNode.remove(); window.location.href='../index.html';" 
                                style="margin-left: 10px; background: none; border: none; font-size: 18px; cursor: pointer; color: #721c24;">
                            ×
                        </button>
                    </div>
                `;
                document.body.appendChild(notification);

                // Auto-remove notification after redirect
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 4000);
            }

            // Preserve workflow data for recovery after re-login
            function preserveWorkflowData() {
                try {
                    // Create a recovery object with current workflow state
                    const recoveryData = {
                        timestamp: new Date().toISOString(),
                        currentPage: window.location.pathname,
                        workflowData: {},
                        breadcrumbContext: null
                    };

                    // Preserve specification workflow data
                    if (localStorage.getItem('selectedSpecification')) {
                        recoveryData.workflowData.selectedSpecification = localStorage.getItem('selectedSpecification');
                    }

                    // Preserve any working data (numbered keys like workingData_32)
                    Object.keys(localStorage).forEach(key => {
                        if (key.startsWith('workingData_')) {
                            recoveryData.workflowData[key] = localStorage.getItem(key);
                        }
                    });

                    // Preserve breadcrumb context if available
                    if (window.breadcrumbManager && typeof window.breadcrumbManager.getContext === 'function') {
                        recoveryData.breadcrumbContext = window.breadcrumbManager.getContext();
                    }

                    // Save recovery data with a special key
                    localStorage.setItem('sessionRecoveryData', JSON.stringify(recoveryData));
                    
                    console.log('DEBUG: Workflow data preserved for recovery:', recoveryData);
                } catch (error) {
                    console.error('Error preserving workflow data:', error);
                }
            }

            // Clear authentication data but preserve workflow data
            function clearAuthenticationData() {
                // Clear authentication-related items
                localStorage.removeItem('access_token');
                localStorage.removeItem('token_expiry');
                localStorage.removeItem('userId');
                localStorage.removeItem('username');
                localStorage.removeItem('userRole');
                localStorage.removeItem('userGroupID');
                localStorage.removeItem('groupName');

                console.log('DEBUG: Authentication data cleared, workflow data preserved');
            }
        </script>
        <script src="../JS/sidebarManager.js"></script>
        <script src="../JS/breadcrumbManager.js"></script>
        <script src="../JS/javascript.js"></script>
        <script src="../JS/identifyingInformation.js"></script>
        <script src="../JS/dataManager.js"></script>
        <script src="../JS/workflowSessionManager.js"></script>
        
        <title>Registry Services</title>

        <style>
            .info-row input[type="text"],
            .info-row input[type="url"],
            .info-row input[type="date"],
            .info-row select {
                width: 100%;
                max-width: 240px;
                min-width: 90px;
                box-sizing: border-box;
                padding: 4.5px;
                font-size: 0.75rem;
            }
            .info-row input[readonly] {
                background-color: #f5f5f5 !important;
                color: #666 !important;
                cursor: not-allowed;
                border: 1px solid #ddd;
            }
            .info-row label 
            {
                font-size: 0.741rem;
            }
            .info-table > div 
            {
                padding: 12.35px 9.5px 4.75px 9.5px !important;
                margin-bottom: 13.3px !important;
            }
            .info-table h3 
            {
                font-size: 0.8rem;
                margin-bottom: 7.5px;
            }
            .info-row 
            {
                margin-bottom: 7.6px;
            }
            .view-button 
            {
                padding: 4.75px 12.35px !important;
                font-size: 0.741rem !important;
            }
            .page-Content 
            {
                padding: 9.5px 1.52vw 1.52vw 1.52vw !important;
            }
            #contactInfo 
            {
                max-width: 240px;
                width: 100%;
                box-sizing: border-box;
                font-size: 0.75rem;
                padding: 4.5px;
            }
            #purpose 
            {
                max-width: 240px;
                width: 100%;
                box-sizing: border-box;
                font-size: 0.75rem;
                padding: 4.5px;
            }
            @media (max-width: 600px) 
            {
                .info-table 
                {
                    max-width: 100% !important;
                    padding: 0 2px;
                }
                .info-row input,
                .info-row select 
                {
                    max-width: 100%;
                    min-width: 0;
                    font-size: 0.76rem;
                }
                .page-Content 
                {
                    padding: 0 0.76vw;
                }
            }
        </style>
    </head>
    <body>
        <div id="sidebarContainer">
            <!-- Sidebar will be dynamically generated by sidebarManager.js -->
        </div>

        <div class="page-Content">
            <div id="breadcrumbContainer" class="breadcrumb-container">
                <!-- Breadcrumb will be dynamically generated by breadcrumbManager.js -->
            </div>
            <h1><i class="fa-solid fa-info"></i> Identifying Information</h1>

            <p style="margin: 10px 0 20px 0;">
                Use the inputs below to begin the process of adding Identifying Information and supporting artefacts to your Specification.<br>
                <span style="color: #d9534f;">*Minimum information required</span>
            </p>

<!----------------------------------------------------------------------------
        (1/2) The Form
        General Information
  ------------------------------------------------------------------------------>            
            <form id="identifyingForm" class="info-table" style="max-width: 600px; margin-left: 0;">
                <div style="background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 24px 24px 10px 24px; margin-bottom: 30px;">
                    <h3>General Information</h3>
                    
                    <!-- Specification Name (Required) -->
                    <div class="info-row">
                        <label for="specName">*Specification name:
                            <span class="semantic-tooltip" title="Enter the official name of the specification.">?</span>
                        </label>
                        <input type="text" id="specName" name="specName" required>
                    </div>
                    
                    <!-- Governing Entity (Read-only - derived from User Group) -->
                    <div class="info-row">
                        <label for="governingEntity">Governing Entity:
                            <span class="semantic-tooltip" title="Organization or authority responsible for the specification (derived from your user group).">?</span>
                        </label>
                        <input type="text" id="governingEntity" name="governingEntity" readonly>
                    </div>
                    
                    <!-- Contact Info (Required) -->
                    <div class="info-row">
                        <label for="contactInfo">*Contact Information:
                            <span class="semantic-tooltip" title="Provide an email or phone number for contact.">?</span>
                        </label>
                        <textarea id="contactInfo" name="contactInfo" rows="2" required></textarea>
                    </div>

                   <!-- Sector (Required) --> 
                    <div class="info-row">
                        <label for="sector">*Sector:
                            <span class="semantic-tooltip" title="Select the sector from the NACE list.">?</span>
                        </label>
                        <select id="sector" name="sector" required>
                            <option value="">Select Sector</option>
                            <option value="any">Any Sector</option>
                            <option>Agriculture, Forestry & Fishing</option>
                            <option>Mining & Quarrying</option>
                            <option>Manufacturing</option>
                            <option>Electricity & Gas</option>
                            <option>Water Supply & Waste Management</option>
                            <option>Construction</option>
                            <option>Wholesale & Retail Trade</option>
                            <option>Transportation & Storage</option>
                            <option>Accommodation & Food Services</option>
                            <option>Information & Communication</option>
                            <option>Financial & Insurance Activities</option>
                            <option>Real Estate Activities</option>
                            <option>Professional & Technical Activities</option>
                            <option>Administrative & Support Services</option>
                            <option>Public Administration & Defense</option>
                            <option>Education</option>
                            <option>Human Health & Social Work Activities</option>
                            <option>Arts, Entertainment & Recreation</option>
                            <option>Other Service Activities</option>
                            <option>Activities of Households as Employers</option>
                        </select>
                    </div>
                    
                    <!-- Sub Sector (Not Required) -->
                    <div class="info-row">
                        <label for="subSector">Sub Sector:
                            <span class="semantic-tooltip" title="Specify a more detailed sector if applicable.">?</span>
                        </label>
                        <input type="text" id="subSector" name="subSector">
                    </div>
                    
                    <!-- Country (Required) -->
                    <div class="info-row">
                        <label for="country">*Country:
                            <span class="semantic-tooltip" title="Select the country using the official EC country codes.">?</span>
                        </label>
                        <select id="country" name="country" required>
                            <option value="">Select Country</option>
                            <option value="any">Any Country</option>
                            <option value="DE">Germany (DE)</option>
                            <option value="NL">Netherlands (NL)</option>
                            <option value="BE">Belgium (BE)</option>
                            <option value="IE">Ireland (IE)</option>
                            <option value="FR">France (FR)</option>
                            <option value="SE">Sweden (SE)</option>
                            <option value="FI">Finland (FI)</option>
                            <option value="UK">United Kingdom (UK)</option>
                            <option value="US">United States (US)</option>
                            <option value="AU">Australia (AU)</option>
                            <option value="IN">India (IN)</option>
                            <option value="CA">Canada (CA)</option>
                        </select>
                    </div>
                    
                    <!-- Purpose (Required) -->
                    <div class="info-row">
                        <label for="purpose">*Purpose:
                            <span class="semantic-tooltip" title="Describe the main purpose of the specification.">?</span>
                        </label>
                        <textarea id="purpose" name="purpose" rows="3" required></textarea>
                    </div>
                </div>
<!----------------------------------------------------------------------------
        (2/2) The Form
        Technical Information
  ------------------------------------------------------------------------------>   
                <div style="background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 24px 24px 10px 24px;">
                    <h3 style="margin-top:0;">Technical Information</h3>
                    
                    <!-- Specification Identifier (Required) -->
                    <div class="info-row">
                        <label for="specId">*Specification Identifier:
                            <span class="semantic-tooltip" title="A unique identifier for this specification (e.g., internal code or reference).">?</span>
                        </label>
                        <input type="text" id="specId" name="specId" required>
                    </div>
                    
                    <!-- Specification Version (Not Required) -->
                    <div class="info-row">
                        <label for="specVersion">Specification Version:
                            <span class="semantic-tooltip" title="Version number or label for this specification.">?</span>
                        </label>
                        <input type="text" id="specVersion" name="specVersion">
                    </div>
                    
                    <!-- Date of Implementation (Not Required) -->
                    <div class="info-row">
                        <label for="implDate">Date of Implementation:
                            <span class="semantic-tooltip" title="Date when this specification is planned to be or was implemented.">?</span>
                        </label>
                        <input type="date" id="implDate" name="implDate">
                    </div>
                    
                    <!-- Core Version (Not Required) -->
                    <div class="info-row">
                        <label for="coreVersion">Core Version:
                            <span class="semantic-tooltip" title="Select the version of the core invoice model this specification is based on.">?</span>
                        </label>
                        <select id="coreVersion" name="coreVersion">
                            <option value="">Select Version</option>
                            <option>1.0</option>
                            <option>2.0</option>
                            <option>3.0</option>
                        </select>
                    </div>
                    
                    <!-- Underlying Specification (Not Required) -->
                    <div class="info-row">
                        <label for="underlyingSpec">Underlying Specification:
                            <span class="semantic-tooltip" title="Reference to any underlying or base specification this builds on.">?</span>
                        </label>
                        <input type="text" id="underlyingSpec" name="underlyingSpec">
                    </div>
                    
                    <!-- Specification Source Link (Not Required) -->
                    <div class="info-row">
                        <label for="sourceLink">Specification Source Link:
                            <span class="semantic-tooltip" title="A URL to the official source or documentation for this specification.">?</span>
                        </label>
                        <input type="url" id="sourceLink" name="sourceLink">
                    </div>
                    
                    <!-- Preferred Syntax (Not Required) -->
                    <div class="info-row">
                        <label for="preferredSyntax">Preferred Syntax:
                            <span class="semantic-tooltip" title="Select the preferred syntax for this specification (e.g., UBL, EDIFACT, JSON).">?</span>
                        </label>
                        
                        <select id="preferredSyntax" name="preferredSyntax">
                            <option value="">Select Syntax</option>
                            <option>UBL</option>
                            <option>EDIFACT</option>
                            <option>JSON</option>
                        </select>
                    </div>
                </div>
                
                <!-- Save, Cancel & Core Invoice Model Buttons -->
                <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 30px;">
                    <div>
                        <button type="button" onclick="handleSave()" class="view-button">Save</button>
                        <button type="button" onclick="handleCancel()" class="view-button" style="background:#ccc; color:#333;">Cancel</button>
                    </div>
                    
                    <div>
                        <button type="button" onclick="saveAndGoToCoreInvoiceModel()" class="view-button" style="background:#217a36;">Core Invoice Model</button>
                    </div>
                </div>
            </form>
        </div>

<!----------------------------------------------------------------------------
        JavaScript for mockup functionality
  ------------------------------------------------------------------------------>
        <script>
            // Note: isFormDirty is deprecated in favor of hasActualChanges()
            // let isFormDirty = false;
            let dataManager = null;

            // Initialize data manager and load data
            async function initializeDataManager() {
                try {
                    console.log('DEBUG: IdentifyingInformation - Starting initializeDataManager');
                    console.log('DEBUG: IdentifyingInformation - LocalStorage state:');
                    console.log('  - editMode:', localStorage.getItem('editMode'));
                    console.log('  - specificationIdentityId:', localStorage.getItem('specificationIdentityId'));
                    
                    // Ensure AuthManager is properly initialized with userGroupID
                    window.authManager.init();
                    const currentUser = getCurrentUser();
                    console.log('DEBUG: IdentifyingInformation - Current user after re-init:', currentUser);
                    
                    dataManager = new SpecificationDataManager();
                    console.log('DEBUG: IdentifyingInformation - Data manager initialized');
                    console.log('DEBUG: IdentifyingInformation - Mode:', dataManager.currentMode);
                    console.log('DEBUG: IdentifyingInformation - CurrentSpecId:', dataManager.currentSpecId);
                    console.log('DEBUG: IdentifyingInformation - isEditMode():', dataManager.isEditMode());
                    
                    if (dataManager.isEditMode() && dataManager.currentSpecId) {
                        console.log('DEBUG: IdentifyingInformation - Loading specification for editing. ID:', dataManager.currentSpecId);
                        
                        // Show loading indicator
                        showLoadingIndicator();
                        
                        // Load data from API
                        const formData = await dataManager.loadSpecificationFromAPI(dataManager.currentSpecId);
                        console.log('DEBUG: IdentifyingInformation - Form data loaded:', formData);
                        
                        // Populate form with loaded data
                        populateForm(formData);
                        
                        // Hide loading indicator
                        hideLoadingIndicator();
                        
                        console.log('DEBUG: IdentifyingInformation - Form populated with existing data');
                        // Note: No need to set isFormDirty anymore since we use hasActualChanges()
                    } else {
                        console.log('DEBUG: IdentifyingInformation - Creating new specification or missing spec ID');
                        console.log('DEBUG: IdentifyingInformation - isEditMode:', dataManager.isEditMode());
                        console.log('DEBUG: IdentifyingInformation - currentSpecId:', dataManager.currentSpecId);
                        
                        // For new specifications, check if there's any working data
                        const workingData = dataManager.loadWorkingDataFromLocalStorage();
                        if (workingData) {
                            console.log('DEBUG: IdentifyingInformation - Found working data, populating form');
                            populateForm(workingData);
                            // Note: No need to set isFormDirty anymore since we use hasActualChanges()
                        } else {
                            console.log('DEBUG: IdentifyingInformation - No working data found, initializing with defaults');
                            // Initialize with empty data but populate governing entity
                            const emptyData = {
                                specName: '',
                                contactInfo: '',
                                sector: '',
                                subSector: '',
                                country: '',
                                purpose: '',
                                specId: '',
                                specVersion: '',
                                implDate: '',
                                coreVersion: '',
                                underlyingSpec: '',
                                sourceLink: '',
                                preferredSyntax: ''
                            };
                            populateForm(emptyData); // This will auto-populate governing entity
                            // Note: No need to set isFormDirty anymore since we use hasActualChanges()
                        }
                    }
                } catch (error) {
                    console.error('DEBUG: IdentifyingInformation - Error initializing data manager:', error);
                    hideLoadingIndicator();
                    alert(`Error loading specification: ${error.message}`);
                }
            }

            function showLoadingIndicator() {
                const form = document.getElementById('identifyingForm');
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loadingIndicator';
                loadingDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.9); 
                         position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 1000;">
                        <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px; color: #007bff;"></i>
                        <p style="margin-top: 10px;">Loading specification data...</p>
                    </div>
                `;
                loadingDiv.style.position = 'relative';
                form.style.position = 'relative';
                form.appendChild(loadingDiv);
            }

            function hideLoadingIndicator() {
                const loadingDiv = document.getElementById('loadingIndicator');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
            }

            function populateForm(data) {
                console.log('DEBUG: populateForm called with data:', data);
                
                const form = document.getElementById('identifyingForm');
                if (!form) {
                    console.error('DEBUG: populateForm - Form element not found!');
                    return;
                }
                
                // Get current user for governing entity population
                const currentUser = getCurrentUser();
                
                // Determine governing entity
                let governingEntity = '';
                if (dataManager && dataManager.isEditMode()) {
                    // For edit mode, use the data from API
                    governingEntity = data.governingEntity || '';
                    console.log('DEBUG: populateForm - Edit mode, using API governing entity:', governingEntity);
                } else {
                    // For create mode, use current user's group name
                    governingEntity = currentUser.groupName || 
                                     localStorage.getItem('groupName') || 
                                     window.authManager?.groupName || 
                                     '';
                    console.log('DEBUG: populateForm - Create mode, using user group name as governing entity:', governingEntity);
                    console.log('DEBUG: populateForm - Group name sources:', {
                        fromCurrentUser: currentUser.groupName,
                        fromLocalStorage: localStorage.getItem('groupName'),
                        fromAuthManager: window.authManager?.groupName,
                        finalChoice: governingEntity
                    });
                }
                
                // Populate all form fields
                const fieldMappings = {
                    specName: data.specName,
                    governingEntity: governingEntity,
                    contactInfo: data.contactInfo,
                    sector: data.sector,
                    subSector: data.subSector,
                    country: data.country,
                    purpose: data.purpose,
                    specId: data.specId,
                    specVersion: data.specVersion,
                    implDate: data.implDate,
                    coreVersion: data.coreVersion,
                    underlyingSpec: data.underlyingSpec,
                    sourceLink: data.sourceLink,
                    preferredSyntax: data.preferredSyntax
                };

                console.log('DEBUG: populateForm - Field mappings:', fieldMappings);
                
                Object.keys(fieldMappings).forEach(fieldName => {
                    const field = form.elements[fieldName];
                    if (field && fieldMappings[fieldName] !== undefined) {
                        const oldValue = field.value;
                        field.value = fieldMappings[fieldName] || '';
                        console.log(`DEBUG: populateForm - Set ${fieldName}: "${oldValue}" -> "${field.value}"`);
                    } else if (!field) {
                        console.warn(`DEBUG: populateForm - Field "${fieldName}" not found in form`);
                    }
                });

                console.log('DEBUG: populateForm - Form populated successfully');
            }

            function getFormData() {
                const form = document.getElementById('identifyingForm');
                return {
                    specName: form.specName.value,
                    governingEntity: form.governingEntity.value,
                    contactInfo: form.contactInfo.value,
                    sector: form.sector.value,
                    subSector: form.subSector.value,
                    country: form.country.value,
                    purpose: form.purpose.value,
                    specId: form.specId.value,
                    specVersion: form.specVersion.value,
                    implDate: form.implDate.value,
                    coreVersion: form.coreVersion.value,
                    underlyingSpec: form.underlyingSpec.value,
                    sourceLink: form.sourceLink.value,
                    preferredSyntax: form.preferredSyntax.value
                };
            }

            // Enhanced change detection functions with comprehensive debugging
            function hasActualChanges() {
                console.log('DEBUG: IdentifyingInformation - hasActualChanges() called');
                
                try {
                    if (!dataManager || !dataManager.workingData) {
                        console.log('DEBUG: IdentifyingInformation - No baseline data (dataManager.workingData), checking if form has content');
                        const currentData = getFormData();
                        const hasContent = Object.values(currentData).some(value => value && value.trim() !== '');
                        console.log('DEBUG: IdentifyingInformation - Form has content without baseline:', hasContent);
                        return hasContent; // If no baseline data, check if form has any content
                    }
                    
                    const currentData = getFormData();
                    const originalData = dataManager.workingData;
                    
                    console.log('DEBUG: IdentifyingInformation - Comparing data:', {
                        current: currentData,
                        baseline: originalData
                    });
                    
                    // Field-by-field comparison with detailed logging
                    const fields = Object.keys(currentData);
                    for (const field of fields) {
                        const currentValue = currentData[field] || '';
                        const baselineValue = originalData[field] || '';
                        
                        if (currentValue !== baselineValue) {
                            console.log(`DEBUG: IdentifyingInformation - Change detected in ${field}:`, {
                                baseline: baselineValue,
                                current: currentValue
                            });
                            return true;
                        }
                    }
                    
                    console.log('DEBUG: IdentifyingInformation - No changes detected');
                    return false;
                } catch (error) {
                    console.error('DEBUG: IdentifyingInformation - Error in hasActualChanges():', error);
                    return false;
                }
            }

            // Make hasActualChanges globally accessible for breadcrumb manager
            window.hasActualChanges = hasActualChanges;

            function getChangedFields() {
                console.log('DEBUG: IdentifyingInformation - getChangedFields() called');
                
                try {
                    if (!dataManager || !dataManager.workingData) {
                        console.log('DEBUG: IdentifyingInformation - No baseline data for getChangedFields()');
                        return [];
                    }
                    
                    const currentData = getFormData();
                    const originalData = dataManager.workingData;
                    const changedFields = [];
                    
                    Object.keys(currentData).forEach(field => {
                        const currentValue = currentData[field] || '';
                        const baselineValue = originalData[field] || '';
                        
                        if (currentValue !== baselineValue) {
                            changedFields.push({
                                field: field,
                                displayName: getFieldDisplayName(field),
                                oldValue: baselineValue,
                                newValue: currentValue
                            });
                        }
                    });
                    
                    console.log('DEBUG: IdentifyingInformation - Changed fields detected:', changedFields);
                    return changedFields;
                } catch (error) {
                    console.error('DEBUG: IdentifyingInformation - Error in getChangedFields():', error);
                    return [];
                }
            }

            function getFieldDisplayName(fieldName) {
                const displayNames = {
                    specName: 'Specification Name',
                    governingEntity: 'Governing Entity',
                    contactInfo: 'Contact Information',
                    sector: 'Sector',
                    subSector: 'Sub Sector',
                    country: 'Country',
                    purpose: 'Purpose',
                    specId: 'Specification Identifier',
                    specVersion: 'Specification Version',
                    implDate: 'Date of Implementation',
                    coreVersion: 'Core Version',
                    underlyingSpec: 'Underlying Specification',
                    sourceLink: 'Specification Source Link',
                    preferredSyntax: 'Preferred Syntax'
                };
                return displayNames[fieldName] || fieldName;
            }

            function showChangeConfirmationModal(changedFields, onConfirm, onCancel) {
                // Create modal HTML
                const modalHtml = `
                    <div id="changeConfirmModal" style="
                        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                        background: rgba(0,0,0,0.5); z-index: 1002; display: flex;
                        align-items: center; justify-content: center;">
                        <div style="
                            background: white; border-radius: 8px; padding: 24px; max-width: 500px;
                            width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                            <h3 style="margin: 0 0 16px 0; color: #333;">
                                <i class="fa-solid fa-save" style="color: #28a745; margin-right: 8px;"></i>
                                Confirm Save Changes
                            </h3>
                            <p style="margin: 0 0 16px 0; color: #666;">
                                You have modified <strong>${changedFields.length}</strong> field${changedFields.length !== 1 ? 's' : ''}. 
                                Do you want to save these changes?
                            </p>
                            <div style="max-height: 200px; overflow-y: auto; background: #f8f9fa; 
                                 border-radius: 4px; padding: 12px; margin: 16px 0;">
                                ${changedFields.map(change => `
                                    <div style="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e9ecef;">
                                        <strong style="color: #495057;">${change.displayName}</strong><br>
                                        <small style="color: #6c757d;">
                                            From: <span style="background: #f8d7da; padding: 2px 4px; border-radius: 2px;">${change.oldValue || '(empty)'}</span><br>
                                            To: <span style="background: #d4edda; padding: 2px 4px; border-radius: 2px;">${change.newValue || '(empty)'}</span>
                                        </small>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                                <button onclick="cancelSaveChanges()" style="
                                    padding: 8px 16px; background: #6c757d; color: white; border: none;
                                    border-radius: 4px; cursor: pointer; font-size: 14px;">
                                    Cancel
                                </button>
                                <button onclick="confirmSaveChanges()" style="
                                    padding: 8px 16px; background: #28a745; color: white, border: none;
                                    border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">
                                    <i class="fa-solid fa-save" style="margin-right: 4px;"></i>
                                    Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to page
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Store callbacks
                window.confirmSaveChanges = () => {
                    document.getElementById('changeConfirmModal').remove();
                    onConfirm();
                };
                
                window.cancelSaveChanges = () => {
                    document.getElementById('changeConfirmModal').remove();
                    if (onCancel) onCancel();
                };
            }

            function updateSaveButtonAppearance() {
                try {
                    const saveButton = document.querySelector('button[onclick="handleSave()"]');
                    const hasChanges = hasActualChanges();
                    
                    console.log('DEBUG: IdentifyingInformation - updateSaveButtonAppearance called, hasChanges:', hasChanges);
                    
                    if (saveButton) {
                        if (hasChanges) {
                            saveButton.style.background = '#28a745'; // Green when changes exist
                            saveButton.style.fontWeight = 'bold';
                            saveButton.style.boxShadow = '0 2px 4px rgba(40, 167, 69, 0.3)';
                        } else {
                            saveButton.style.background = '#6c757d'; // Gray when no changes
                            saveButton.style.fontWeight = 'normal';
                            saveButton.style.boxShadow = 'none';
                        }
                    }
                } catch (error) {
                    console.error('DEBUG: IdentifyingInformation - Error in updateSaveButtonAppearance():', error);
                }
            }

            async function handleSave() {
                const form = document.getElementById('identifyingForm');
                if (!form.reportValidity()) return;

                // Check if there are actual changes
                const changedFields = getChangedFields();
                
                if (changedFields.length === 0) {
                    // Show "no changes" modal
                    const modalHtml = `
                        <div id="noChangesModal" style="
                            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                            background: rgba(0,0,0,0.5); z-index: 1002; display: flex;
                            align-items: center; justify-content: center;">
                            <div style="
                                background: white; border-radius: 8px; padding: 24px; max-width: 400px;
                                width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                                <h3 style="margin: 0 0 16px 0; color: #333;">
                                    <i class="fa-solid fa-info-circle" style="color: #17a2b8; margin-right: 8px;"></i>
                                    No Changes Detected
                                </h3>
                                <p style="margin: 0 0 20px 0; color: #666;">
                                    There are no unsaved changes to save. The form data matches the last saved version.
                                </p>
                                <div style="text-align: center;">
                                    <button onclick="document.getElementById('noChangesModal').remove()" style="
                                        padding: 8px 16px; background: #17a2b8; color: white; border: none;
                                        border-radius: 4px; cursor: pointer; font-size: 14px;">
                                        OK
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    return;
                }                // Show confirmation modal with change details
                showChangeConfirmationModal(changedFields, async () => {
                    try {
                        const formData = getFormData();
                        
                        // Show saving indicator
                        const saveButton = document.querySelector('button[onclick="handleSave()"]');
                        const originalText = saveButton.textContent;
                        saveButton.textContent = 'Saving...';
                        saveButton.disabled = true;

                        // Save to API
                        const result = await dataManager.saveSpecificationToAPI(formData);
                        
                        // Update working data baseline
                        dataManager.workingData = dataManager.transformApiToFormData(result);
                        dataManager.saveWorkingDataToLocalStorage();
                        console.log('DEBUG: IdentifyingInformation - Baseline updated after save:', dataManager.workingData);
                        
                        // Success feedback
                        alert(`Specification ${dataManager.isEditMode() ? 'updated' : 'created'} successfully!`);
                        updateSaveButtonAppearance();

                        // Restore button
                        saveButton.textContent = originalText;
                        saveButton.disabled = false;

                    } catch (error) {
                        console.error('Error saving specification:', error);
                        
                        // Provide more user-friendly error messages
                        let errorMessage = 'Error saving specification: ';
                        if (error.message.includes('Failed to fetch')) {
                            errorMessage += 'Unable to connect to the server. Please check your internet connection and try again.';
                        } else if (error.message.includes('HTTP error! status: 401')) {
                            errorMessage += 'Authentication failed. Please log in again.';
                        } else if (error.message.includes('HTTP error! status: 403')) {
                            errorMessage += 'You don\'t have permission to perform this action.';
                        } else if (error.message.includes('HTTP error! status: 500')) {
                            errorMessage += 'Server error. Please try again later or contact support.';
                        } else if (error.message.includes('Unexpected end of JSON input')) {
                            errorMessage += 'Server returned an invalid response. The data may have been saved successfully. Please refresh the page to check.';
                        } else {
                            errorMessage += error.message;
                        }
                        
                        alert(errorMessage);
                        
                        // Restore button
                        const saveButton = document.querySelector('button[onclick="handleSave()"]');
                        saveButton.textContent = 'Save';
                        saveButton.disabled = false;
                    }
                });
            }

            async function saveAndGoToCoreInvoiceModel() {
                const form = document.getElementById('identifyingForm');
                
                // Validate form before proceeding
                if (!form.reportValidity()) {
                    alert("Please fill in all required fields before proceeding to Core Invoice Model.");
                    return;
                }

                // Check if there are actual changes
                const hasChanges = hasActualChanges();
                
                if (!hasChanges) {
                    // No changes detected, just navigate
                    window.location.href = 'coreInvoiceModel.html';
                    return;
                }

                // Get button reference and original text outside the try block
                const button = document.querySelector('button[onclick="saveAndGoToCoreInvoiceModel()"]');
                const originalText = button ? button.textContent : 'Core Invoice Model';

                try {
                    const formData = getFormData();
                    
                    // Show saving indicator
                    if (button) {
                        button.textContent = 'Saving...';
                        button.disabled = true;
                    }

                    // Save to API first
                    const result = await dataManager.saveSpecificationToAPI(formData);
                    
                    // Update working data baseline
                    dataManager.workingData = dataManager.transformApiToFormData(result);
                    dataManager.saveWorkingDataToLocalStorage();
                    console.log('DEBUG: IdentifyingInformation - Baseline updated after save and navigate:', dataManager.workingData);
                    
                    // Navigate to Core Invoice Model
                    window.location.href = 'coreInvoiceModel.html';

                } catch (error) {
                    console.error('Error saving specification:', error);
                    
                    // Provide more user-friendly error messages
                    let errorMessage = 'Error saving specification: ';
                    if (error.message.includes('Failed to fetch')) {
                        errorMessage += 'Unable to connect to the server. Please check your internet connection and try again.';
                    } else if (error.message.includes('HTTP error! status: 401')) {
                        errorMessage += 'Authentication failed. Please log in again.';
                    } else if (error.message.includes('HTTP error! status: 403')) {
                        errorMessage += 'You don\'t have permission to perform this action.';
                    } else if (error.message.includes('HTTP error! status: 500')) {
                        errorMessage += 'Server error. Please try again later or contact support.';
                    } else if (error.message.includes('Unexpected end of JSON input')) {
                        errorMessage += 'Server returned an invalid response. The data may have been saved successfully. Please refresh the page to check.';
                    } else {
                        errorMessage += error.message;
                    }
                    
                    alert(errorMessage);
                    
                    // Restore button
                    if (button) {
                        button.textContent = originalText;
                        button.disabled = false;
                    }
                }
            }

            function handleCancel() {
                if (hasActualChanges() && !confirm("You have unsaved changes. Are you sure you want to cancel?")) {
                    return;
                }
                
                // Clear editing state
                if (dataManager) {
                    dataManager.clearEditingState();
                }
                
                // Smart navigation: return to calling page or default to mySpecifications.html
                let targetPage = 'mySpecifications.html'; // Default fallback
                
                try {
                    // 1. Check if there's a stored return page in localStorage
                    const storedReturnPage = localStorage.getItem('returnToPage');
                    console.log('handleCancel: Stored return page:', storedReturnPage);
                    
                    if (storedReturnPage) {
                        targetPage = storedReturnPage;
                        localStorage.removeItem('returnToPage'); // Clean up after use
                        console.log('handleCancel: Using stored return page:', targetPage);
                    }
                    // 2. Otherwise, try to use document.referrer
                    else if (document.referrer) {
                        console.log('handleCancel: Document referrer:', document.referrer);
                        const referrerUrl = new URL(document.referrer);
                        const referrerPage = referrerUrl.pathname.split('/').pop();
                        console.log('handleCancel: Extracted referrer page:', referrerPage);
                        
                        // Only navigate back to valid registry pages, avoid loops
                        const validPages = [
                            'mySpecifications.html', 
                            'eInvoicingSpecificationRegistry.html',
                            'viewSpecification.html',
                            'specificationPreview.html'
                        ];
                        
                        if (validPages.includes(referrerPage) && referrerPage !== 'IdentifyingInformation.html') {
                            targetPage = referrerPage;
                            console.log('handleCancel: Using valid referrer page:', targetPage);
                        } else {
                            console.log('handleCancel: Referrer page not valid or is self, using default');
                        }
                    } else {
                        console.log('handleCancel: No referrer available, using default');
                    }
                    
                    console.log('handleCancel: Final target page:', targetPage);
                    window.location.href = targetPage;
                    
                } catch (error) {
                    console.warn('handleCancel: Error determining return page, using default:', error);
                    window.location.href = 'mySpecifications.html';
                }
            }

            // Form change tracking
            document.addEventListener('DOMContentLoaded', () => {
                const form = document.getElementById('identifyingForm');
                const elements = form.querySelectorAll('input, textarea, select');

                elements.forEach(element => {
                    element.addEventListener('change', () => {
                        // Note: Don't set isFormDirty anymore - rely on hasActualChanges()
                        updateSaveButtonAppearance(); // Update save button appearance when form changes
                    });
                });

                // Initialize data manager after DOM is ready
                initializeDataManager().then(() => {
                    // Update button appearance after data is loaded with small delay for DOM stability
                    setTimeout(() => {
                        updateSaveButtonAppearance();
                        console.log('DEBUG: IdentifyingInformation - Initial save button appearance updated after data load');
                    }, 100);
                });
            });

            // Prevent accidental navigation
            window.addEventListener('beforeunload', function (e) {
                if (hasActualChanges()) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });

            // Add navigation protection for sidebar links
            document.addEventListener('DOMContentLoaded', function() {
                document.querySelectorAll('.sidebar a').forEach(link => {
                    link.addEventListener('click', (e) => {
                        if (hasActualChanges() && !link.href.includes('IdentifyingInformation.html')) {
                            if (!confirm('You have unsaved changes. Are you sure you want to leave this page?')) {
                                e.preventDefault();
                            }
                        }
                    });
                });
            });
        </script>
        
        <script>
            // Proactive token refresh for long workflow process
            async function checkAndRefreshForWorkflow() {
                console.log('DEBUG: checkAndRefreshForWorkflow - Starting workflow token check');
                
                if (!window.authManager || !window.authManager.tokenExpiryTime) {
                    console.log('DEBUG: checkAndRefreshForWorkflow - No token or auth manager available for workflow refresh check');
                    return;
                }
                
                const timeToExpiry = window.authManager.tokenExpiryTime - Date.now();
                const thirtyMinutesMs = 30 * 60 * 1000; // 30 minutes in milliseconds
                const minutesRemaining = Math.ceil(timeToExpiry / (60 * 1000));
                
                console.log('DEBUG: checkAndRefreshForWorkflow - Token expires in', minutesRemaining, 'minutes');
                console.log('DEBUG: checkAndRefreshForWorkflow - 30-minute threshold check:', timeToExpiry < thirtyMinutesMs);
                
                if (timeToExpiry < thirtyMinutesMs) {
                    console.log('DEBUG: checkAndRefreshForWorkflow - Token expires in less than 30 minutes, refreshing for workflow...');
                    
                    try {
                        const success = await window.authManager.attemptBackgroundRefresh();
                        if (success) {
                            console.log('DEBUG: checkAndRefreshForWorkflow - Token successfully refreshed for extended workflow');
                            
                            // Show brief success notification
                            showWorkflowRefreshNotification('Session refreshed for extended workflow', 'success');
                            
                        } else {
                            console.warn('DEBUG: checkAndRefreshForWorkflow - Token refresh failed - workflow may be interrupted');
                            
                            // Show warning notification
                            showWorkflowRefreshNotification('Session refresh failed - workflow may be interrupted', 'warning');
                        }
                    } catch (error) {
                        console.error('DEBUG: checkAndRefreshForWorkflow - Error refreshing token for workflow:', error);
                        
                        // Show error notification
                        showWorkflowRefreshNotification('Session refresh error - please save your work frequently', 'error');
                    }
                } else {
                    console.log('DEBUG: checkAndRefreshForWorkflow - Token has sufficient time remaining for workflow (', minutesRemaining, 'minutes)');
                }
            }

            // Show brief notification for workflow token refresh
            function showWorkflowRefreshNotification(message, type = 'success') {
                console.log('DEBUG: showWorkflowRefreshNotification -', type + ':', message);
                
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed; top: 60px; right: 20px; z-index: 1001;
                    padding: 12px 16px; border-radius: 5px; font-size: 14px;
                    box-shadow: 0 2px 10px rgba(0,0,0,0.2);
                    max-width: 350px; word-wrap: break-word;
                `;
                
                // Set colors based on type
                switch (type) {
                    case 'success':
                        notification.style.background = '#d4edda';
                        notification.style.color = '#155724';
                        notification.style.border = '1px solid #c3e6cb';
                        notification.innerHTML = `<i class="fa-solid fa-check-circle"></i> ${message}`;
                        break;
                    case 'warning':
                        notification.style.background = '#fff3cd';
                        notification.style.color = '#856404';
                        notification.style.border = '1px solid #ffeaa7';
                        notification.innerHTML = `<i class="fa-solid fa-exclamation-triangle"></i> ${message}`;
                        break;
                    case 'error':
                        notification.style.background = '#f8d7da';
                        notification.style.color = '#721c24';
                        notification.style.border = '1px solid #f5c6cb';
                        notification.innerHTML = `<i class="fa-solid fa-exclamation-circle"></i> ${message}`;
                        break;
                }
                
                document.body.appendChild(notification);
                
                // Auto-remove after 4 seconds
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 4000);
            }

            // Initialize the sidebar and authentication when the page loads
            document.addEventListener('DOMContentLoaded', function() {
                // Wait a brief moment to ensure all DOM elements are ready
                setTimeout(() => {
                    try {
                        // Initialize auth manager
                        window.authManager.init();
                        
                        // ⭐ NEW: Check and refresh token for long workflow (30-minute threshold)
                        checkAndRefreshForWorkflow();
                        
                        // Initialize session manager for this workflow step
                        if (window.workflowSessionManager) {
                            console.log('DEBUG: Initializing workflow session manager');
                            window.workflowSessionManager.init('specification-creation');
                        } else {
                            console.error('DEBUG: workflowSessionManager not available!');
                        }
                        
                        // Initialize sidebar
                        window.sidebarManager.initializeSidebar(window.authManager);                        
                        // Initialize breadcrumb system
                        window.breadcrumbManager.init();
                        
                        // Check if there's already a breadcrumb context set (from navigation)
                        const existingContext = window.breadcrumbManager.getContext();
                        
                        if (existingContext && existingContext.timestamp && (Date.now() - existingContext.timestamp) < 5000) {
                            // Recent context exists (set within last 5 seconds), preserve it but update the current page
                            console.log('DEBUG: Preserving existing breadcrumb context from navigation');
                            existingContext.currentPage = 'IdentifyingInformation.html';
                            window.breadcrumbManager.updateContext(existingContext);
                        } else {
                            // No recent context, set new context for this page (new specification workflow)
                            console.log('DEBUG: Setting new breadcrumb context for identifying information');
                            const context = {
                                currentPage: 'IdentifyingInformation.html',
                                action: 'new', // Default to new when no existing context
                                source: 'mySpecs' // Default source
                            };
                            
                            // Determine source from referrer if no existing context
                            const referrer = document.referrer;
                            if (referrer.includes('eInvoicingSpecificationRegistry.html')) {
                                context.source = 'registry';
                            } else if (referrer.includes('mySpecifications.html')) {
                                context.source = 'mySpecs';
                            }
                            
                            window.breadcrumbManager.setContext(context);
                        }
                        
                    } catch (error) {
                        console.error('DEBUG: Error during page initialization:', error);
                        // Continue with basic functionality even if some components fail
                    }
                }, 50); // Wait 50ms for DOM to be fully ready
            });
        </script>
    </body>
</html>