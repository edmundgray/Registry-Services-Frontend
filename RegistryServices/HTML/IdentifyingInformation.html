<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <link rel="stylesheet" href="../CSS/style.css">
        
        <!-- Add authManager.js for global AuthManager and AUTH_CONFIG -->
        <script src="../JS/auth/authManager.js"></script>
        <script>
            // Create a global authManager instance and authenticatedFetch
            window.authManager = new AuthManager();
            function authenticatedFetch(url, options = {}) {
                const headers = { ...(options.headers || {}), ...window.authManager.getAuthHeaders() };
                return fetch(url, { ...options, headers });
            }
        </script>
        <script src="../JS/sidebarManager.js"></script>
        <script src="../JS/javascript.js"></script>
        <script src="../JS/identifyingInformation.js"></script>
        <script src="../JS/dataManager.js"></script>
        
        <title>Registry Services</title>

        <style>
            .info-row input[type="text"],
            .info-row input[type="url"],
            .info-row input[type="date"],
            .info-row select {
                width: 100%;
                max-width: 240px;
                min-width: 90px;
                box-sizing: border-box;
                padding: 4.5px;
                font-size: 0.75rem;
            }
            .info-row label 
            {
                font-size: 0.741rem;
            }
            .info-table > div 
            {
                padding: 12.35px 9.5px 4.75px 9.5px !important;
                margin-bottom: 13.3px !important;
            }
            .info-table h3 
            {
                font-size: 0.8rem;
                margin-bottom: 7.5px;
            }
            .info-row 
            {
                margin-bottom: 7.6px;
            }
            .view-button 
            {
                padding: 4.75px 12.35px !important;
                font-size: 0.741rem !important;
            }
            .page-Content 
            {
                padding: 9.5px 1.52vw 1.52vw 1.52vw !important;
            }
            #contactInfo 
            {
                max-width: 240px;
                width: 100%;
                box-sizing: border-box;
                font-size: 0.75rem;
                padding: 4.5px;
            }
            #purpose 
            {
                max-width: 240px;
                width: 100%;
                box-sizing: border-box;
                font-size: 0.75rem;
                padding: 4.5px;
            }
            @media (max-width: 600px) 
            {
                .info-table 
                {
                    max-width: 100% !important;
                    padding: 0 2px;
                }
                .info-row input,
                .info-row select 
                {
                    max-width: 100%;
                    min-width: 0;
                    font-size: 0.76rem;
                }
                .page-Content 
                {
                    padding: 0 0.76vw;
                }
            }
        </style>
    </head>
    <body>
        <div id="sidebarContainer">
            <!-- Sidebar will be dynamically generated by sidebarManager.js -->
        </div>

        <div class="page-Content">
            <h1><i class="fa-solid fa-info"></i> Identifying Information</h1>

            <p style="margin: 10px 0 20px 0;">
                Use the inputs below to begin the process of adding Identifying Information and supporting artefacts to your Specification.<br>
                <span style="color: #d9534f;">*Minimum information required</span>
            </p>

<!----------------------------------------------------------------------------
        (1/2) The Form
        General Information
  ------------------------------------------------------------------------------>            
            <form id="identifyingForm" class="info-table" style="max-width: 600px; margin-left: 0;">
                <div style="background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 24px 24px 10px 24px; margin-bottom: 30px;">
                    <h3>General Information</h3>
                    
                    <!-- Specification Name (Required) -->
                    <div class="info-row">
                        <label for="specName">*Specification name:
                            <span class="semantic-tooltip" title="Enter the official name of the specification.">?</span>
                        </label>
                        <input type="text" id="specName" name="specName" required>
                    </div>
                    
                    <!-- Governing Entity (Required) -->
                    <div class="info-row">
                        <label for="governingEntity">Governing Entity:
                            <span class="semantic-tooltip" title="Organization or authority responsible for the specification.">?</span>
                        </label>
                        <input type="text" id="governingEntity" name="governingEntity">
                    </div>
                    
                    <!-- Contact Info (Required) -->
                    <div class="info-row">
                        <label for="contactInfo">*Contact Information:
                            <span class="semantic-tooltip" title="Provide an email or phone number for contact.">?</span>
                        </label>
                        <textarea id="contactInfo" name="contactInfo" rows="2" required></textarea>
                    </div>

                   <!-- Sector (Required) --> 
                    <div class="info-row">
                        <label for="sector">*Sector:
                            <span class="semantic-tooltip" title="Select the sector from the NACE list.">?</span>
                        </label>
                        <select id="sector" name="sector" required>
                            <option value="">Select Sector</option>
                            <option>Agriculture, Forestry & Fishing</option>
                            <option>Mining & Quarrying</option>
                            <option>Manufacturing</option>
                            <option>Electricity & Gas</option>
                            <option>Water Supply & Waste Management</option>
                            <option>Construction</option>
                            <option>Wholesale & Retail Trade</option>
                            <option>Transportation & Storage</option>
                            <option>Accommodation & Food Services</option>
                            <option>Information & Communication</option>
                            <option>Financial & Insurance Activities</option>
                            <option>Real Estate Activities</option>
                            <option>Professional & Technical Activities</option>
                            <option>Administrative & Support Services</option>
                            <option>Public Administration & Defense</option>
                            <option>Education</option>
                            <option>Human Health & Social Work Activities</option>
                            <option>Arts, Entertainment & Recreation</option>
                            <option>Other Service Activities</option>
                            <option>Activities of Households as Employers</option>
                        </select>
                    </div>
                    
                    <!-- Sub Sector (Not Required) -->
                    <div class="info-row">
                        <label for="subSector">Sub Sector:
                            <span class="semantic-tooltip" title="Specify a more detailed sector if applicable.">?</span>
                        </label>
                        <input type="text" id="subSector" name="subSector">
                    </div>
                    
                    <!-- Country (Required) -->
                    <div class="info-row">
                        <label for="country">*Country:
                            <span class="semantic-tooltip" title="Select the country using the official EC country codes.">?</span>
                        </label>
                        <select id="country" name="country" required>
                            <option value="">Select Country</option>
                            <option value="DE">Germany (DE)</option>
                            <option value="NL">Netherlands (NL)</option>
                            <option value="BE">Belgium (BE)</option>
                            <option value="IE">Ireland (IE)</option>
                            <option value="FR">France (FR)</option>
                            <option value="SE">Sweden (SE)</option>
                            <option value="FI">Finland (FI)</option>
                            <option value="UK">United Kingdom (UK)</option>
                            <option value="US">United States (US)</option>
                            <option value="AU">Australia (AU)</option>
                            <option value="IN">India (IN)</option>
                            <option value="CA">Canada (CA)</option>
                        </select>
                    </div>
                    
                    <!-- Purpose (Required) -->
                    <div class="info-row">
                        <label for="purpose">*Purpose:
                            <span class="semantic-tooltip" title="Describe the main purpose of the specification.">?</span>
                        </label>
                        <textarea id="purpose" name="purpose" rows="3" required></textarea>
                    </div>
                </div>
<!----------------------------------------------------------------------------
        (2/2) The Form
        Technical Information
  ------------------------------------------------------------------------------>   
                <div style="background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 24px 24px 10px 24px;">
                    <h3 style="margin-top:0;">Technical Information</h3>
                    
                    <!-- Specification Identifier (Required) -->
                    <div class="info-row">
                        <label for="specId">*Specification Identifier:
                            <span class="semantic-tooltip" title="A unique identifier for this specification (e.g., internal code or reference).">?</span>
                        </label>
                        <input type="text" id="specId" name="specId" required>
                    </div>
                    
                    <!-- Specification Version (Not Required) -->
                    <div class="info-row">
                        <label for="specVersion">Specification Version:
                            <span class="semantic-tooltip" title="Version number or label for this specification.">?</span>
                        </label>
                        <input type="text" id="specVersion" name="specVersion">
                    </div>
                    
                    <!-- Date of Implementation (Not Required) -->
                    <div class="info-row">
                        <label for="implDate">Date of Implementation:
                            <span class="semantic-tooltip" title="Date when this specification is planned to be or was implemented.">?</span>
                        </label>
                        <input type="date" id="implDate" name="implDate">
                    </div>
                    
                    <!-- Core Version (Not Required) -->
                    <div class="info-row">
                        <label for="coreVersion">Core Version:
                            <span class="semantic-tooltip" title="Select the version of the core invoice model this specification is based on.">?</span>
                        </label>
                        <select id="coreVersion" name="coreVersion">
                            <option value="">Select Version</option>
                            <option>1.0</option>
                            <option>2.0</option>
                            <option>3.0</option>
                        </select>
                    </div>
                    
                    <!-- Underlying Specification (Not Required) -->
                    <div class="info-row">
                        <label for="underlyingSpec">Underlying Specification:
                            <span class="semantic-tooltip" title="Reference to any underlying or base specification this builds on.">?</span>
                        </label>
                        <input type="text" id="underlyingSpec" name="underlyingSpec">
                    </div>
                    
                    <!-- Specification Source Link (Not Required) -->
                    <div class="info-row">
                        <label for="sourceLink">Specification Source Link:
                            <span class="semantic-tooltip" title="A URL to the official source or documentation for this specification.">?</span>
                        </label>
                        <input type="url" id="sourceLink" name="sourceLink">
                    </div>
                    
                    <!-- Preferred Syntax (Not Required) -->
                    <div class="info-row">
                        <label for="preferredSyntax">Preferred Syntax:
                            <span class="semantic-tooltip" title="Select the preferred syntax for this specification (e.g., UBL, EDIFACT, JSON).">?</span>
                        </label>
                        
                        <select id="preferredSyntax" name="preferredSyntax">
                            <option value="">Select Syntax</option>
                            <option>UBL</option>
                            <option>EDIFACT</option>
                            <option>JSON</option>
                        </select>
                    </div>
                </div>
                
                <!-- Save, Cancel & Core Invoice Model Buttons -->
                <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 30px;">
                    <div>
                        <button type="button" onclick="handleSave()" class="view-button">Save</button>
                        <button type="button" onclick="handleCancel()" class="view-button" style="background:#ccc; color:#333;">Cancel</button>
                    </div>
                    
                    <div>
                        <button type="button" onclick="saveAndGoToCoreInvoiceModel()" class="view-button" style="background:#217a36;">Core Invoice Model</button>
                    </div>
                </div>
            </form>
        </div>

<!----------------------------------------------------------------------------
        JavaScript for mockup functionality
  ------------------------------------------------------------------------------>
        <script>
            let isFormDirty = false;
            let dataManager = null;

            // Initialize data manager and load data
            async function initializeDataManager() {
                try {
                    console.log('DEBUG: IdentifyingInformation - Starting initializeDataManager');
                    console.log('DEBUG: IdentifyingInformation - LocalStorage state:');
                    console.log('  - editMode:', localStorage.getItem('editMode'));
                    console.log('  - specificationIdentityId:', localStorage.getItem('specificationIdentityId'));
                    
                    dataManager = new SpecificationDataManager();
                    console.log('DEBUG: IdentifyingInformation - Data manager initialized');
                    console.log('DEBUG: IdentifyingInformation - Mode:', dataManager.currentMode);
                    console.log('DEBUG: IdentifyingInformation - CurrentSpecId:', dataManager.currentSpecId);
                    console.log('DEBUG: IdentifyingInformation - isEditMode():', dataManager.isEditMode());
                    
                    if (dataManager.isEditMode() && dataManager.currentSpecId) {
                        console.log('DEBUG: IdentifyingInformation - Loading specification for editing. ID:', dataManager.currentSpecId);
                        
                        // Show loading indicator
                        showLoadingIndicator();
                        
                        // Load data from API
                        const formData = await dataManager.loadSpecificationFromAPI(dataManager.currentSpecId);
                        console.log('DEBUG: IdentifyingInformation - Form data loaded:', formData);
                        
                        // Populate form with loaded data
                        populateForm(formData);
                        
                        // Hide loading indicator
                        hideLoadingIndicator();
                        
                        console.log('DEBUG: IdentifyingInformation - Form populated with existing data');
                        isFormDirty = false; // Just loaded, so not dirty
                    } else {
                        console.log('DEBUG: IdentifyingInformation - Creating new specification or missing spec ID');
                        console.log('DEBUG: IdentifyingInformation - isEditMode:', dataManager.isEditMode());
                        console.log('DEBUG: IdentifyingInformation - currentSpecId:', dataManager.currentSpecId);
                        
                        // For new specifications, check if there's any working data
                        const workingData = dataManager.loadWorkingDataFromLocalStorage();
                        if (workingData) {
                            console.log('DEBUG: IdentifyingInformation - Found working data, populating form');
                            populateForm(workingData);
                            isFormDirty = false;
                        } else {
                            console.log('DEBUG: IdentifyingInformation - No working data found');
                        }
                    }
                } catch (error) {
                    console.error('DEBUG: IdentifyingInformation - Error initializing data manager:', error);
                    hideLoadingIndicator();
                    alert(`Error loading specification: ${error.message}`);
                }
            }

            function showLoadingIndicator() {
                const form = document.getElementById('identifyingForm');
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loadingIndicator';
                loadingDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.9); 
                         position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 1000;">
                        <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px; color: #007bff;"></i>
                        <p style="margin-top: 10px;">Loading specification data...</p>
                    </div>
                `;
                loadingDiv.style.position = 'relative';
                form.style.position = 'relative';
                form.appendChild(loadingDiv);
            }

            function hideLoadingIndicator() {
                const loadingDiv = document.getElementById('loadingIndicator');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
            }

            function populateForm(data) {
                console.log('DEBUG: populateForm called with data:', data);
                
                const form = document.getElementById('identifyingForm');
                if (!form) {
                    console.error('DEBUG: populateForm - Form element not found!');
                    return;
                }
                
                // Populate all form fields
                const fieldMappings = {
                    specName: data.specName,
                    governingEntity: data.governingEntity,
                    contactInfo: data.contactInfo,
                    sector: data.sector,
                    subSector: data.subSector,
                    country: data.country,
                    purpose: data.purpose,
                    specId: data.specId,
                    specVersion: data.specVersion,
                    implDate: data.implDate,
                    coreVersion: data.coreVersion,
                    underlyingSpec: data.underlyingSpec,
                    sourceLink: data.sourceLink,
                    preferredSyntax: data.preferredSyntax
                };

                console.log('DEBUG: populateForm - Field mappings:', fieldMappings);
                
                Object.keys(fieldMappings).forEach(fieldName => {
                    const field = form.elements[fieldName];
                    if (field && fieldMappings[fieldName] !== undefined) {
                        const oldValue = field.value;
                        field.value = fieldMappings[fieldName] || '';
                        console.log(`DEBUG: populateForm - Set ${fieldName}: "${oldValue}" -> "${field.value}"`);
                    } else if (!field) {
                        console.warn(`DEBUG: populateForm - Field "${fieldName}" not found in form`);
                    }
                });

                console.log('DEBUG: populateForm - Form populated successfully');
            }

            function getFormData() {
                const form = document.getElementById('identifyingForm');
                return {
                    specName: form.specName.value,
                    governingEntity: form.governingEntity.value,
                    contactInfo: form.contactInfo.value,
                    sector: form.sector.value,
                    subSector: form.subSector.value,
                    country: form.country.value,
                    purpose: form.purpose.value,
                    specId: form.specId.value,
                    specVersion: form.specVersion.value,
                    implDate: form.implDate.value,
                    coreVersion: form.coreVersion.value,
                    underlyingSpec: form.underlyingSpec.value,
                    sourceLink: form.sourceLink.value,
                    preferredSyntax: form.preferredSyntax.value
                };
            }

            async function handleSave() {
                const form = document.getElementById('identifyingForm');
                if (!form.reportValidity()) return;

                try {
                    const formData = getFormData();
                    
                    // Show saving indicator
                    const saveButton = document.querySelector('button[onclick="handleSave()"]');
                    const originalText = saveButton.textContent;
                    saveButton.textContent = 'Saving...';
                    saveButton.disabled = true;

                    // Save to API
                    const result = await dataManager.saveSpecificationToAPI(formData);
                    
                    // Update working data
                    dataManager.workingData = dataManager.transformApiToFormData(result);
                    dataManager.saveWorkingDataToLocalStorage();
                    
                    // Success feedback
                    alert(`Specification ${dataManager.isEditMode() ? 'updated' : 'created'} successfully!`);
                    isFormDirty = false;

                    // Restore button
                    saveButton.textContent = originalText;
                    saveButton.disabled = false;

                } catch (error) {
                    console.error('Error saving specification:', error);
                    alert(`Error saving specification: ${error.message}`);
                    
                    // Restore button
                    const saveButton = document.querySelector('button[onclick="handleSave()"]');
                    saveButton.textContent = 'Save';
                    saveButton.disabled = false;
                }
            }

            async function saveAndGoToCoreInvoiceModel() {
                const form = document.getElementById('identifyingForm');
                
                // Validate form before proceeding
                if (!form.reportValidity()) {
                    alert("Please fill in all required fields before proceeding to Core Invoice Model.");
                    return;
                }

                try {
                    const formData = getFormData();
                    
                    // Show saving indicator
                    const button = document.querySelector('button[onclick="saveAndGoToCoreInvoiceModel()"]');
                    const originalText = button.textContent;
                    button.textContent = 'Saving...';
                    button.disabled = true;

                    // Save to API first
                    const result = await dataManager.saveSpecificationToAPI(formData);
                    
                    // Update working data
                    dataManager.workingData = dataManager.transformApiToFormData(result);
                    dataManager.saveWorkingDataToLocalStorage();
                    
                    // Clear the dirty flag
                    isFormDirty = false;
                    
                    // Navigate to Core Invoice Model
                    window.location.href = 'coreInvoiceModel.html';

                } catch (error) {
                    console.error('Error saving specification:', error);
                    alert(`Error saving specification: ${error.message}`);
                    
                    // Restore button
                    const button = document.querySelector('button[onclick="saveAndGoToCoreInvoiceModel()"]');
                    button.textContent = originalText;
                    button.disabled = false;
                }
            }

            function handleCancel() {
                if (isFormDirty && !confirm("You have unsaved changes. Are you sure you want to cancel?")) {
                    return;
                }
                
                // Clear editing state
                if (dataManager) {
                    dataManager.clearEditingState();
                }
                
                isFormDirty = false;
                
                // Smart navigation: return to calling page or default to mySpecifications.html
                let targetPage = 'mySpecifications.html'; // Default fallback
                
                try {
                    // 1. Check if there's a stored return page in localStorage
                    const storedReturnPage = localStorage.getItem('returnToPage');
                    console.log('handleCancel: Stored return page:', storedReturnPage);
                    
                    if (storedReturnPage) {
                        targetPage = storedReturnPage;
                        localStorage.removeItem('returnToPage'); // Clean up after use
                        console.log('handleCancel: Using stored return page:', targetPage);
                    }
                    // 2. Otherwise, try to use document.referrer
                    else if (document.referrer) {
                        console.log('handleCancel: Document referrer:', document.referrer);
                        const referrerUrl = new URL(document.referrer);
                        const referrerPage = referrerUrl.pathname.split('/').pop();
                        console.log('handleCancel: Extracted referrer page:', referrerPage);
                        
                        // Only navigate back to valid registry pages, avoid loops
                        const validPages = [
                            'mySpecifications.html', 
                            'eInvoicingSpecificationRegistry.html',
                            'viewSpecification.html',
                            'specificationPreview.html'
                        ];
                        
                        if (validPages.includes(referrerPage) && referrerPage !== 'IdentifyingInformation.html') {
                            targetPage = referrerPage;
                            console.log('handleCancel: Using valid referrer page:', targetPage);
                        } else {
                            console.log('handleCancel: Referrer page not valid or is self, using default');
                        }
                    } else {
                        console.log('handleCancel: No referrer available, using default');
                    }
                    
                    console.log('handleCancel: Final target page:', targetPage);
                    window.location.href = targetPage;
                    
                } catch (error) {
                    console.warn('handleCancel: Error determining return page, using default:', error);
                    window.location.href = 'mySpecifications.html';
                }
            }

            // Form change tracking
            document.addEventListener('DOMContentLoaded', () => {
                const form = document.getElementById('identifyingForm');
                const elements = form.querySelectorAll('input, textarea, select');

                elements.forEach(element => {
                    element.addEventListener('change', () => {
                        isFormDirty = true;
                    });
                });

                // Initialize data manager after DOM is ready
                initializeDataManager();
            });

            // Prevent accidental navigation
            window.addEventListener('beforeunload', function (e) {
                if (isFormDirty) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });

            // Add navigation protection for sidebar links
            document.addEventListener('DOMContentLoaded', function() {
                document.querySelectorAll('.sidebar a').forEach(link => {
                    link.addEventListener('click', (e) => {
                        if (isFormDirty && !link.href.includes('IdentifyingInformation.html')) {
                            if (!confirm('You have unsaved changes. Are you sure you want to leave this page?')) {
                                e.preventDefault();
                            }
                        }
                    });
                });
            });
        </script>
        
        <script>
            // Initialize the sidebar and authentication when the page loads
            document.addEventListener('DOMContentLoaded', function() {
                // Initialize auth manager
                window.authManager.init();
                
                // Initialize sidebar
                window.sidebarManager.initializeSidebar(window.authManager);
            });
        </script>
    </body>
</html>