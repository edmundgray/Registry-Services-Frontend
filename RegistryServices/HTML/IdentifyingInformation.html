<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
        <link rel="stylesheet" href="../CSS/style.css">
        
        <!-- Add authManager.js for global AuthManager and AUTH_CONFIG -->
        <script src="../JS/auth/authManager.js"></script>
        <script>
            // Create a global authManager instance
            window.authManager = new AuthManager();


        </script>
        <script src="../JS/sidebarManager.js"></script>
        <script src="../JS/breadcrumbManager.js"></script>
        <script src="../JS/javascript.js"></script>
        <script src="../JS/identifyingInformation.js"></script>
        <script src="../JS/dataManager.js"></script>

        
        <title>Registry Services</title>

        <style>
            .info-row input[type="text"],
            .info-row input[type="url"],
            .info-row input[type="date"],
            .info-row select {
                width: 100%;
                max-width: 240px;
                min-width: 90px;
                box-sizing: border-box;
                padding: 4.5px;
                font-size: 0.75rem;
            }
            .info-row input[readonly] {
                background-color: #f5f5f5 !important;
                color: #666 !important;
                cursor: not-allowed;
                border: 1px solid #ddd;
            }
            .info-row label 
            {
                font-size: 0.741rem;
            }
            .info-table > div 
            {
                padding: 12.35px 9.5px 4.75px 9.5px !important;
                margin-bottom: 13.3px !important;
            }
            .info-table h3 
            {
                font-size: 0.8rem;
                margin-bottom: 7.5px;
            }
            .info-row 
            {
                margin-bottom: 7.6px;
            }
           
            .page-Content 
            {
                padding: 9.5px 1.52vw 1.52vw 1.52vw !important;
            }
            #contactInfo 
            {
                max-width: 240px;
                width: 100%;
                box-sizing: border-box;
                font-size: 0.75rem;
                padding: 4.5px;
            }
            #purpose 
            {
                max-width: 240px;
                width: 100%;
                box-sizing: border-box;
                font-size: 0.75rem;
                padding: 4.5px;
            }
            @media (max-width: 600px) 
            {
                .info-table 
                {
                    max-width: 100% !important;
                    padding: 0 2px;
                }
                .info-row input,
                .info-row select 
                {
                    max-width: 100%;
                    min-width: 0;
                    font-size: 0.76rem;
                }
                .page-Content 
                {
                    padding: 0 0.76vw;
                }
            }
        </style>
    </head>
    <body>
        <div id="sidebarContainer">
            <!-- Sidebar will be dynamically generated by sidebarManager.js -->
        </div>

        <div class="page-Content">
            <div id="breadcrumbContainer" class="breadcrumb-container">
                <!-- Breadcrumb will be dynamically generated by breadcrumbManager.js -->
            </div>
            <h1><i class="fa-solid fa-info"></i> Identifying Information</h1>

            <p style="margin: 10px 0 20px 0;">
                Use the inputs below to begin the process of adding Identifying Information and supporting artefacts to your Specification.<br>
                <span style="color: #d9534f;">*Minimum information required</span>
            </p>

<!----------------------------------------------------------------------------
        (1/2) The Form
        General Information
  ------------------------------------------------------------------------------>            
            <form id="identifyingForm" class="info-table" style="max-width: 600px; margin-left: 0;">
                <div style="background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 24px 24px 10px 24px; margin-bottom: 30px;">
                    <h3 style="background-color: #F4A261; color: #ffffff; padding: 10px 24px;">General Information</h3>
                    
                    <!-- Specification Name (Required) -->
                    <div class="info-row">
                        <label for="specName">*Specification name:
                            <span class="semantic-tooltip" title="Enter the official name of the specification.">?</span>
                        </label>
                        <input type="text" id="specName" name="specName" required>
                    </div>
                    
                    <!-- Governing Entity (Read-only - derived from User Group) -->
                    <div class="info-row">
                        <label for="governingEntity">Governing Entity:
                            <span class="semantic-tooltip" title="Organization or authority responsible for the specification (derived from your user group).">?</span>
                        </label>
                        <input type="text" id="governingEntity" name="governingEntity" readonly>
                    </div>
                    
                    <!-- Contact Info (Required) -->
                    <div class="info-row">
                        <label for="contactInfo">*Contact Information:
                            <span class="semantic-tooltip" title="Provide an email or phone number for contact.">?</span>
                        </label>
                        <textarea id="contactInfo" name="contactInfo" rows="2" required></textarea>
                    </div>

                   <!-- Sector (Required) --> 
                    <div class="info-row">
                        <label for="sector">*Sector:
                            <span class="semantic-tooltip" title="Enter the sector for this specification">?</span>
                        </label>
                        <input type="text" id="sector" name="sector" required>
                    </div>
                    
                    <!-- Sub Sector (Not Required) -->
                    <div class="info-row">
                        <label for="subSector">Sub Sector:
                            <span class="semantic-tooltip" title="Specify a more detailed sector if applicable.">?</span>
                        </label>
                        <input type="text" id="subSector" name="subSector">
                    </div>
                    
                    <!-- Country (Required) -->
                    <div class="info-row">
                        <label for="country">*Country:
                            <span class="semantic-tooltip" title="Select the country using the official EC country codes.">?</span>
                        </label>
                        <select id="country" name="country" required>
                            <option value="">Select Country</option>
                            <option value="any">Any Country</option>
                            <option value="DE">Germany (DE)</option>
                            <option value="NL">Netherlands (NL)</option>
                            <option value="BE">Belgium (BE)</option>
                            <option value="IE">Ireland (IE)</option>
                            <option value="FR">France (FR)</option>
                            <option value="SE">Sweden (SE)</option>
                            <option value="FI">Finland (FI)</option>
                            <option value="UK">United Kingdom (UK)</option>
                            <option value="US">United States (US)</option>
                            <option value="AU">Australia (AU)</option>
                            <option value="IN">India (IN)</option>
                            <option value="CA">Canada (CA)</option>
                        </select>
                    </div>
                    
                    <!-- Purpose (Required) -->
                    <div class="info-row">
                        <label for="purpose">*Purpose:
                            <span class="semantic-tooltip" title="Describe the main purpose of the specification.">?</span>
                        </label>
                        <textarea id="purpose" name="purpose" rows="9" required></textarea>
                    </div>
                </div>
<!----------------------------------------------------------------------------
        (2/2) The Form
        Technical Information
  ------------------------------------------------------------------------------>   
                <div style="background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 24px 24px 10px 24px;">
                    <h3 style="background-color: #F4A261; color: #ffffff; padding: 10px 24px;">Technical Information</h3>
                    
                    <!-- Specification Identifier (Required) -->
                    <div class="info-row">
                        <label for="specId">*Specification Identifier:
                            <span class="semantic-tooltip" title="A unique identifier for this specification (e.g., internal code or reference).">?</span>
                        </label>
                        <input type="text" id="specId" name="specId" required>
                    </div>
                    
                    <!-- Specification Version (Not Required) -->
                    <div class="info-row">
                        <label for="specVersion">Specification Version:
                            <span class="semantic-tooltip" title="Version number or label for this specification.">?</span>
                        </label>
                        <input type="text" id="specVersion" name="specVersion">
                    </div>
                    
                    <!-- Date of Implementation (Not Required) -->
                    <div class="info-row">
                        <label for="implDate">Date of Implementation:
                            <span class="semantic-tooltip" title="Date when this specification is planned to be or was implemented.">?</span>
                        </label>
                        <input type="date" id="implDate" name="implDate">
                    </div>
                    
                    <!-- Core Version (Not Required) -->
                    <div class="info-row">
                        <label for="coreVersion">Core Version:
                            <span class="semantic-tooltip" title="Select the version of the core invoice model this specification is based on.">?</span>
                        </label>
                        <select id="coreVersion" name="coreVersion">
                            <option value="">Select Version</option>
                            <option>EN 16931-1:2017</option>
                            <option>EN 16931-1:2025</option>
                        </select>
                    </div>
                    
                    <!-- Underlying Specification (Not Required) -->
                    <div class="info-row">
                        <label for="underlyingSpec">Underlying Specification:
                            <span class="semantic-tooltip" title="Reference to any underlying or base specification this builds on.">?</span>
                        </label>
                        <input type="text" id="underlyingSpec" name="underlyingSpec">
                    </div>
                    
                    <!-- Specification Source Link (Not Required) -->
                    <div class="info-row">
                        <label for="sourceLink">Specification Source Link:
                            <span class="semantic-tooltip" title="A URL to the official source or documentation for this specification.">?</span>
                        </label>
                        <input type="url" id="sourceLink" name="sourceLink">
                    </div>
                    
                    <!-- Preferred Syntax (Not Required) -->
                    <div class="info-row">
                        <label for="preferredSyntax">Preferred Syntax:
                            <span class="semantic-tooltip" title="Select the preferred syntax for this specification (e.g., UBL, EDIFACT, JSON).">?</span>
                        </label>
                        
                        <select id="preferredSyntax" name="preferredSyntax">
                            <option value="">Select Syntax</option>
                            <option>UBL</option>
                            <option>EDIFACT</option>
                            <option>JSON</option>
                        </select>
                    </div>
                </div>
                
                <!-- Save, Cancel & Core Invoice Model Buttons -->
                <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 30px;">
                    <div>
                        <button type="button" onclick="handleSave()" >Save</button>
                        <button type="button" onclick="handleCancel()" style="background:#6c757d; color:#fff;">Cancel</button>
                    </div>
                    
                    <div>
                        <button type="button" onclick="saveAndGoToCoreInvoiceModel()" >Core Invoice Model</button>
                    </div>
                </div>
            </form>
        </div>

<!----------------------------------------------------------------------------
        JavaScript for mockup functionality
  ------------------------------------------------------------------------------>
        <script>
            // Note: isFormDirty is deprecated in favor of hasActualChanges()
            // let isFormDirty = false;
            let dataManager = null;
            let suppressBeforeUnload = false; // Flag to temporarily suppress beforeunload warning

            async function createGoverningEntityDropdown() {
                try {
                    console.log('DEBUG: Admin user detected. Creating governing entity dropdown.');
                    
                    // Fetch all user groups (governing entities)
                    const response = await window.authManager.authenticatedFetch(`${AUTH_CONFIG.baseUrl}/usergroups`, {
                        method: 'GET',
                        forceAuth: true
                    });

                    if (!response.ok) {
                        throw new Error('Failed to fetch governing entities for dropdown');
                    }
                    const userGroups = await response.json();

                    const inputElement = document.getElementById('governingEntity');
                    if (!inputElement) return;

                    const selectElement = document.createElement('select');
                    selectElement.id = 'governingEntity';
                    selectElement.name = 'governingEntity';
                    // Apply existing styling to the new dropdown
                    selectElement.style.width = '100%';
                    selectElement.style.maxWidth = '240px';
                    selectElement.style.padding = '4.5px';
                    selectElement.style.fontSize = '0.75rem';

                    // Add options to the dropdown
                    userGroups.forEach(group => {
                        const option = document.createElement('option');
                        option.value = group.userGroupID; // The value is the ID
                        option.textContent = group.groupName; // The text is the name
                        selectElement.appendChild(option);
                    });

                    // Replace the original input element with the new select element
                    inputElement.parentNode.replaceChild(selectElement, inputElement);
                    console.log('DEBUG: Replaced governing entity input with a dropdown.');

                } catch (error) {
                    console.error('Error creating governing entity dropdown:', error);
                    // If the API call fails, the original input field will remain, which is a safe fallback.
                }
            }
            
            // Initialize data manager and load data
            async function initializeDataManager() {
                try {
                    console.log('DEBUG: IdentifyingInformation - Starting initializeDataManager');
                    
                    window.authManager.init();
                    const currentUser = getCurrentUser();
                    const isUserAdmin = currentUser.role === 'Admin';

                    // If the user is an admin, create the dropdown immediately.
                    if (isUserAdmin) {
                        await createGoverningEntityDropdown();
                    }

                    console.log('DEBUG: IdentifyingInformation - LocalStorage state:');
                    console.log('  - editMode:', localStorage.getItem('editMode'));
                    console.log('  - specificationIdentityId:', localStorage.getItem('specificationIdentityId'));
                    
                    // Check if auth manager has a valid token before proceeding
                    if (!window.authManager || !window.authManager.isAuthenticated) {
                        console.log('DEBUG: IdentifyingInformation - Not authenticated, skipping data loading');
                        return;
                    }
                    
                    // Ensure AuthManager is properly initialized with userGroupID
                   
                    console.log('DEBUG: IdentifyingInformation - Current user after re-init:', currentUser);
                    
                    dataManager = new SpecificationDataManager();
                    console.log('DEBUG: IdentifyingInformation - Data manager initialized');
                    console.log('DEBUG: IdentifyingInformation - Mode:', dataManager.currentMode);
                    console.log('DEBUG: IdentifyingInformation - CurrentSpecId:', dataManager.currentSpecId);
                    console.log('DEBUG: IdentifyingInformation - isEditMode():', dataManager.isEditMode());
                    
                    if (dataManager.isEditMode() && dataManager.currentSpecId) {
                        console.log('DEBUG: IdentifyingInformation - Loading specification for editing. ID:', dataManager.currentSpecId);
                        
                        // Show loading indicator
                        showLoadingIndicator();
                        
                        try {
                            // Load data from API
                            const formData = await dataManager.loadSpecificationFromAPI(dataManager.currentSpecId);
                            console.log('DEBUG: IdentifyingInformation - Form data loaded:', formData);
                            
                            // Set the working data in the dataManager so hasActualChanges() works correctly
                            dataManager.workingData = formData;
                            console.log('DEBUG: IdentifyingInformation - Working data set in dataManager:', dataManager.workingData);
                            
                            // Populate form with loaded data
                            populateForm(formData);
                            
                            // Update save button appearance (should be grey since no changes made yet)
                            setTimeout(() => {
                                updateSaveButtonAppearance();
                            }, 100); // Small delay to ensure form is fully populated
                            
                            console.log('DEBUG: IdentifyingInformation - Form populated with existing data');
                        } catch (apiError) {
                            console.error('DEBUG: IdentifyingInformation - API error:', apiError);
                            
                            // If API call fails due to authentication, handle session expiry
                            if (apiError.message.includes('Session expired')) {
                                console.log('DEBUG: IdentifyingInformation - API call failed due to session expiry');
                                hideLoadingIndicator();
                                return; // Don't continue, let session expiry handler take over
                            }
                            
                            // For other errors, continue with working data
                            console.log('DEBUG: IdentifyingInformation - API failed, trying working data');
                            const workingData = dataManager.loadWorkingDataFromLocalStorage();
                            if (workingData) {
                                populateForm(workingData);
                            }
                        }
                        
                        // Hide loading indicator
                        hideLoadingIndicator();
                        
                        // Note: No need to set isFormDirty anymore since we use hasActualChanges()
                    } else {
                        console.log('DEBUG: IdentifyingInformation - Creating new specification or missing spec ID');
                        console.log('DEBUG: IdentifyingInformation - isEditMode:', dataManager.isEditMode());
                        console.log('DEBUG: IdentifyingInformation - currentSpecId:', dataManager.currentSpecId);
                        
                        // For new specifications, check if there's any working data
                        const workingData = dataManager.loadWorkingDataFromLocalStorage();
                        if (workingData) {
                            console.log('DEBUG: IdentifyingInformation - Found working data, populating form');
                            populateForm(workingData);
                            
                            setTimeout(() => {
                                updateSaveButtonAppearance();
                            }, 100);
                            // Note: No need to set isFormDirty anymore since we use hasActualChanges()
                        } else {
                            console.log('DEBUG: IdentifyingInformation - No working data found, initializing with defaults');
                            // Initialize with empty data but populate governing entity
                            const emptyData = {
                                specName: '',
                                contactInfo: '',
                                sector: '',
                                subSector: '',
                                country: '',
                                purpose: '',
                                specId: '',
                                specVersion: '',
                                implDate: '',
                                coreVersion: '',
                                underlyingSpec: '',
                                sourceLink: '',
                                preferredSyntax: ''
                            };
                            
                            // Set this as the baseline data for change detection in create mode
                            dataManager.workingData = { ...emptyData };
                            console.log('DEBUG: IdentifyingInformation - Set baseline data for create mode:', dataManager.workingData);
                            
                            populateForm(emptyData); // This will auto-populate governing entity
                            // Update save button appearance
                            setTimeout(() => {
                                updateSaveButtonAppearance();
                            }, 100);
                            // Note: No need to set isFormDirty anymore since we use hasActualChanges()
                        }
                    }
                } catch (error) {
                    console.error('DEBUG: IdentifyingInformation - Error initializing data manager:', error);
                    hideLoadingIndicator();
                    
                    // Don't show alert for session-related errors
                    if (!error.message.includes('Session expired')) {
                        alert(`Error loading specification: ${error.message}`);
                    }
                }
            }

            // Add event listeners to form fields for real-time save button updates
            function attachFormEventListeners() {
                console.log('DEBUG: IdentifyingInformation - Attaching form event listeners');
                
                const form = document.getElementById('identifyingForm');
                if (!form) {
                    console.error('DEBUG: IdentifyingInformation - Form not found for event listeners');
                    return;
                }
                
                // Get all input, select, and textarea elements in the form
                const formFields = form.querySelectorAll('input, select, textarea');
                
                formFields.forEach(field => {
                    // Add both 'input' and 'change' event listeners for comprehensive coverage
                    field.addEventListener('input', () => {
                        console.log(`DEBUG: IdentifyingInformation - Input event on ${field.name || field.id}`);
                        updateSaveButtonAppearance();
                    });
                    
                    field.addEventListener('change', () => {
                        console.log(`DEBUG: IdentifyingInformation - Change event on ${field.name || field.id}`);
                        updateSaveButtonAppearance();
                    });
                });
                
                console.log(`DEBUG: IdentifyingInformation - Event listeners attached to ${formFields.length} form fields`);
            }

            function showLoadingIndicator() {
                const form = document.getElementById('identifyingForm');
                const loadingDiv = document.createElement('div');
                loadingDiv.id = 'loadingIndicator';
                loadingDiv.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: rgba(255,255,255,0.9); 
                         position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 1000;">
                        <i class="fa-solid fa-spinner fa-spin" style="font-size: 24px; color: #007bff;"></i>
                        <p style="margin-top: 10px;">Loading specification data...</p>
                    </div>
                `;
                loadingDiv.style.position = 'relative';
                form.style.position = 'relative';
                form.appendChild(loadingDiv);
            }

            function hideLoadingIndicator() {
                const loadingDiv = document.getElementById('loadingIndicator');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
            }

            function populateForm(data) {
                console.log('DEBUG: populateForm called with data:', data);
                
                const form = document.getElementById('identifyingForm');
                if (!form) {
                    console.error('DEBUG: populateForm - Form element not found!');
                    return;
                }
                
                // Get current user for governing entity population
                const currentUser = getCurrentUser();
                let governingEntityName = '';

                if (dataManager && dataManager.isEditMode()) {
                    // For edit mode, use the data from API
                    governingEntityName = data.governingEntity || '';
                    console.log('DEBUG: populateForm - Edit mode, using API governing entity:', governingEntityName);
                } else {
                    // For create mode, use current user's group name
                    governingEntityName = currentUser.groupName || 
                                     localStorage.getItem('groupName') || 
                                     window.authManager?.groupName || 
                                     '';
                    console.log('DEBUG: populateForm - Create mode, using user group name as governing entity:', governingEntityName);
                    console.log('DEBUG: populateForm - Group name sources:', {
                        fromCurrentUser: currentUser.groupName,
                        fromLocalStorage: localStorage.getItem('groupName'),
                        fromAuthManager: window.authManager?.groupName,
                        finalChoice: governingEntity
                    });
                }
                
                // Populate all form fields
                const fieldMappings = {
                    specName: data.specName,
                    governingEntity: governingEntityName,
                    contactInfo: data.contactInfo,
                    sector: data.sector,
                    subSector: data.subSector,
                    country: data.country,
                    purpose: data.purpose,
                    specId: data.specId,
                    specVersion: data.specVersion,
                    implDate: data.implDate,
                    coreVersion: data.coreVersion,
                    underlyingSpec: data.underlyingSpec,
                    sourceLink: data.sourceLink,
                    preferredSyntax: data.preferredSyntax
                };

                console.log('DEBUG: populateForm - Field mappings:', fieldMappings);
                
                Object.keys(fieldMappings).forEach(fieldName => {
                    const field = form.elements[fieldName];
                    if (field) {
                        const oldValue = field.value;
                        
                        if (fieldName === 'governingEntity' && field.tagName === 'SELECT') {
                            const optionToSelect = Array.from(field.options).find(opt => opt.text === governingEntityName);
                            if (optionToSelect) {
                                field.value = optionToSelect.value; 
                            } else if (currentUser.role === 'Admin' && !dataManager.isEditMode()) {
                                
                                const adminOption = Array.from(field.options).find(opt => opt.text === currentUser.groupName);
                                if (adminOption) field.value = adminOption.value;
                            }
                        } else {
                            field.value = fieldMappings[fieldName] || '';
                        }
                     
                        console.log(`DEBUG: populateForm - Set ${fieldName}: "${oldValue}" -> "${field.value}"`);
                    }
                });

                console.log('DEBUG: populateForm - Form populated successfully');
            }

            function getFormData() {
                const form = document.getElementById('identifyingForm');
                const govEntityElement = form.elements.governingEntity;
                let governingEntityName = '';
                let selectedUserGroupID = null;

                if (govEntityElement.tagName === 'SELECT') {
                    const selectedOption = govEntityElement.options[govEntityElement.selectedIndex];
                    if (selectedOption) {
                        governingEntityName = selectedOption.text;
                        selectedUserGroupID = selectedOption.value; // Capture the ID
                    }
                } else {
                    governingEntityName = govEntityElement.value;
                }

                return {
                    specName: form.specName.value,
                    governingEntity: form.governingEntityName,
                    userGroupID: selectedUserGroupID, // Include the user group ID
                    contactInfo: form.contactInfo.value,
                    sector: form.sector.value,
                    subSector: form.subSector.value,
                    country: form.country.value,
                    purpose: form.purpose.value,
                    specId: form.specId.value,
                    specVersion: form.specVersion.value,
                    implDate: form.implDate.value,
                    coreVersion: form.coreVersion.value,
                    underlyingSpec: form.underlyingSpec.value,
                    sourceLink: form.sourceLink.value,
                    preferredSyntax: form.preferredSyntax.value
                };
            }

            // Enhanced change detection functions with comprehensive debugging
            function hasActualChanges() {
                console.log('DEBUG: IdentifyingInformation - hasActualChanges() called');
                
                try {
                    if (!dataManager || !dataManager.workingData) {
                        console.log('DEBUG: IdentifyingInformation - No baseline data (dataManager.workingData), checking if form has content');
                        // In create mode without baseline, check if form has any content
                        if (dataManager && dataManager.isCreateMode()) {
                            const currentData = getFormData();
                            const hasContent = Object.values(currentData).some(value => value && value.trim() !== '');
                            console.log('DEBUG: IdentifyingInformation - Create mode - Form has content without baseline:', hasContent);
                            return hasContent;
                        }
                        return false;
                    }
                    
                    const currentData = getFormData();
                    const originalData = dataManager.workingData;
                    
                    console.log('DEBUG: IdentifyingInformation - Comparing data:', {
                        current: currentData,
                        baseline: originalData
                    });
                    
                    // Field-by-field comparison with detailed logging
                    const fields = Object.keys(currentData);
                    for (const field of fields) {
                        const currentValue = currentData[field] || '';
                        const baselineValue = originalData[field] || '';
                        
                        if (currentValue !== baselineValue) {
                            console.log(`DEBUG: IdentifyingInformation - Change detected in ${field}:`, {
                                baseline: baselineValue,
                                current: currentValue
                            });
                            return true;
                        }
                    }
                    
                    console.log('DEBUG: IdentifyingInformation - No changes detected');
                    return false;
                } catch (error) {
                    console.error('DEBUG: IdentifyingInformation - Error in hasActualChanges():', error);
                    return false;
                }
            }

            // Make hasActualChanges globally accessible for breadcrumb manager
            window.hasActualChanges = hasActualChanges;

            function getChangedFields() {
                console.log('DEBUG: IdentifyingInformation - getChangedFields() called');
                
                try {
                    if (!dataManager || !dataManager.workingData) {
                        console.log('DEBUG: IdentifyingInformation - No baseline data for getChangedFields()');
                        // In create mode without baseline, treat any non-empty fields as changes
                        if (dataManager && dataManager.isCreateMode()) {
                            console.log('DEBUG: IdentifyingInformation - Create mode: treating non-empty fields as changes');
                            const currentData = getFormData();
                            const changedFields = [];
                            
                            Object.keys(currentData).forEach(field => {
                                const currentValue = currentData[field] || '';
                                if (currentValue.trim() !== '') {
                                    changedFields.push({
                                        field: field,
                                        displayName: getFieldDisplayName(field),
                                        oldValue: '(empty)',
                                        newValue: currentValue
                                    });
                                }
                            });
                            
                            console.log('DEBUG: IdentifyingInformation - Create mode changes detected:', changedFields);
                            return changedFields;
                        }
                        return [];
                    }
                    
                    const currentData = getFormData();
                    const originalData = dataManager.workingData;
                    const changedFields = [];
                    
                    Object.keys(currentData).forEach(field => {
                        const currentValue = currentData[field] || '';
                        const baselineValue = originalData[field] || '';
                        
                        if (currentValue !== baselineValue) {
                            changedFields.push({
                                field: field,
                                displayName: getFieldDisplayName(field),
                                oldValue: baselineValue,
                                newValue: currentValue
                            });
                        }
                    });
                    
                    console.log('DEBUG: IdentifyingInformation - Changed fields detected:', changedFields);
                    return changedFields;
                } catch (error) {
                    console.error('DEBUG: IdentifyingInformation - Error in getChangedFields():', error);
                    return [];
                }
            }

            function getFieldDisplayName(fieldName) {
                const displayNames = {
                    specName: 'Specification Name',
                    governingEntity: 'Governing Entity',
                    contactInfo: 'Contact Information',
                    sector: 'Sector',
                    subSector: 'Sub Sector',
                    country: 'Country',
                    purpose: 'Purpose',
                    specId: 'Specification Identifier',
                    specVersion: 'Specification Version',
                    implDate: 'Date of Implementation',
                    coreVersion: 'Core Version',
                    underlyingSpec: 'Underlying Specification',
                    sourceLink: 'Specification Source Link',
                    preferredSyntax: 'Preferred Syntax'
                };
                return displayNames[fieldName] || fieldName;
            }

            function showChangeConfirmationModal(changedFields, onConfirm, onCancel) {
                // Create modal HTML
                const modalHtml = `
                    <div id="changeConfirmModal" style="
                        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                        background: rgba(0,0,0,0.5); z-index: 1002; display: flex;
                        align-items: center; justify-content: center;">
                        <div style="
                            background: white; border-radius: 8px; padding: 24px; max-width: 500px;
                            width: 90%; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                            <h3 style="margin: 0 0 16px 0; color: #333;">
                                <i class="fa-solid fa-save" style="color: #28a745; margin-right: 8px;"></i>
                                Confirm Save Changes
                            </h3>
                            <p style="margin: 0 0 16px 0; color: #666;">
                                You have modified <strong>${changedFields.length}</strong> field${changedFields.length !== 1 ? 's' : ''}. 
                                Do you want to save these changes?
                            </p>
                            <div style="max-height: 200px; overflow-y: auto; background: #f8f9fa; 
                                 border-radius: 4px; padding: 12px; margin: 16px 0;">
                                ${changedFields.map(change => `
                                    <div style="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #e9ecef;">
                                        <strong style="color: #495057;">${change.displayName}</strong><br>
                                        <small style="color: #6c757d;">
                                            From: <span style="background: #f8d7da; padding: 2px 4px; border-radius: 2px;">${change.oldValue || '(empty)'}</span><br>
                                            To: <span style="background: #d4edda; padding: 2px 4px; border-radius: 2px;">${change.newValue || '(empty)'}</span>
                                        </small>
                                    </div>
                                `).join('')}
                            </div>
                            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                                <button onclick="cancelSaveChanges()" style="
                                    padding: 8px 16px; background: #6c757d; color: white; border: none;
                                    border-radius: 4px; cursor: pointer; font-size: 14px;">
                                    Cancel
                                </button>
                                <button onclick="confirmSaveChanges()" style="
                                    padding: 8px 16px; background: #28a745; color: white, border: none;
                                    border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">
                                    <i class="fa-solid fa-save" style="margin-right: 4px;"></i>
                                    Save Changes
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to page
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Store callbacks
                window.confirmSaveChanges = () => {
                    document.getElementById('changeConfirmModal').remove();
                    onConfirm();
                };
                
                window.cancelSaveChanges = () => {
                    document.getElementById('changeConfirmModal').remove();
                    if (onCancel) onCancel();
                };
            }

            
            async function handleSave() {
                const form = document.getElementById('identifyingForm');
                if (!form.reportValidity()) return;

                // Check if there are actual changes
                const changedFields = getChangedFields();
                
                if (changedFields.length === 0) {
                    // Show "no changes" modal
                    const modalHtml = `
                        <div id="noChangesModal" style="
                            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                            background: rgba(0,0,0,0.5); z-index: 1002; display: flex;
                            align-items: center; justify-content: center;">
                            <div style="
                                background: white; border-radius: 8px; padding: 24px; max-width: 400px;
                                width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                                <h3 style="margin: 0 0 16px 0; color: #333;">
                                    <i class="fa-solid fa-info-circle" style="color: #17a2b8; margin-right: 8px;"></i>
                                    No Changes Detected
                                </h3>
                                <p style="margin: 0 0 20px 0; color: #666;">
                                    There are no unsaved changes to save. The form data matches the last saved version.
                                </p>
                                <div style="text-align: center;">
                                    <button onclick="document.getElementById('noChangesModal').remove()" style="
                                        padding: 8px 16px; background: #17a2b8; color: white; border: none;
                                        border-radius: 4px; cursor: pointer; font-size: 14px;">
                                        OK
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    return;
                }                // Show confirmation modal with change details
                showChangeConfirmationModal(changedFields, async () => {
                    try {
                        const formData = getFormData();
                        
                        // Show saving indicator
                        const saveButton = document.querySelector('button[onclick="handleSave()"]');
                        const originalText = saveButton.textContent;
                        saveButton.textContent = 'Saving...';
                        saveButton.disabled = true;

                        // Save to API
                        const result = await dataManager.saveSpecificationToAPI(formData);
                        
                        // Update working data baseline to the current form data (what was just saved)
                        dataManager.workingData = { ...formData };
                        dataManager.saveWorkingDataToLocalStorage();
                        console.log('DEBUG: IdentifyingInformation - Baseline updated after save:', dataManager.workingData);
                        
                        // Success feedback
                        alert(`Specification ${dataManager.isEditMode() ? 'updated' : 'created'} successfully!`);
                        updateSaveButtonAppearance();

                        // Restore button
                        saveButton.textContent = originalText;
                        saveButton.disabled = false;

                    } catch (error) {
                        console.error('Error saving specification:', error);
                        
                        // Provide more user-friendly error messages
                        let errorMessage = 'Error saving specification: ';
                        if (error.message.includes('Failed to fetch')) {
                            errorMessage += 'Unable to connect to the server. Please check your internet connection and try again.';
                        } else if (error.message.includes('HTTP error! status: 401')) {
                            errorMessage += 'Authentication failed. Please log in again.';
                        } else if (error.message.includes('HTTP error! status: 403')) {
                            errorMessage += 'You don\'t have permission to perform this action.';
                        } else if (error.message.includes('HTTP error! status: 500')) {
                            errorMessage += 'Server error. Please try again later or contact support.';
                        } else if (error.message.includes('Unexpected end of JSON input')) {
                            errorMessage += 'Server returned an invalid response. The data may have been saved successfully. Please refresh the page to check.';
                        } else {
                            errorMessage += error.message;
                        }
                        
                        alert(errorMessage);
                        
                        // Restore button
                        const saveButton = document.querySelector('button[onclick="handleSave()"]');
                        saveButton.textContent = 'Save';
                        saveButton.disabled = false;
                    }
                });
            }

            function showNavigationConfirmationModal() {
                const hasChanges = hasActualChanges();
                
                if (!hasChanges) {
                    // No changes detected, just navigate
                    window.location.href = 'coreInvoiceModel.html';
                    return;
                }

                // Create custom confirmation modal
                const modalHtml = `
                    <div id="navigationConfirmModal" style="
                        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                        background: rgba(0,0,0,0.5); z-index: 1002; display: flex;
                        align-items: center; justify-content: center;">
                        <div style="
                            background: white; border-radius: 8px; padding: 24px; max-width: 500px;
                            width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                            <h3 style="margin: 0 0 16px 0; color: #333;">
                                <i class="fa-solid fa-car" style="color: #007bff; margin-right: 8px;"></i>
                                Continue to Core Invoice Model
                            </h3>
                            <p style="margin: 0 0 16px 0; color: #666;">
                                You have unsaved changes. What would you like to do?
                            </p>
                            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 4px; padding: 12px; margin: 16px 0;">
                                <i class="fa-solid fa-exclamation-triangle" style="color: #856404; margin-right: 8px;"></i>
                                <small style="color: #856404;">
                                    <strong>Note:</strong> Your changes will be lost if you don't save them first.
                                </small>
                            </div>
                            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                                <button onclick="cancelNavigation()" style="
                                    padding: 8px 16px; background: #6c757d; color: white; border: none;
                                    border-radius: 4px; cursor: pointer; font-size: 14px;">
                                    <i class="fa-solid fa-times" style="margin-right: 4px;"></i>
                                    Cancel
                                </button>
                                <button onclick="continueWithoutSaving()" style="
                                    padding: 8px 16px; background: #dc3545; color: white; border: none;
                                    border-radius: 4px; cursor: pointer; font-size: 14px;">
                                    <i class="fa-solid fa-forward" style="margin-right: 4px;"></i>
                                    Continue Without Saving
                                </button>
                                <button onclick="saveAndContinue()" style="
                                    padding: 8px 16px; background: #28a745; color: white; border: none;
                                    border-radius: 4px; cursor: pointer; font-size: 14px; font-weight: bold;">
                                    <i class="fa-solid fa-save" style="margin-right: 4px;"></i>
                                    Save & Continue
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add modal to page
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                // Define modal actions
                window.cancelNavigation = () => {
                    document.getElementById('navigationConfirmModal').remove();
                    // Button state is automatically reset since we don't modify it during modal display
                };
                
                window.continueWithoutSaving = () => {
                    document.getElementById('navigationConfirmModal').remove();
                    // Navigate without saving
                    window.location.href = 'coreInvoiceModel.html';
                };
                
                window.saveAndContinue = async () => {
                    const modal = document.getElementById('navigationConfirmModal');
                    const saveButton = modal.querySelector('button[onclick="saveAndContinue()"]');
                    const originalText = saveButton.textContent;
                    
                    try {
                        // Suppress beforeunload warning during save and navigation
                        suppressBeforeUnload = true;
                        console.log('DEBUG: IdentifyingInformation - Suppressing beforeunload warning for save and continue');
                        
                        // Show saving indicator
                        saveButton.textContent = 'Saving...';
                        saveButton.disabled = true;
                        
                        const formData = getFormData();
                        
                        // Update baseline immediately to prevent beforeunload warning
                        dataManager.workingData = { ...formData };
                        console.log('DEBUG: IdentifyingInformation - Baseline updated immediately before save to prevent beforeunload:', dataManager.workingData);
                        
                        // Save to API first
                        const result = await dataManager.saveSpecificationToAPI(formData);
                        
                        // Update working data baseline with API response
                        if (result && typeof dataManager.transformApiToFormData === 'function') {
                            dataManager.workingData = dataManager.transformApiToFormData(result);
                        } else {
                            // Fallback: keep the form data as baseline
                            dataManager.workingData = { ...formData };
                        }
                        dataManager.saveWorkingDataToLocalStorage();
                        console.log('DEBUG: IdentifyingInformation - Final baseline updated after API save:', dataManager.workingData);
                        
                        // Remove modal and navigate
                        modal.remove();
                        window.location.href = 'coreInvoiceModel.html';
                        
                    } catch (error) {
                        console.error('Error saving specification:', error);
                        
                        // Re-enable beforeunload warning since save failed
                        suppressBeforeUnload = false;
                        console.log('DEBUG: IdentifyingInformation - Re-enabled beforeunload warning due to save failure');
                        
                        // Reset baseline to original state since save failed
                        try {
                            if (dataManager && dataManager.loadWorkingDataFromLocalStorage) {
                                const originalData = dataManager.loadWorkingDataFromLocalStorage();
                                if (originalData) {
                                    dataManager.workingData = originalData;
                                    console.log('DEBUG: IdentifyingInformation - Baseline reset to original after save failure');
                                }
                            }
                        } catch (resetError) {
                            console.warn('DEBUG: IdentifyingInformation - Could not reset baseline after save failure:', resetError);
                        }
                        
                        // Provide more user-friendly error messages
                        let errorMessage = 'Error saving specification: ';
                        if (error.message.includes('Failed to fetch')) {
                            errorMessage += 'Unable to connect to the server. Please check your internet connection and try again.';
                        } else if (error.message.includes('HTTP error! status: 401')) {
                            errorMessage += 'Authentication failed. Please log in again.';
                        } else if (error.message.includes('HTTP error! status: 403')) {
                            errorMessage += 'You don\'t have permission to perform this action.';
                        } else if (error.message.includes('HTTP error! status: 500')) {
                            errorMessage += 'Server error. Please try again later or contact support.';
                        } else if (error.message.includes('Unexpected end of JSON input')) {
                            errorMessage += 'Server returned an invalid response. The data may have been saved successfully. Please refresh the page to check.';
                        } else {
                            errorMessage += error.message;
                        }
                        
                        alert(errorMessage);
                        
                        // Restore button
                        saveButton.textContent = originalText;
                        saveButton.disabled = false;
                    }
                };
            }

            async function saveAndGoToCoreInvoiceModel() {
                const form = document.getElementById('identifyingForm');
                
                // Validate form before proceeding
                if (!form.reportValidity()) {
                    alert("Please fill in all required fields before proceeding to Core Invoice Model.");
                    return;
                }

                // Show navigation confirmation modal
                showNavigationConfirmationModal();
            }

            // Cleanup function to remove any session-related elements
            function cleanupSessionNotifications() {
                let removedCount = 0;
                
                // Remove any existing session expiry notifications
                const existingNotifications = document.querySelectorAll('.session-expiry-notification');
                existingNotifications.forEach(notification => {
                    notification.remove();
                    removedCount++;
                });
                
                // Remove any existing modals by ID
                const modalIds = ['sessionExpiryModal', 'sessionWarningModal', 'workflowRecoveryModal'];
                modalIds.forEach(modalId => {
                    const modal = document.getElementById(modalId);
                    if (modal) {
                        modal.remove();
                        removedCount++;
                        console.log(`Removed modal with ID: ${modalId}`);
                    }
                });
                
                // Remove any notifications by class
                const notificationClasses = ['notification', 'notification.info', 'notification.warning', 'notification.error', 'notification.success'];
                notificationClasses.forEach(className => {
                    const elements = document.querySelectorAll(`.${className}`);
                    elements.forEach(element => {
                        element.remove();
                        removedCount++;
                        console.log(`Removed element with class: ${className}`);
                    });
                });
                
                // Remove any elements with session or expiry in ID or class
                const sessionSelectors = [
                    '[id*="session"]',
                    '[id*="Session"]',
                    '[class*="session"]',
                    '[class*="expiry"]',
                    '[class*="warning"]'
                ];
                
                sessionSelectors.forEach(selector => {
                    const elements = document.querySelectorAll(selector);
                    elements.forEach(element => {
                        element.remove();
                        removedCount++;
                        console.log(`Removed element with selector: ${selector}`);
                    });
                });
                
                // Clear any session countdown intervals
                if (window.sessionCountdownInterval) {
                    clearInterval(window.sessionCountdownInterval);
                    window.sessionCountdownInterval = null;
                    removedCount++;
                    console.log('Cleared session countdown interval');
                }
                
                // Clear any session warning timeouts
                if (window.sessionWarningTimeout) {
                    clearTimeout(window.sessionWarningTimeout);
                    window.sessionWarningTimeout = null;
                    removedCount++;
                    console.log('Cleared session warning timeout');
                }
                
                // Only log if we actually removed something
                if (removedCount > 0) {
                    console.log(`Session cleanup completed - removed ${removedCount} elements/timers`);
                }
            }

            // Manual cleanup function for testing - can be called from browser console
            function forceCleanupAllSessionElements() {
                console.log('FORCE CLEANUP: Starting aggressive session element removal...');
                
                // Get all elements in the document
                const allElements = document.querySelectorAll('*');
                const removedElements = [];
                
                allElements.forEach(element => {
                    const text = element.textContent.toLowerCase();
                    const classList = element.className.toLowerCase();
                    const id = element.id.toLowerCase();
                    const style = element.style.cssText.toLowerCase();
                    
                    // Check if element contains session-related content
                    if (text.includes('session') || text.includes('expired') || text.includes('expiry') ||
                        text.includes('login') || text.includes('redirecting') ||
                        classList.includes('notification') || classList.includes('session') ||
                        id.includes('session') || id.includes('notification') || id.includes('modal') ||
                        (style.includes('position: fixed') && style.includes('z-index: 1000'))) {
                        
                        // Don't remove the page content or essential elements
                        if (!element.closest('.page-Content') && 
                            !element.closest('#sidebarContainer') && 
                            !element.closest('#breadcrumbContainer') &&
                            element.tagName !== 'SCRIPT' &&
                            element.tagName !== 'STYLE' &&
                            element.tagName !== 'LINK') {
                            console.log('FORCE REMOVING:', element);
                            removedElements.push({
                                tag: element.tagName,
                                class: element.className,
                                id: element.id,
                                text: element.textContent.substring(0, 100)
                            });
                            element.remove();
                        }
                    }
                });
                
                console.log('FORCE CLEANUP: Removed elements:', removedElements);
                
                // Clear all possible intervals and timeouts
                for (let i = 1; i < 10000; i++) {
                    clearInterval(i);
                    clearTimeout(i);
                }
                
                console.log('FORCE CLEANUP: Cleared all intervals and timeouts');
                
                return removedElements;
            }
            
            // Make it globally accessible for console testing
            window.forceCleanupAllSessionElements = forceCleanupAllSessionElements;

            // Initialize the sidebar and authentication when the page loads
            document.addEventListener('DOMContentLoaded', function() {
                // Clean up any existing session notifications on page load
                cleanupSessionNotifications();
                
                // Set up periodic cleanup to catch any session elements that appear
                setInterval(() => {
                    cleanupSessionNotifications();
                }, 10000); // Check every 10 seconds (reduced from 2 seconds)
                
                // Wait a brief moment to ensure all DOM elements are ready
                setTimeout(async () => {
                    try {
                        // Initialize auth manager
                        window.authManager.init();
                        
                        // Initialize session manager for this workflow step (temporarily disabled to prevent token refresh issues)
                        /*
                        if (window.workflowSessionManager) {
                            console.log('DEBUG: Initializing workflow session manager');
                            window.workflowSessionManager.init('specification-creation');
                        } else {
                            console.error('DEBUG: workflowSessionManager not available!');
                        }
                        */
                        
                        // Initialize sidebar
                        window.sidebarManager.initializeSidebar(window.authManager);                        
                        // Initialize breadcrumb system
                        window.breadcrumbManager.init();
                        
                        // Check if there's already a breadcrumb context set (from navigation)
                        const existingContext = window.breadcrumbManager.getContext();
                        
                        if (existingContext && existingContext.timestamp && (Date.now() - existingContext.timestamp) < 5000) {
                            // Recent context exists (set within last 5 seconds), preserve it but update the current page
                            console.log('DEBUG: Preserving existing breadcrumb context from navigation');
                            existingContext.currentPage = 'IdentifyingInformation.html';
                            window.breadcrumbManager.updateContext(existingContext);
                        } else {
                            // No recent context, set new context based on localStorage mode
                            console.log('DEBUG: Setting new breadcrumb context for identifying information');
                            
                            // Determine action based on localStorage editMode
                            const editMode = localStorage.getItem('editMode');
                            const specificationIdentityId = localStorage.getItem('specificationIdentityId');
                            
                            const context = {
                                currentPage: 'IdentifyingInformation.html',
                                action: editMode === 'edit' ? 'edit' : 'new',
                                source: 'mySpecs' // Default source
                            };
                            
                            // If we have a spec ID, include it in the context
                            if (specificationIdentityId) {
                                context.specId = specificationIdentityId;
                                context.specIdentityId = specificationIdentityId;
                            }
                            
                            console.log('DEBUG: Setting context based on localStorage:', context);
                            
                            // Determine source from referrer if no existing context
                            const referrer = document.referrer;
                            if (referrer.includes('eInvoicingSpecificationRegistry.html')) {
                                context.source = 'registry';
                            } else if (referrer.includes('mySpecifications.html')) {
                                context.source = 'mySpecs';
                            }
                            
                            window.breadcrumbManager.setContext(context);
                        }
                        
                        // Initialize data manager and load form data
                        await initializeDataManager();
                        attachFormEventListeners();
                        
                    } catch (error) {
                        console.error('DEBUG: Error during page initialization:', error);
                        // Continue with basic functionality even if some components fail
                    }
                }, 50); // Wait 50ms for DOM to be fully ready
            });

            // Add beforeunload warning for unsaved changes and cleanup
            window.addEventListener('beforeunload', (e) => {
                // Clean up any session elements before leaving
                cleanupSessionNotifications();
                
                // Skip warning if explicitly suppressed (e.g., during save and continue)
                if (suppressBeforeUnload) {
                    console.log('DEBUG: beforeunload - Warning suppressed, allowing navigation');
                    return;
                }
                
                // Warn about unsaved changes only if there are actual changes
                try {
                    if (hasActualChanges()) {
                        console.log('DEBUG: beforeunload - Changes detected, preventing navigation');
                        e.preventDefault();
                        e.returnValue = '';
                    } else {
                        console.log('DEBUG: beforeunload - No changes detected, allowing navigation');
                    }
                } catch (error) {
                    console.error('DEBUG: beforeunload - Error checking for changes:', error);
                    // If there's an error checking for changes, don't prevent navigation
                }
            });

            // Add visibility change handler for cleanup
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    cleanupSessionNotifications();
                }
            });
        </script>
    </body>
</html>