<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
        <link rel="stylesheet" href="../CSS/style.css">
        
        <!-- Add authManager.js for global AuthManager and AUTH_CONFIG -->
        <script src="../JS/auth/authManager.js"></script>
        <script>
            // Create a global authManager instance and enhanced authenticatedFetch
            window.authManager = new AuthManager();
            
            async function authenticatedFetch(url, options = {}) {
                try {
                    const headers = { ...(options.headers || {}), ...window.authManager.getAuthHeaders() };
                    let response = await fetch(url, { ...options, headers });
                    
                    if (response.status === 401) {
                        // Try to refresh the token
                        const refreshed = await window.authManager.refreshToken();
                        if (refreshed) {
                            // Retry with new token
                            const newHeaders = { ...(options.headers || {}), ...window.authManager.getAuthHeaders() };
                            response = await fetch(url, { ...options, headers: newHeaders });
                        } else {
                            // Show re-authentication modal
                            window.authManager.showReAuthModal();
                            throw new Error('Authentication failed');
                        }
                    }
                    
                    return response;
                } catch (error) {
                    console.error('Authenticated fetch error:', error);
                    throw error;
                }
            }
        </script>
        <script src="../JS/sidebarManager.js"></script>
        <script src="../JS/breadcrumbManager.js"></script>
        <script src="../JS/javascript.js"></script>
        <script src="../JS/dataManager.js"></script>
        <script src="../JS/coreInvoiceModel.js"></script>
        <script src="../JS/workflowSessionManager.js"></script>
        
        <title>Registry Services</title>
        
        <style>
            .page-Content 
            {
                font-size: 0.9em;
            }
            .styled-table th,
            .styled-table td 
            {
                padding: 10.8px 13.5px;
                font-size: 0.9em;
            }
            .styled-table thead tr 
            {
                font-size: 1.2em;
            }
            .fa-solid 
            {
                font-size: 1.2em;
            }
            .show-more-btn 
            {
                font-size: 0.95em !important;
                padding: 4px 12px !important;
            }
            .table-container 
            {
                font-size: 0.9em;
            }
            .error-alert {
                background-color: #fee;
                border: 2px solid #dc3545;
                border-radius: 8px;
                padding: 20px;
                margin: 20px 0;
                box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2);
            }
            .error-content {
                display: flex;
                align-items: flex-start;
                gap: 15px;
            }
            .error-content i {
                color: #dc3545;
                font-size: 1.5em;
                margin-top: 2px;
            }
            .error-text {
                flex: 1;
            }
            .error-text strong {
                color: #dc3545;
                font-size: 1.1em;
                display: block;
                margin-bottom: 8px;
            }
            .error-text p {
                margin: 0 0 15px 0;
                color: #721c24;
                line-height: 1.4;
            }
            .error-button {
                background-color: #dc3545;
                color: white;
                border: none;
                padding: 8px 16px;
                border-radius: 4px;
                cursor: pointer;
                font-size: 0.9em;
                transition: background-color 0.2s;
            }
            .error-button:hover {
                background-color: #c82333;
            }
        </style>
    </head>
    <body>
<!----------------------------------------------------------------------------
        Sidebar
  ------------------------------------------------------------------------------>
        <div id="sidebarContainer">
            <!-- Sidebar will be dynamically generated by sidebarManager.js -->
        </div>

<!----------------------------------------------------------------------------
        Main Content
  ------------------------------------------------------------------------------>
        <div class="page-Content">
            <div id="breadcrumbContainer" class="breadcrumb-container">
                <!-- Breadcrumb will be dynamically generated by breadcrumbManager.js -->
            </div>
            
            <!-- Error Alert for Missing Specification ID -->
            <div id="specificationIdError" class="error-alert" style="display: none;">
                <div class="error-content">
                    <i class="fa-solid fa-exclamation-triangle"></i>
                    <div class="error-text">
                        <strong>Error: No Specification ID Found</strong>
                        <p>This page requires a valid specification ID from the previous step. Please return to Identifying Information and save the specification first.</p>
                        <button onclick="navigateToIdentifyingInformation()" class="error-button">Go to Identifying Information</button>
                    </div>
                </div>
            </div>
            
            <h1><i class="fa-solid fa-car"></i> Core Invoice Model</h1>

            <div class="table-container">
                <table id="coreInvoiceTable" class="styled-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Level</th>
                            <th>Cardinality</th>
                            <th>Business Term</th>
                            <th>Usage Note</th>
                            <th>Business Rules</th>
                            <th>Data Type</th>
                            <th>Included in Spec</th>
                            <th>Type of Change</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be populated by JavaScript in coreInvoiceModel.js -->
                    </tbody>
                </table>
            </div>
             <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 30px;">
                <div>
                    <button type="button" onclick="handleCoreInvoiceSave()" class="view-button" style="background:#ccc; color:#333;">Save</button>
                    <button type="button" onclick="handleCancel()" class="view-button" style="background-color: #F4A261; color: #fff;">Cancel</button>
                </div>
                <div>
                    <button type="button" onclick="saveAndGoToExtensionModel()" class="view-button" style="background:#217a36;">Extension Component Data Model</button>
                </div>
            </div>
        </div>
        <script>
            // Note: isFormDirty is deprecated in favor of hasActualChanges()
            // let isFormDirty = false;
            let dataManager = null;
            // Note: window.isFormDirty is deprecated in favor of window.hasActualChanges
            // window.isFormDirty = false;

            // Initialize data manager and load data
            async function initializeDataManager() {
                try {
                    console.log('DEBUG: CoreInvoiceModel - Starting initializeDataManager');
                    console.log('DEBUG: CoreInvoiceModel - LocalStorage state:');
                    console.log('  - editMode:', localStorage.getItem('editMode'));
                    console.log('  - specificationIdentityId:', localStorage.getItem('specificationIdentityId'));
                    
                    dataManager = new SpecificationDataManager();
                    console.log('DEBUG: CoreInvoiceModel - Data manager initialized');
                    console.log('DEBUG: CoreInvoiceModel - Mode:', dataManager.currentMode);
                    console.log('DEBUG: CoreInvoiceModel - CurrentSpecId:', dataManager.currentSpecId);
                    console.log('DEBUG: CoreInvoiceModel - isEditMode():', dataManager.isEditMode());
                    
                    if (dataManager.isEditMode() && dataManager.currentSpecId) {
                        console.log('DEBUG: CoreInvoiceModel - Loading specification for editing. ID:', dataManager.currentSpecId);
                        
                        // Load specification metadata from API if not already loaded
                        if (!dataManager.isDataLoaded) {
                            await dataManager.loadSpecificationFromAPI(dataManager.currentSpecId);
                        }
                        
                        // Load core elements data from dedicated API endpoint
                        try {
                            console.log('DEBUG: CoreInvoiceModel - Loading core elements from API');
                            const coreElementsData = await dataManager.loadCoreElementsFromAPI(
                                dataManager.currentSpecId,
                                1000
                            );
                            
                            console.log('DEBUG: CoreInvoiceModel - Core elements loaded:', coreElementsData);
                            
                            // Update page title with specification name
                            const workingData = dataManager.workingData || dataManager.loadWorkingDataFromLocalStorage();
                            if (workingData && workingData.specName) {
                                updatePageTitle(workingData.specName);
                            }
                            
                            // Load existing selections into UI - store for delayed loading
                            if (coreElementsData && (coreElementsData.selectedIds || coreElementsData.typeOfChangeValues)) {
                                // Store core elements data for UI loading after table is populated
                                window.pendingCoreElementsData = coreElementsData;
                                
                                // Try to load immediately, and set up fallback
                                setTimeout(() => {
                                    loadExistingSelections(coreElementsData);
                                }, 1000);
                            }
                            
                            // Store core elements data in working data for local operations
                            dataManager.saveCoreElementsToLocalStorage(coreElementsData);
                            
                            // Set initial baseline data for change detection
                            // We need to get the current state including cardinality and usage notes
                            // First, set a temporary baseline to prevent errors
                            dataManager.coreElementsData = {
                                selectedIds: coreElementsData.selectedIds || [],
                                typeOfChangeValues: {},
                                cardinalityMap: {},
                                usageNotesMap: {}
                            };
                            console.log('DEBUG: CoreInvoiceModel - Temporary baseline data set during initialization');
                            
                            // Then update with proper baseline after UI is populated
                            setTimeout(() => {
                                updateBaselineData();
                            }, 100); // Small delay to ensure UI is populated
                            
                            return workingData;
                            
                        } catch (coreElementsError) {
                            console.warn('DEBUG: CoreInvoiceModel - Failed to load core elements from API:', coreElementsError);
                            console.log('DEBUG: CoreInvoiceModel - Falling back to localStorage for core elements');
                            
                            // Fallback to localStorage if API call fails
                            const workingData = dataManager.workingData || dataManager.loadWorkingDataFromLocalStorage();
                            if (workingData) {
                                // Update page title with specification name
                                if (workingData.specName) {
                                    updatePageTitle(workingData.specName);
                                }
                                
                                // Load any existing core invoice model selections from localStorage
                                if (workingData.coreInvoiceModelData) {
                                    window.pendingCoreElementsData = workingData.coreInvoiceModelData;
                                    setTimeout(() => {
                                        loadExistingSelections(workingData.coreInvoiceModelData);
                                    }, 1000);
                                    // Set baseline data from localStorage
                                    dataManager.coreElementsData = workingData.coreInvoiceModelData;
                                    console.log('DEBUG: CoreInvoiceModel - Baseline data set from localStorage fallback');
                                } else {
                                    // No existing core elements data - initialize empty baseline
                                    dataManager.coreElementsData = {
                                        selectedIds: [],
                                        typeOfChangeValues: {},
                                        cardinalityMap: {},
                                        usageNotesMap: {}
                                    };
                                    console.log('DEBUG: CoreInvoiceModel - Empty baseline data initialized in fallback');
                                }
                            }
                            
                            return workingData;
                        }
                        
                    } else if (dataManager.currentSpecId) {
                        console.log('DEBUG: CoreInvoiceModel - New specification in stepped process. ID:', dataManager.currentSpecId);
                        
                        // In the stepped process, we have a specification ID but it's newly created
                        // Load specification metadata to get the name for the title
                        try {
                            await dataManager.loadSpecificationFromAPI(dataManager.currentSpecId);
                            const workingData = dataManager.workingData || dataManager.loadWorkingDataFromLocalStorage();
                            
                            if (workingData && workingData.specName) {
                                updatePageTitle(workingData.specName);
                            }
                            
                            // Check if there are any pre-existing core elements selections (unlikely for new specs)
                            if (workingData && workingData.coreInvoiceModelData) {
                                window.pendingCoreElementsData = workingData.coreInvoiceModelData;
                                setTimeout(() => {
                                    loadExistingSelections(workingData.coreInvoiceModelData);
                                }, 1000);
                                // Set baseline data for existing core elements data
                                dataManager.coreElementsData = workingData.coreInvoiceModelData;
                                console.log('DEBUG: CoreInvoiceModel - Baseline data set from localStorage for new spec');
                            } else {                                    // No existing core elements data - initialize empty baseline
                                    dataManager.coreElementsData = {
                                        selectedIds: [],
                                        typeOfChangeValues: {},
                                        cardinalityMap: {},
                                        usageNotesMap: {}
                                    };
                                console.log('DEBUG: CoreInvoiceModel - Empty baseline data initialized for new spec');
                            }
                            
                            return workingData;
                            
                        } catch (loadError) {
                            console.error('DEBUG: CoreInvoiceModel - Failed to load newly created specification:', loadError);
                            // Fall back to localStorage data
                            const workingData = dataManager.loadWorkingDataFromLocalStorage();
                            if (workingData && workingData.specName) {
                                updatePageTitle(workingData.specName);
                            }
                            // Initialize empty baseline for error case
                            dataManager.coreElementsData = {
                                selectedElements: [],
                                selectedIds: [],
                                typeOfChangeValues: {},
                                cardinalityMap: {},
                                usageNotesMap: {}
                            };
                            console.log('DEBUG: CoreInvoiceModel - Empty baseline data initialized for load error case');
                            return workingData;
                        }
                        
                    } else {
                        console.error('DEBUG: CoreInvoiceModel - No specification ID found! This violates the stepped process.');
                        console.log('DEBUG: CoreInvoiceModel - isEditMode:', dataManager.isEditMode());
                        console.log('DEBUG: CoreInvoiceModel - currentSpecId:', dataManager.currentSpecId);
                        
                        // Show error alert and disable save functionality
                        showSpecificationIdError();
                        
                        // For debugging, still try to load from localStorage
                        const workingData = dataManager.loadWorkingDataFromLocalStorage();
                        if (workingData && workingData.specName) {
                            updatePageTitle(workingData.specName + " (No Spec ID)");
                        }
                        
                        // Initialize empty baseline for no spec ID case
                        dataManager.coreElementsData = {
                            selectedElements: [],
                            selectedIds: [],
                            typeOfChangeValues: {},
                            cardinalityMap: {},
                            usageNotesMap: {}
                        };
                        console.log('DEBUG: CoreInvoiceModel - Empty baseline data initialized for no spec ID case');
                        
                        return workingData;
                    }
                } catch (error) {
                    console.error('DEBUG: CoreInvoiceModel - Error initializing data manager:', error);
                    alert(`Error loading specification: ${error.message}`);
                }
            }

            function updatePageTitle(specificationName) {
                const pageTitle = document.querySelector('h1');
                if (pageTitle && specificationName) {
                    pageTitle.innerHTML = `<i class="fa-solid fa-trailer"></i> Core Invoice Model - ${specificationName}`;
                }
            }

            function showSpecificationIdError() {
                console.log('DEBUG: CoreInvoiceModel - Showing specification ID error');
                
                // Show the error alert
                const errorAlert = document.getElementById('specificationIdError');
                if (errorAlert) {
                    errorAlert.style.display = 'block';
                }
                
                // Disable the save button and show it as disabled
                const saveButton = document.querySelector('button[onclick="handleCoreInvoiceSave()"]');
                if (saveButton) {
                    saveButton.disabled = true;
                    saveButton.style.opacity = '0.5';
                    saveButton.style.cursor = 'not-allowed';
                    saveButton.textContent = 'Save (Disabled - No Spec ID)';
                }
                
                // Also disable the "Extension Component Data Model" button
                const nextButton = document.querySelector('button[onclick="saveAndGoToExtensionModel()"]');
                if (nextButton) {
                    nextButton.disabled = true;
                    nextButton.style.opacity = '0.5';
                    nextButton.style.cursor = 'not-allowed';
                    nextButton.textContent = 'Next Step (Disabled - No Spec ID)';
                }
            }

            function navigateToIdentifyingInformation() {
                console.log('DEBUG: CoreInvoiceModel - Navigating to Identifying Information');
                
                // Note: No need to clear isFormDirty anymore since we use hasActualChanges()
                
                // Store return page for navigation back
                localStorage.setItem('returnToPage', 'coreInvoiceModel.html');
                
                // Navigate to identifying information
                window.location.href = 'IdentifyingInformation.html';
            }

            function loadExistingSelections(coreInvoiceModelData) {
                console.log('DEBUG: CoreInvoiceModel - Loading existing selections:', coreInvoiceModelData);
                
                if (!coreInvoiceModelData) {
                    console.log('DEBUG: CoreInvoiceModel - No core invoice model data to load');
                    return;
                }
                
                // Handle different data formats
                let selectedIds = [];
                let typeOfChangeValues = {};
                
                if (Array.isArray(coreInvoiceModelData)) {
                    // Legacy array format
                    selectedIds = coreInvoiceModelData;
                } else if (coreInvoiceModelData.selectedIds) {
                    // Object format with selectedIds
                    selectedIds = coreInvoiceModelData.selectedIds || [];
                    typeOfChangeValues = coreInvoiceModelData.typeOfChangeValues || {};
                }
                
                console.log('DEBUG: CoreInvoiceModel - Processing selectedIds:', selectedIds);
                console.log('DEBUG: CoreInvoiceModel - Processing typeOfChangeValues:', typeOfChangeValues);
                
                // Apply selections
                const applySelections = () => {
                    let appliedCount = 0;
                    
                    // Apply checkbox selections
                    selectedIds.forEach(businessTermID => {
                        const checkbox = document.querySelector(`input.row-selector[data-id="${businessTermID}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                            appliedCount++;
                        } else {
                            console.warn(`DEBUG: CoreInvoiceModel - Checkbox not found for ${businessTermID}`);
                        }
                    });
                    
                    // Apply dropdown selections
                    Object.keys(typeOfChangeValues).forEach(businessTermID => {
                        const dropdown = document.querySelector(`select.type-of-change-dropdown[data-id="${businessTermID}"]`);
                        if (dropdown) {
                            dropdown.value = typeOfChangeValues[businessTermID];
                        } else {
                            console.warn(`DEBUG: CoreInvoiceModel - Dropdown not found for ${businessTermID}`);
                        }
                    });
                    
                    console.log(`DEBUG: CoreInvoiceModel - Applied ${appliedCount} checkbox selections`);
                    
                    // Update baseline data after selections are applied
                    if (appliedCount > 0 || selectedIds.length === 0) {
                        setTimeout(() => {
                            updateBaselineData();
                        }, 100);
                    }
                    
                    return appliedCount > 0 || selectedIds.length === 0;
                };
                
                // Try to apply selections immediately
                if (!applySelections()) {
                    // If table not ready, wait and try again
                    console.log('DEBUG: CoreInvoiceModel - Table not ready, waiting...');
                    setTimeout(() => {
                        if (applySelections()) {
                            updateBaselineData();
                        }
                    }, 2000);
                }
            }

            // Function to update baseline data after UI is populated
            function updateBaselineData() {
                try {
                    const currentSelections = collectCoreElementsSelections();
                    dataManager.coreElementsData = currentSelections;
                    console.log('DEBUG: CoreInvoiceModel - Baseline data updated after UI population:', currentSelections);
                    console.log('DEBUG: CoreInvoiceModel - Baseline selectedIds count:', currentSelections.selectedIds.length);
                    console.log('DEBUG: CoreInvoiceModel - Baseline has cardinalityMap:', !!currentSelections.cardinalityMap);
                    console.log('DEBUG: CoreInvoiceModel - Baseline has usageNotesMap:', !!currentSelections.usageNotesMap);
                } catch (error) {
                    console.error('DEBUG: CoreInvoiceModel - Error updating baseline data:', error);
                }
            }

            document.addEventListener('DOMContentLoaded', async () => {
                console.log('DEBUG: CoreInvoiceModel - DOM loaded, initializing data manager');
                
                // Initialize data manager
                const workingData = await initializeDataManager();
                
                // Legacy compatibility - for any remaining code that might need this
                if (workingData && workingData.specName) {
                    localStorage.setItem("selectedSpecification", workingData.specName);
                }
            });
                    
            // Event listeners for form changes
            // Set up event listeners for the table when DOM is ready
            setTimeout(() => {
                const tableElement = document.querySelector('#coreInvoiceTable');
                if (tableElement) {
                    tableElement.addEventListener('change', (event) => {
                        if (event.target.matches('.row-selector:not(:disabled)') || event.target.matches('.type-of-change-dropdown')) {
                            console.log('DEBUG: Form element changed, updating save button appearance');
                            // Don't set isFormDirty anymore - rely on hasActualChanges()
                            updateSaveButtonAppearance(); // Update save button appearance when form changes
                            
                            // Auto-check "Included in Spec" when dropdown changes to anything other than "No change"
                            if (event.target.matches('.type-of-change-dropdown')) {
                                const dropdown = event.target;
                                const itemId = dropdown.getAttribute('data-id');
                                const selectedValue = dropdown.value;
                                
                                // Find the corresponding checkbox for this item
                                const checkbox = document.querySelector(`.row-selector[data-id="${itemId}"]`);
                                if (checkbox) {
                                    // Auto-check if user selects anything other than "No change"
                                    if (selectedValue !== "No change") {
                                        checkbox.checked = true;
                                    }
                                    // Note: When changing back to "No change", checkbox remains checked (per requirement #3)
                                }
                            }
                            
                            // Handle cascading selection for BG items
                            if (event.target.matches('.row-selector')) {
                                const checkbox = event.target;
                                
                                // Use the global cascading function if available
                                if (window.handleCascadingSelection) {
                                    window.handleCascadingSelection(checkbox);
                                }
                            }
                        }
                    });
                }
            }, 500); // Wait for table to be populated

            window.addEventListener('beforeunload', (e) => {
                const actualChanges = hasActualChanges();
                console.log('DEBUG: beforeunload triggered - hasActualChanges():', actualChanges);
                console.log('DEBUG: beforeunload triggered - using hasActualChanges() for decision');
                
                if (actualChanges) {
                    console.log('DEBUG: beforeunload - preventing navigation due to actual changes');
                    e.preventDefault();
                    e.returnValue = '';
                } else {
                    console.log('DEBUG: beforeunload - allowing navigation, no actual changes detected');
                }
            });

            // Enhanced change detection functions
            function hasActualChanges() {
                console.log('DEBUG: hasActualChanges() called');
                
                if (!dataManager || !dataManager.coreElementsData) {
                    console.log('DEBUG: hasActualChanges() - No baseline data available');
                    console.log('DEBUG: hasActualChanges() - dataManager exists:', !!dataManager);
                    console.log('DEBUG: hasActualChanges() - dataManager.coreElementsData exists:', !!(dataManager && dataManager.coreElementsData));
                    return true; // If no baseline data, assume changes exist
                }
                
                const currentData = collectCoreElementsSelections();
                const originalData = dataManager.coreElementsData;
                
                console.log('DEBUG: hasActualChanges() - Current data:', currentData);
                console.log('DEBUG: hasActualChanges() - Baseline data:', originalData);
                console.log('DEBUG: hasActualChanges() - Baseline selectedIds count:', originalData.selectedIds ? originalData.selectedIds.length : 'N/A');
                
                // Compare selected elements
                if (currentData.selectedIds.length !== originalData.selectedIds.length) {
                    console.log('DEBUG: hasActualChanges() - Different number of selected elements:', currentData.selectedIds.length, 'vs', originalData.selectedIds.length);
                    return true;
                }
                
                // Check if same elements are selected
                const currentSet = new Set(currentData.selectedIds);
                const originalSet = new Set(originalData.selectedIds);
                for (const element of currentSet) {
                    if (!originalSet.has(element)) {
                        console.log('Change detected: New element selected:', element);
                        return true;
                    }
                }
                for (const element of originalSet) {
                    if (!currentSet.has(element)) {
                        console.log('Change detected: Element deselected:', element);
                        return true;
                    }
                }
                
                // Compare cardinality and usage note changes
                if (originalData.cardinalityMap && originalData.usageNotesMap && 
                    currentData.cardinalityMap && currentData.usageNotesMap) {
                    for (const elementId of currentData.selectedIds) {
                        if (currentData.cardinalityMap[elementId] !== originalData.cardinalityMap[elementId]) {
                            console.log(`DEBUG: hasActualChanges() - Change detected in cardinality for ${elementId}: "${originalData.cardinalityMap[elementId]}" -> "${currentData.cardinalityMap[elementId]}"`);
                            return true;
                        }
                        if (currentData.usageNotesMap[elementId] !== originalData.usageNotesMap[elementId]) {
                            console.log(`DEBUG: hasActualChanges() - Change detected in usage notes for ${elementId}`);
                            return true;
                        }
                    }
                } else {
                    console.log('DEBUG: hasActualChanges() - Missing cardinality or usage note maps, skipping detailed comparison');
                }
                
                console.log('DEBUG: hasActualChanges() - No changes detected, returning false');
                return false;
            }

            // Make hasActualChanges globally accessible for breadcrumb manager
            window.hasActualChanges = hasActualChanges;

            function getChangedFields() {
                if (!dataManager || !dataManager.coreElementsData) return [];
                
                const currentData = collectCoreElementsSelections();
                const originalData = dataManager.coreElementsData;
                const changedFields = [];
                
                // Check for selection changes
                const currentSet = new Set(currentData.selectedIds);
                const originalSet = new Set(originalData.selectedIds);
                
                // New selections
                for (const element of currentSet) {
                    if (!originalSet.has(element)) {
                        changedFields.push({
                            field: element,
                            displayName: `Element: ${element}`,
                            oldValue: 'Not selected',
                            newValue: 'Selected'
                        });
                    }
                }
                
                // Removed selections
                for (const element of originalSet) {
                    if (!currentSet.has(element)) {
                        changedFields.push({
                            field: element,
                            displayName: `Element: ${element}`,
                            oldValue: 'Selected',
                            newValue: 'Not selected'
                        });
                    }
                }
                
                // Cardinality and usage note changes
                if (originalData.cardinalityMap && originalData.usageNotesMap && 
                    currentData.cardinalityMap && currentData.usageNotesMap) {
                    for (const elementId of currentData.selectedIds) {
                        if (currentData.cardinalityMap[elementId] !== originalData.cardinalityMap[elementId]) {
                            changedFields.push({
                                field: `${elementId}_cardinality`,
                                displayName: `${elementId} - Cardinality`,
                                oldValue: originalData.cardinalityMap[elementId] || '',
                                newValue: currentData.cardinalityMap[elementId] || ''
                            });
                        }
                        if (currentData.usageNotesMap[elementId] !== originalData.usageNotesMap[elementId]) {
                            changedFields.push({
                                field: `${elementId}_notes`,
                                displayName: `${elementId} - Usage Notes`,
                                oldValue: originalData.usageNotesMap[elementId] || '',
                                newValue: currentData.usageNotesMap[elementId] || ''
                            });
                        }
                    }
                } else {
                    console.log('DEBUG: getChangedFields() - Missing cardinality or usage note maps, skipping detailed comparison');
                    console.log('DEBUG: originalData.cardinalityMap:', !!originalData.cardinalityMap);
                    console.log('DEBUG: originalData.usageNotesMap:', !!originalData.usageNotesMap);
                    console.log('DEBUG: currentData.cardinalityMap:', !!currentData.cardinalityMap);
                    console.log('DEBUG: currentData.usageNotesMap:', !!currentData.usageNotesMap);
                }
                
                return changedFields;
            }

            function updateSaveButtonAppearance() {
                const saveButton = document.querySelector('button[onclick="handleCoreInvoiceSave()"]');
                const hasChanges = hasActualChanges();
                
                if (saveButton) {
                    if (hasChanges) {
                        saveButton.style.background = '#28a745'; // Green when changes exist
                        saveButton.style.fontWeight = 'bold';
                        saveButton.style.boxShadow = '0 2px 4px rgba(40, 167, 69, 0.3)';
                    } else {
                        saveButton.style.background = '#6c757d'; // Gray when no changes
                        saveButton.style.fontWeight = 'normal';
                        saveButton.style.boxShadow = 'none';
                    }
                }
            }

            async function handleCoreInvoiceSave(showAlert = true, allowNavigationWithoutChanges = false) {
                console.log('DEBUG: CoreInvoiceModel - handleCoreInvoiceSave called');
                
                if (!dataManager) {
                    console.error('DEBUG: CoreInvoiceModel - Data manager not initialized');
                    alert("Error: Data manager not initialized.");
                    return;
                }

                // Check if specification ID is available
                if (!dataManager.currentSpecId) {
                    console.error('DEBUG: CoreInvoiceModel - No specification ID found! Cannot save.');
                    alert("Error: No specification ID found. Please return to Identifying Information and save the specification first.");
                    return;
                }

                // Check if there are actual changes
                const changedFields = getChangedFields();
                
                if (changedFields.length === 0) {
                    // If this is for navigation and no changes are detected, allow proceeding
                    if (allowNavigationWithoutChanges) {
                        console.log('DEBUG: CoreInvoiceModel - No changes detected, but allowing navigation');
                        return;
                    }
                    
                    // Update save button appearance since no actual changes exist
                    console.log('DEBUG: CoreInvoiceModel - No changes detected, updating save button appearance');
                    updateSaveButtonAppearance();
                    
                    // Show "no changes" modal only for direct save attempts
                    const modalHtml = `
                        <div id="noChangesModal" style="
                            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                            background: rgba(0,0,0,0.5); z-index: 1002; display: flex;
                            align-items: center; justify-content: center;">
                            <div style="
                                background: white; border-radius: 8px; padding: 24px; max-width: 400px;
                                width: 90%; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                                <h3 style="margin: 0 0 16px 0; color: #333;">
                                    <i class="fa-solid fa-info-circle" style="color: #17a2b8; margin-right: 8px;"></i>
                                    No Changes Detected
                                </h3>
                                <p style="margin: 0 0 20px 0; color: #666;">
                                    There are no unsaved changes to your core invoice model selections. The current selections match the last saved version.
                                </p>
                                <div style="text-align: center;">
                                    <button onclick="document.getElementById('noChangesModal').remove()" style="
                                        padding: 8px 16px; background: #17a2b8; color: white; border: none;
                                        border-radius: 4px; cursor: pointer; font-size: 14px;">
                                        OK
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.body.insertAdjacentHTML('beforeend', modalHtml);
                    return;
                }

                // Save directly without confirmation modal
                console.log('DEBUG: CoreInvoiceModel - Proceeding with save operation');
                
                // Define originalButtonText at function scope so it's available in finally block
                let originalButtonText = '';
                const saveButton = document.querySelector('button[onclick="handleCoreInvoiceSave()"]');
                
                try {
                    // Show saving indicator
                    originalButtonText = saveButton ? saveButton.innerHTML : 'Save';
                    if (saveButton) {
                        saveButton.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
                        saveButton.disabled = true;
                    }

                    // Collect core elements selections
                    const coreElementsData = collectCoreElementsSelections();
                    
                    console.log('DEBUG: CoreInvoiceModel - Collected core elements data:', coreElementsData);
                console.log('DEBUG: CoreInvoiceModel - Sample cardinality values:', Object.keys(coreElementsData.cardinalityMap).slice(0, 5).map(id => ({id, cardinality: coreElementsData.cardinalityMap[id]})));

                    // Always save to localStorage for navigation and working data
                    dataManager.saveCoreElementsToLocalStorage(coreElementsData);
                    console.log('DEBUG: CoreInvoiceModel - Core elements saved to localStorage');
                    
                    // CoreInvoiceModel.html always has a valid specificationID from the previous step
                    // (IdentifyingInformation.html creates the specification and returns the ID)
                    console.log('DEBUG: CoreInvoiceModel - Performing simplified save to API for specification:', dataManager.currentSpecId);
                    
                    try {
                        console.log('DEBUG: CoreInvoiceModel - Starting API save operation');
                        console.log('DEBUG: CoreInvoiceModel - Specification ID:', dataManager.currentSpecId);
                        console.log('DEBUG: CoreInvoiceModel - Edit mode?', dataManager.isEditMode());
                        console.log('DEBUG: CoreInvoiceModel - Data to save:', coreElementsData);
                        
                        const saveResults = await dataManager.saveCoreElementsSimplified(
                            dataManager.currentSpecId, 
                            coreElementsData
                        );
                        
                        console.log('DEBUG: CoreInvoiceModel - Simplified save completed:', saveResults);
                        
                        let successMessage = "Core Invoice Model selections saved successfully!";
                        
                        if (saveResults.deletedCount > 0) {
                            successMessage += `\n• Cleared ${saveResults.deletedCount} existing selections`;
                        }
                        
                        if (saveResults.addedCount > 0) {
                            successMessage += `\n• Added ${saveResults.addedCount} core elements`;
                        }
                        
                        if (coreElementsData.selectedIds.length === 0) {
                            if (saveResults.deletedCount > 0) {
                                successMessage = `Core Invoice Model cleared - ${saveResults.deletedCount} elements removed.`;
                            } else {
                                successMessage = "Core Invoice Model cleared - no elements selected.";
                            }
                        }
                        
                        // Success - reload saved elements to update workingData for potential next save
                        try {
                            const updatedCoreElementsData = await dataManager.loadCoreElementsFromAPI(
                                dataManager.currentSpecId,
                                1000
                            );
                            dataManager.saveCoreElementsToLocalStorage(updatedCoreElementsData);
                            // Update baseline data to match the current UI state (which includes cardinality and usage notes)
                            updateBaselineData();
                            console.log('DEBUG: CoreInvoiceModel - Baseline data updated after reload from API');
                        } catch (reloadError) {
                            console.warn('DEBUG: CoreInvoiceModel - Failed to reload core elements after save:', reloadError);
                            // Non-critical error - the save was successful, just update failed
                            // Keep the baseline as the current UI state (saved data)
                            updateBaselineData();
                            console.log('DEBUG: CoreInvoiceModel - Using current UI state as baseline after reload failure');
                        }
                        
                    } catch (apiError) {
                        console.error('DEBUG: CoreInvoiceModel - Failed to save to API:', apiError);
                        
                        // Show detailed error message
                        let errorMessage = `Failed to save to server: ${apiError.message}`;
                        
                        if (apiError.message.includes('400')) {
                            errorMessage += '\n\nThis may be due to invalid data. Please check your selections.';
                        } else if (apiError.message.includes('403')) {
                            errorMessage += '\n\nYou do not have permission to modify this specification.';
                        } else if (apiError.message.includes('404')) {
                            errorMessage += '\n\nThe specification was not found. It may have been deleted.';
                        }
                        
                        alert(errorMessage);
                        return; // Don't proceed if API save failed
                    }
                        
                        console.log('DEBUG: CoreInvoiceModel - Save completed successfully');
                        
                        if (showAlert) {
                            alert("Core Invoice Model saved successfully!");
                        }
                        
                        // Update save button appearance after successful save
                        updateSaveButtonAppearance();
                        
                } catch (error) {
                    console.error('DEBUG: CoreInvoiceModel - Error in handleCoreInvoiceSave:', error);
                    alert("Error saving Core Invoice Model: " + error.message);
                } finally {
                    // Restore save button
                    const saveButton = document.querySelector('button[onclick="handleCoreInvoiceSave()"]');
                    if (saveButton) {
                        saveButton.innerHTML = originalButtonText || 'Save';
                        saveButton.disabled = false;
                    }
                }
            }

            function collectCoreElementsSelections() {
                const selectedIds = [];
                const typeOfChangeValues = {};
                const cardinalityMap = {};
                const usageNoteMap = {};
                
                // Collect selected checkboxes
                document.querySelectorAll('.row-selector:checked').forEach(checkbox => {
                    const businessTermID = checkbox.getAttribute('data-id');
                    if (businessTermID) {
                        selectedIds.push(businessTermID);
                        
                        // Get cardinality and usage note from the table row
                        const row = checkbox.closest('tr');
                        if (row) {
                            const cells = row.cells;
                            // Column order: ID, Level, Cardinality, Business Term, Usage Note, Business Rules, Data Type, Included in Spec, Type of Change, Actions
                            if (cells[2]) { // Cardinality column (index 2)
                                const cardinality = cells[2].textContent.trim();
                                cardinalityMap[businessTermID] = cardinality || '0..1'; // Fallback to common cardinality
                            } else {
                                cardinalityMap[businessTermID] = '0..1'; // Default fallback
                            }
                            if (cells[4]) { // Usage Note column (index 4)
                                usageNoteMap[businessTermID] = cells[4].textContent.trim();
                            }
                        }
                    }
                });

                // Collect type of change dropdown values
                document.querySelectorAll('.type-of-change-dropdown').forEach(dropdown => {
                    const businessTermID = dropdown.getAttribute('data-id');
                    const value = dropdown.value;
                    if (businessTermID && value) {
                        typeOfChangeValues[businessTermID] = value;
                    }
                });

                return { 
                    selectedIds, 
                    typeOfChangeValues,
                    cardinalityMap,
                    usageNotesMap: usageNoteMap  // Renamed for consistency
                };
            }

            async function saveAndGoToExtensionModel() {
                console.log("saveAndGoToExtensionModel() called");
                try {
                    await handleCoreInvoiceSave(false, true); // Don't show alert, allow navigation without changes
                    console.log("Save completed, navigating to ExtensionComponentDataModel.html");
                    // Update breadcrumb context for next page
                    const context = window.breadcrumbManager.getContext();
                    if (context) {
                        context.currentPage = 'ExtensionComponentDataModel.html';
                        window.breadcrumbManager.updateContext(context);
                    }
                    window.location.href = 'ExtensionComponentDataModel.html';
                } catch (error) {
                    console.error("Error in saveAndGoToExtensionModel:", error);
                    alert("Error saving data: " + error.message);
                }
            }

            function handleCancel() {
                if (hasActualChanges() && !confirm("You have unsaved changes. Are you sure you want to cancel?")) {
                    return;
                }
                
                // Clear editing state
                if (dataManager) {
                    dataManager.clearEditingState();
                }
                
                // Smart navigation: return to calling page or default to mySpecifications.html
                let targetPage = 'mySpecifications.html'; // Default fallback
                
                try {
                    // 1. Check if there's a stored return page in localStorage
                    const storedReturnPage = localStorage.getItem('returnToPage');
                    console.log('handleCancel: Stored return page:', storedReturnPage);
                    
                    if (storedReturnPage) {
                        targetPage = storedReturnPage;
                        localStorage.removeItem('returnToPage'); // Clean up after use
                        console.log('handleCancel: Using stored return page:', targetPage);
                    }
                    // 2. Otherwise, try to use document.referrer
                    else if (document.referrer) {
                        console.log('handleCancel: Document referrer:', document.referrer);
                        const referrerUrl = new URL(document.referrer);
                        const referrerPage = referrerUrl.pathname.split('/').pop();
                        console.log('handleCancel: Extracted referrer page:', referrerPage);
                        
                        // Only navigate back to valid registry pages, avoid loops
                        const validPages = [
                            'mySpecifications.html', 
                            'eInvoicingSpecificationRegistry.html',
                            'IdentifyingInformation.html',
                            'viewSpecification.html',
                            'specificationPreview.html'
                        ];
                        
                        if (validPages.includes(referrerPage) && referrerPage !== 'coreInvoiceModel.html') {
                            targetPage = referrerPage;
                            console.log('handleCancel: Using valid referrer page:', targetPage);
                        } else {
                            console.log('handleCancel: Referrer page not valid or is self, using default');
                        }
                    } else {
                        console.log('handleCancel: No referrer available, using default');
                    }
                    
                    console.log('handleCancel: Final target page:', targetPage);
                    window.location.href = targetPage;
                    
                } catch (error) {
                    console.warn('handleCancel: Error determining return page, using default:', error);
                    window.location.href = 'mySpecifications.html';
                }
            }
        </script>
        
        <script>
            // Initialize the sidebar and authentication when the page loads
            document.addEventListener('DOMContentLoaded', function() {
                // Initialize auth manager
                window.authManager.init();
                
                // Initialize session manager for this workflow step
                if (window.WorkflowSessionManager) {
                    window.sessionManager = new WorkflowSessionManager('coreInvoiceModel');
                    window.sessionManager.init();
                }
                
                // Initialize sidebar
                window.sidebarManager.initializeSidebar(window.authManager);
                
                // Initialize breadcrumb system
                window.breadcrumbManager.init();
                
                // Set breadcrumb context for this page
                const editingSpecId = localStorage.getItem("selectedSpecification");
                if (editingSpecId) {
                    const context = {
                        currentPage: 'coreInvoiceModel.html',
                        specId: editingSpecId,
                        action: editingSpecId === 'new' ? 'new' : 'edit'
                    };
                    
                    // Determine source from referrer or default to 'mySpecs'
                    const referrer = document.referrer;
                    if (referrer.includes('eInvoicingSpecificationRegistry.html')) {
                        context.source = 'registry';
                    } else if (referrer.includes('mySpecifications.html')) {
                        context.source = 'mySpecs';
                    } else {
                        // Default to mySpecs if no clear referrer
                        context.source = 'mySpecs';
                    }
                    
                    window.breadcrumbManager.setContext(context);
                }
            });
        </script>
        
    </body>
</html>