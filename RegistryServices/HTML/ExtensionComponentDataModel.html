<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <link rel="stylesheet" href="../CSS/style.css">
        
        <script src="../JS/javascript.js"></script>
        
        <title>Registry Services</title>
        <style>
            .component-section {
                border: 1px solid #ddd;
                padding: 15px;
                margin-bottom: 20px;
                background-color: #fff;
                border-radius: 5px;
            }
        </style>
    </head>
    <body>
        <div class="sidebar">
            <ul>
                <li>
                    <a class="logo">
                        <span class="icon">
                            <img src="../Images/genericLogo.png" alt="Sidebar Logo" style="width: 40px; height: 40px;">
                        </span>
                        <span class="text">Registry Services</span>
                    </a>
                </li>
                <li>
                    <a href="eInvoicingSpecificationRegistry.html">
                        <span class="icon"><i class="fa-solid fa-house"></i></span>
                        <span class="text">eInvoicing Specification Registry</span>
                    </a>
                </li>
                <li class="protected">
                    <a href="governingEntityList.html">
                        <span class="icon"><i class="fa-solid fa-building"></i></span>
                        <span class="text">Governing Entities</span>
                    </a>
                </li>
                <li class="protected">
                    <a href="mySpecifications.html">
                        <span class="icon"><i class="fa-solid fa-folder"></i></span>
                        <span class="text">My Specifications</span>
                    </a>
                </li>
                <li class="protected">
                    <a href="#">
                        <span class="icon"><i class="fa-solid fa-file-medical"></i></span>
                        <span class="text">Add New Specification</span>
                    </a>
                </li class="protected">
                <li class="child-element protected">
                    <a href="IdentifyingInformation.html">
                        <span class="icon"><i class="fa-solid fa-info"></i></span>
                        <span class="text">Identifying Information</span>
                    </a>
                </li>
                <li class="child-element">
                    <a href="coreInvoiceModel.html">
                        <span class="icon"><i class="fa-solid fa-car"></i></span>
                        <span class="text">Core Invoice Model</span>
                    </a>
                </li>
                <li class="child-element">
                    <a href="ExtensionComponentDataModel.html">
                        <span class="icon"><i class="fa-solid fa-trailer"></i></span>
                        <span class="text">Extension Component Data Model</span>
                    </a>
                </li>
                <li class="child-element protected">
                    <a href="additionalRequirements.html">
                        <span class="icon"><i class="fa-solid fa-circle-plus"></i></span>
                        <span class="text">Additional Requirements</span>
                    </a>
                </li>
                <li class="child-element protected">
                    <a href="SpecificationPreview.html">
                        <span class="icon"><i class="fa-solid fa-square-check"></i></span>
                        <span class="text">Specification Preview</span>
                    </a>
                </li>
                <li id="loginLogoutItem">
                    <a href="#" onclick="toggleLogin()">
                        <span class="icon"><i class="fa-solid fa-right-from-bracket"></i></span>
                        <span class="text" id="loginLogoutButton">Logout</span>
                    </a>
                </li>
            </ul>
        </div>

        <div class="page-Content">
            <h1><i class="fa-solid fa-trailer"></i> Extension Component Data Model</h1>
            <br/>
            
            <div id="components-container"></div>

            <button type="button" onclick="addNewComponentSection()" class="view-button" style="margin-top: 15px;">Add Another Extension Component</button>

            <hr style="margin: 30px 0;">

            <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 10px;">
                <div>
                    <button type="button" onclick="handleSave()" class="view-button" style="background:#ccc; color:#333;">Save</button>
                    <button type="button" onclick="handleCancel()" class="view-button" style="background-color: #F4A261; color: #fff;">Cancel</button>
                </div>
                <div>
                    <button type="button" onclick="saveAndGoToNextStep()" class="view-button" style="background:#217a36;">Additional Requirements</button>
                </div>
            </div>
        </div>

        <script>
            let isFormDirty = false;
            let extensionComponentData = {};
            let componentsContainer;

            async function loadExtensionData() {
                try {
                    const response = await fetch('../JSON/extensionComponentModelElements.json');
                    const data = await response.json();
                    
                    data.forEach(item => {
                        const componentName = item.Component;
                        if (!extensionComponentData[componentName]) {
                            extensionComponentData[componentName] = { elements: [] };
                        }
                        extensionComponentData[componentName].elements.push(item);
                    });

                    const editingSpecName = localStorage.getItem("selectedSpecification");
                    let savedExtensions = [];
                    if (editingSpecName) {
                        const specifications = JSON.parse(localStorage.getItem("specifications")) || [];
                        const specToEdit = specifications.find(spec => spec.specName === editingSpecName);
                        if (specToEdit && specToEdit.extensionComponents) {
                            savedExtensions = specToEdit.extensionComponents;
                        }
                    }

                    if (savedExtensions.length > 0) {
                        savedExtensions.forEach(savedExt => {
                            addNewComponentSection(savedExt.componentName, savedExt.selectedElements);
                        });
                    } else {
                        addNewComponentSection();
                    }

                } catch (error) {
                    console.error("Error loading extension component data:", error);
                }
            }

            function addNewComponentSection(selectedComponent = '', selectedIds = []) {
                const sectionId = `section-${Date.now()}`;
                const section = document.createElement('div');
                section.className = 'component-section';
                section.id = sectionId;

                let options = '<option value="">Select an Extension Component</option>';
                for (const key in extensionComponentData) {
                    options += `<option value="${key}" ${key === selectedComponent ? 'selected' : ''}>${key}</option>`;
                }

                section.innerHTML = `
                    <select class="component-select" onchange="populateComponentTable(this, [])">${options}</select>
                    <p style="margin-top: 5px;">Select the required Extension Component and tick the box for all required elements</p>
                    <table class="styled-table" style="width:100%;">
                        <thead>
                            <tr>
                                <th>ID</th><th>Level</th><th>Cardinality</th><th>Business Term</th><th>Usage Note</th>
                                <th>Justification</th><th>Data Type</th><th>Type of Extension</th>
                                <th>Core Conformant /Rules broken</th><th>Included in Spec</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="10" style="text-align:center;">Please select a component from the dropdown.</td></tr>
                        </tbody>
                    </table>
                    <button onclick="document.getElementById('${sectionId}').remove(); isFormDirty=true;" class="view-button" style="margin-top: 10px; background: #dc3545;">Remove Selection</button>
                `;
                componentsContainer.appendChild(section);

                if (selectedComponent) {
                    populateComponentTable(section.querySelector('.component-select'), selectedIds);
                }
            }

            function populateComponentTable(selectElement, selectedIds = []) {
                const selectedValue = selectElement.value;
                const tableBody = selectElement.closest('.component-section').querySelector('tbody');

                if (!selectedValue) {
                    tableBody.innerHTML = '<tr><td colspan="10" style="text-align:center;">Please select a component.</td></tr>';
                    return;
                }

                const component = extensionComponentData[selectedValue];
                tableBody.innerHTML = '';
                component.elements.forEach(el => {
                    const row = document.createElement('tr');
                    const isChecked = selectedIds.includes(el.ID);
                    row.innerHTML = `
                        <td>${el.ID}</td><td>${el.Level}</td><td>${el.Cardinality}</td>
                        <td>${el['Business Term']}<i class="fa-solid fa-circle-question" title="${el['Usage Note']}"></i></td>
                        <td>${el['Usage Note']}</td><td>${el.Justification}</td><td>${el['Data Type']}</td>
                        <td>${el['Type of Extension']}</td><td>${el['Core Conformant/Rules broken']}</td>
                        <td style="text-align:center;"><input type="checkbox" class="element-selector" data-id="${el.ID}" ${isChecked ? 'checked' : ''} onchange="isFormDirty=true;"></td>
                    `;
                    tableBody.appendChild(row);
                });
            }

            function handleSave(showAlert = true) {
                const selectedExtensions = [];
                document.querySelectorAll('.component-section').forEach(section => {
                    const componentName = section.querySelector('.component-select').value;
                    if (componentName) {
                        const selectedElements = [];
                        section.querySelectorAll('.element-selector:checked').forEach(checkbox => {
                            selectedElements.push(checkbox.getAttribute('data-id'));
                        });
                        if (selectedElements.length > 0) {
                             selectedExtensions.push({ componentName, selectedElements });
                        }
                    }
                });

                const editingSpecName = localStorage.getItem("selectedSpecification");
                if (!editingSpecName) { alert("Error: No specification selected."); return; }

                let specifications = JSON.parse(localStorage.getItem("specifications")) || [];
                const specIndex = specifications.findIndex(spec => spec.specName === editingSpecName);

                if (specIndex > -1) {
                    specifications[specIndex].extensionComponents = selectedExtensions;
                    localStorage.setItem('specifications', JSON.stringify(specifications));
                    if (showAlert) alert("Extension components saved!");
                    isFormDirty = false;
                } else {
                    alert("Error: Could not find the specification to save to.");
                }
            }

            function handleCancel() {
                if (isFormDirty && !confirm("You have unsaved changes. Are you sure you want to cancel?")) {
                    return;
                }
                isFormDirty = false;
                window.location.href = 'mySpecifications.html';
            }

            function saveAndGoToNextStep() {
                handleSave(false);
                window.location.href = 'additionalRequirements.html';
            }

            document.addEventListener('DOMContentLoaded', () => {
                const editingSpecName = localStorage.getItem("selectedSpecification");
                if (editingSpecName) {
                    const titleElement = document.querySelector('.page-Content h1');
                    if (titleElement) {
                        titleElement.innerHTML = `<i class="fa-solid fa-trailer"></i> Extension Component Data Model for: ${editingSpecName}`;
                    }
                }
                
                componentsContainer = document.getElementById('components-container');
                loadExtensionData();

                componentsContainer.addEventListener('change', () => { isFormDirty = true; });
            });

            window.addEventListener('beforeunload', (e) => {
                if (isFormDirty) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });
        </script>
    </body>
</html>