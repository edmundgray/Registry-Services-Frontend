<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <link rel="stylesheet" href="../CSS/style.css">
        
        <script src="../JS/javascript.js"></script>
        
        <title>Registry Services</title>
    </head>
    <body>
<!----------------------------------------------------------------------------
        Sidebar
  ------------------------------------------------------------------------------>
        <div class="sidebar">
            <ul>
                <li>
                    <a class="logo">
                        <span class="icon">
                            <img src="../Images/genericLogo.png" alt="Sidebar Logo" style="width: 40px; height: 40px;">
                        </span>
                        <span class="text">Registry Services</span>
                    </a>
                </li>
                <li>
                    <a href="eInvoicingSpecificationRegistry.html">
                        <span class="icon"><i class="fa-solid fa-house"></i></span>
                        <span class="text">eInvoicing Specification Registry</span>
                    </a>
                </li>
                <li class="protected">
                    <a href="mySpecifications.html">
                        <span class="icon"><i class="fa-solid fa-folder"></i></span>
                        <span class="text">My Specifications</span>
                    </a>
                </li>
                <li class="protected">
                    <a href="#">
                        <span class="icon"><i class="fa-solid fa-file-medical"></i></span>
                        <span class="text">Add New Specification</span>
                    </a>
                </li class="protected">
                <li class="child-element protected">
                    <a href="IdentifyingInformation.html">
                        <span class="icon"><i class="fa-solid fa-info"></i></span>
                        <span class="text">Identifying Information</span>
                    </a>
                </li>
                <li class="child-element">
                    <a href="coreInvoiceModel.html">
                        <span class="icon"><i class="fa-solid fa-car"></i></span>
                        <span class="text">Core Invoice Model</span>
                    </a>
                </li>
                <li class="child-element">
                    <a href="ExtensionComponentDataModel.html">
                        <span class="icon"><i class="fa-solid fa-trailer"></i></span>
                        <span class="text">Extension Component Data Model</span>
                    </a>
                </li>
                <li class="child-element protected">
                    <a href="#">
                        <span class="icon"><i class="fa-solid fa-circle-plus"></i></span>
                        <span class="text">Additional Requirements</span>
                    </a>
                </li>
                <li class="child-element protected">
                    <a href="#">
                        <span class="icon"><i class="fa-solid fa-square-check"></i></span>
                        <span class="text">Specification Preview</span>
                    </a>
                </li>
                <!-- Logging in/out-->
                <li id="loginLogoutItem">
                    <a href="#" onclick="toggleLogin()">
                        <span class="icon"><i class="fa-solid fa-right-from-bracket"></i></span>
                        <span class="text" id="loginLogoutButton">Logout</span>
                    </a>
                </li>
            </ul>
        </div>

<!----------------------------------------------------------------------------
        The Table
  ------------------------------------------------------------------------------>
        <div class="page-Content">
            <h1><i class="fa-solid fa-trailer"></i> Extension Component Data Model</h1>
            <br/>
            <span><b>Select the required Extension Component and view its required elements</b></span>
            <br/><br/>

            <div id="components-container"></div>

            <button type="button" onclick="addNewComponentSection()" class="view-button" style="margin-top: 15px;">Add Another Extension Component</button>

            <hr style="margin: 30px 0;">

            <div style="display: flex; justify-content: space-between; gap: 10px; margin-top: 10px;">
                <div>
                    <button type="button" onclick="handleSave()" class="view-button">Save</button>
                    <button type="button" onclick="handleCancel()" class="view-button" style="background-color: #F4A261; color: #fff;">Cancel New Specification</button>
                </div>
                <div>
                    <button type="button" onclick="saveAndGoToNextStep()" class="view-button" style="background:#217a36;">Additional Requirements</button>
                </div>
            </div>


            <!-- <select id="extensionComponentSelect" onchange="updateExtensionTable()">
                <option value="" selected>Select an Extension Component</option>
                <option>Invoice Reminder</option>
                <option>Proforma Invoice</option>
                <option>Calculate VAT at line level</option>
                <option>More than 2 decimals on amounts at line level</option>
                <option>Grouping invoice lines by using sublines</option>
                <option>Split Payments</option>
                <option>Generic Trading Party</option>
                <option>Using multiple languages</option>
                <option>Received and Accepted Quantity</option>
                <option>Delivery Information</option>
                <option>Payment Terms Extension Component</option>
                <option>Tax and Payment Currency</option>
            </select> -->
            
            <br/>
            
            <!-- <table class="data-table" id="extensionComponentTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Level</th>
                        <th>Cardinality</th>
                        <th>Business Term</th>
                        <th>Usage Note</th>
                        <th>Justification</th>
                        <th>Data Type</th>
                        <th>Type of Extension</th>
                    </tr>
                </thead>
                <tbody id="extensionTableBody">
                    <tr>
                        <td colspan="8" class="centered-cell">None selected</td>
                    </tr>
                </tbody>
            </table> -->
        </div>

<!----------------------------------------------------------------------------
        Javascript for the table
  ------------------------------------------------------------------------------>
        <script>
        function updateExtensionTable() 
        {
            const select = document.getElementById('extensionComponentSelect');
            const tbody = document.getElementById('extensionTableBody');
            
            if (select.value === "") 
            {
                tbody.innerHTML = `<tr><td colspan="8" class="centered-cell">None selected</td></tr>`;
            } 
            else 
            {
                tbody.innerHTML = `<tr><td colspan="8" class="centered-cell">Under development</td></tr>`;
            }
        }
        </script>
        <script>
    // This object will be populated with data from your new JSON file.
    let extensionComponentData = {};
    const componentsContainer = document.getElementById('components-container');

    // --- NEW: Function to load and process your JSON data ---
    async function loadExtensionData() {
        try {
            // Fetch the JSON file content
            const response = await fetch('../JSON/extensionComponentModelElements.json');
            const data = await response.json(); // This is now a direct JSON array

            // Process the flat JSON array into a grouped object
            const processedData = {};
            data.forEach(item => {
                const componentName = item.Component;
                if (componentName) {
                    if (!processedData[componentName]) {
                        processedData[componentName] = { elements: [] };
                    }
                    processedData[componentName].elements.push({
                        id: item.ID,
                        level: item.Level,
                        cardinality: item.Cardinality,
                        term: item['Business Term'],
                        note: item['Usage Note']
                    });
                }
            });
            
            extensionComponentData = processedData;
            // Now that data is loaded, add the first component section
            addNewComponentSection();

        } catch (error) {
            console.error("Error loading or parsing extension component data:", error);
            componentsContainer.innerHTML = `<p style="color: red;">Error: Could not load extension component data. Please check the file path and format.</p>`;
        }
    }

    // Function to create a new component selection block
    function addNewComponentSection() {
        const sectionId = `section-${Date.now()}`;
        const section = document.createElement('div');
        section.id = sectionId;
        section.style.border = "1px solid #ddd";
        section.style.padding = "15px";
        section.style.marginBottom = "20px";
        section.style.backgroundColor = "#fff";

        let options = '<option value="">Select an Extension Component</option>';
        for (const key in extensionComponentData) {
            options += `<option value="${key}">${key}</option>`;
        }

        section.innerHTML = `
            <select class="component-select" onchange="populateComponentTable(this)">${options}</select>
            <button onclick="document.getElementById('${sectionId}').remove()" class="view-button" style="float: right; background: #ccc; color: #333;">Clear Selection</button>
            <br/><br/>
            <table class="styled-table" style="width:100%;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Level</th>
                        <th>Cardinality</th>
                        <th>Business Term</th>
                        <th>Usage Note</th>
                        <th>Included</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="6" style="text-align:center;">Please select a component from the dropdown.</td></tr>
                </tbody>
            </table>
        `;
        componentsContainer.appendChild(section);
    }

    // Function to populate the table (no changes needed)
    function populateComponentTable(selectElement) {
        const selectedValue = selectElement.value;
        const tableBody = selectElement.closest('div').querySelector('tbody');

        if (!selectedValue) {
            tableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Please select a component from the dropdown.</td></tr>';
            return;
        }

        const component = extensionComponentData[selectedValue];
        tableBody.innerHTML = ''; // Clear the table

        component.elements.forEach(el => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${el.id}</td>
                <td>${el.level}</td>
                <td>${el.cardinality}</td>
                <td>${el.term}</td>
                <td>${el.note}</td>
                <td style="text-align:center;"><input type="checkbox" class="element-selector" data-id="${el.id}"></td>
            `;
            tableBody.appendChild(row);
        });
    }

    // Main button functions (no changes needed)
    function handleSave(showAlert = true) {
        const selectedExtensions = [];
        document.querySelectorAll('#components-container > div').forEach(section => {
            const select = section.querySelector('.component-select');
            const componentName = select.value;

            if (componentName) {
                const selectedElements = [];
                section.querySelectorAll('.element-selector:checked').forEach(checkbox => {
                    selectedElements.push(checkbox.getAttribute('data-id'));
                });

                if (selectedElements.length > 0) {
                     selectedExtensions.push({
                        componentName: componentName,
                        selectedElements: selectedElements
                    });
                }
            }
        });

        const editingSpecId = localStorage.getItem("selectedSpecification");
        if (!editingSpecId) {
            alert("Error: No specification selected.");
            return;
        }

        let specifications = JSON.parse(localStorage.getItem("mySpecifications")) || [];
        const specIndex = specifications.findIndex(spec => spec.id === editingSpecId);

        if (specIndex > -1) {
            specifications[specIndex].extensionComponents = selectedExtensions;
            localStorage.setItem('mySpecifications', JSON.stringify(specifications));
            if (showAlert) {
                alert("Extension components saved!");
            }
        } else {
            alert("Error: Could not find the specification to save to.");
        }
    }

    function handleCancel() {
        if (confirm("Warning! This Specification will be deleted, do you want to proceed?")) {
            const specIdToDelete = localStorage.getItem("selectedSpecification");
            if (specIdToDelete) {
                let specifications = JSON.parse(localStorage.getItem("mySpecifications")) || [];
                const updatedSpecifications = specifications.filter(spec => spec.id !== specIdToDelete);
                localStorage.setItem('mySpecifications', JSON.stringify(updatedSpecifications));
                localStorage.removeItem("selectedSpecification");
            }
            window.location.href = 'mySpecifications.html';
        }
    }

    function saveAndGoToNextStep() {
        handleSave(false);
        // This should redirect to the page for "Additional Requirements"
        window.location.href = '#'; // Update this when the page exists
        alert("This would go to the 'Additional Requirements' page.");
    }

    // Start loading the data when the page opens
    document.addEventListener('DOMContentLoaded', () => {
        loadExtensionData();
    });
</script>
    </body>
</html>