<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <link rel="stylesheet" href="../CSS/style.css">

        <!-- Add authManager.js for global AuthManager and AUTH_CONFIG -->
        <script src="../JS/auth/authManager.js"></script>
        <script>
            // Create a global authManager instance and authenticatedFetch
            window.authManager = new AuthManager();
            function authenticatedFetch(url, options = {}) {
                const authHeaders = window.authManager.getAuthHeaders();
                console.log('DEBUG: authenticatedFetch called with URL:', url);
                console.log('DEBUG: Auth headers:', authHeaders);
                
                const headers = { ...(options.headers || {}), ...authHeaders };
                console.log('DEBUG: Final headers for request:', headers);
                
                return fetch(url, { ...options, headers });
            }
        </script>
        <script src="../JS/sidebarManager.js"></script>
        <script src="../JS/breadcrumbManager.js"></script>
        <script src="../JS/javascript.js"></script>
        <script src="../JS/dataManager.js"></script>

        <title>Registry Services</title>
        <style>
            /* Style for the Edit button container */
            .header-with-edit {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px; /* Adjust as needed */
            }
            .edit-button-top-right { /* You can reuse .view-button or define new styles */
                padding: 5px 10px;
                font-size: 12px;
                color: #fff;
                background-color: #28a745; /* Green color for Edit */
                border: none;
                border-radius: 4px;
                cursor: pointer;
                transition: background-color 0.3s ease;
            }
            .edit-button-top-right:hover {
                background-color: #218838;
            }
        </style>
    </head>
    <body>
        <div id="sidebarContainer">
            <!-- Sidebar will be dynamically generated by sidebarManager.js -->
        </div>

        <div class="page-Content">
            <div id="breadcrumbContainer" class="breadcrumb-container">
                <!-- Breadcrumb will be dynamically generated by breadcrumbManager.js -->
            </div>
            <div class="header-with-edit">
                <h1><i class="fa-solid fa-house"></i> View Specification</h1>
                <button id="editSpecificationButton" class="edit-button-top-right">Edit</button>
            </div>
            <br/>
            <div id="detailsTableContainer"></div>
<!----------------------------------------------------------------------------
        The 3 tabs for the specification details
  ------------------------------------------------------------------------------>
            <div class="tabs">
                <button class="tab-button active" onclick="showTab('identifyingInfo')">Identifying Information</button>
                <button class="tab-button" onclick="showTab('specificationModel')">Specification Model</button>
                <button class="tab-button" onclick="showTab('supportingArtefacts')">Supporting Artefacts</button>
            </div>

<!----------------------------------------------------------------------------
        The content for each tab
        1/3 General Information
  ------------------------------------------------------------------------------>
            <div id="identifyingInfo" class="tab-content active">
                <div class="info-section">
                    <!-- General Information -->
                    <div class="info-table">
                        <h3>General Information</h3>
                        <div class="info-row">
                            <label>Specification Name:</label>
                            <span id="specificationName"></span>
                        </div>
                        <div class="info-row">
                            <label>Governing Entity:</label>
                            <span id="governingEntity"></span>
                        </div>
                        <div class="info-row">
                            <label>Contact Information:</label>
                            <span id="contactInformation">N/A</span>
                        </div>
                        <div class="info-row">
                            <label>Sector:</label>
                            <span id="sector"></span>
                        </div>
                        <div class="info-row">
                            <label>Country:</label>
                            <span id="country"></span>
                        </div>
                        <div class="info-row">
                            <label>Purpose:</label>
                            <span id="purpose"></span>
                        </div>
                    </div>

<!----------------------------------------------------------------------------
        Technical Information
  ------------------------------------------------------------------------------>
                    <div class="info-table">
                        <h3>Technical Information</h3>
                        <div class="info-row">
                            <label>Specification Identifier:</label>
                            <span id="specificationIdentifier"></span>
                        </div>
                        <div class="info-row">
                            <label>Specification Version:</label>
                            <span id="specificationVersion"></span>
                        </div>
                        <div class="info-row">
                            <label>Date of Implementation:</label>
                            <span id="implementationDate"></span>
                        </div>
                        <div class="info-row">
                            <label>Core Version:</label>
                            <span id="coreVersion"></span>
                        </div>
                        <div class="info-row">
                            <label>Underlying Specification:</label>
                            <span id="underlyingSpecification"></span>
                        </div>
                        <div class="info-row">
                            <label>Specification Source Link:</label>
                            <span id="specificationSourceLink"></span>
                        </div>
                        <div class="info-row">
                            <label>Preferred Syntax:</label>
                            <span id="preferredSyntax"></span>
                        </div>
                    </div>
                </div>
            </div>

<!----------------------------------------------------------------------------
        2/3 Specification Model tab
  ------------------------------------------------------------------------------>
            <div id="specificationModel" class="tab-content">
                <div class="info-section">

<!----------------------------------------------------------------------------
        Selected Core Invoice Model elements
  ------------------------------------------------------------------------------>
                    <div class="info-table">
                        <h3>Selected Core Invoice Model elements</h3>
                        <table id="coreInvoiceModelTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Business Term</th>
                                    <th>Type of Change</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Rows are dynamically populated -->
                            </tbody>
                        </table>
                    </div>

<!----------------------------------------------------------------------------
        Selected Extension Component Data Model elements
  ------------------------------------------------------------------------------>
                    <div class="info-table">
                        <h3>Selected Extension Component Data Model elements</h3>
                        <table id="extensionComponentTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Business Term</th>
                                    <th>Extension Component</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Placeholder -->
                            </tbody>
                        </table>
                    </div>

<!----------------------------------------------------------------------------
        Additional Requirements
  ------------------------------------------------------------------------------>
                    <div class="info-table">
                        <h3>Additional Requirements</h3>
                        <table id="additionalRequirementsTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Business Term</th>
                                    <th>Type of Change</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Placeholder for future content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

<!----------------------------------------------------------------------------
        3/3 Supporting Artefacts tab
  ------------------------------------------------------------------------------>
            <div id="supportingArtefacts" class="tab-content">
                <div class="info-section">
                    <div class="info-table">

<!----------------------------------------------------------------------------
        URL Links
  ------------------------------------------------------------------------------>
                        <h3>Links</h3>
                        <div class="info-row">
                            <label>Specification Source Link:</label>
                            <span>
                                <a href="https://www.eascdc.com/invoicing/specifications/agdas.v1" target="_blank">
                                    https://wwww.loremipsum.com
                                </a>
                            </span>
                        </div>
                        <div class="info-row">
                            <label>Codelist(s):</label>
                            <span>
                                <a href="https://www.eascdc.com/invoicing/specifications/agdas.v1/codelists" target="_blank">
                                    https://wwww.loremipsum.com
                                </a>
                            </span>
                        </div>
                        <div class="info-row">
                            <label>Validation Artefacts:</label>
                            <span>
                                <a href="https://www.eascdc.com/invoicing/specifications/agdas.v1/validation" target="_blank">
                                    https://wwww.loremipsum.com
                                </a>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

<!----------------------------------------------------------------------------
        Some exclusive JavaScript for this page
------------------------------------------------------------------------------>
        <script>
            let currentSpecification = null; // Store the current specification data

            document.addEventListener("DOMContentLoaded", function () {
                console.log('ViewSpecification page loaded');
                
                // Initialize authentication manager
                window.authManager.init();
                
                // Get specification ID from URL or localStorage
                const params = new URLSearchParams(window.location.search);
                const specificationId = params.get('id') || localStorage.getItem('viewSpecificationId');
                
                console.log('DEBUG: Specification ID:', specificationId);
                console.log('DEBUG: URL params:', Object.fromEntries(params.entries()));
                console.log('DEBUG: Auth state:', {
                    isAuthenticated: window.authManager.isAuthenticated,
                    accessToken: window.authManager.accessToken ? 'Present' : 'Not present',
                    username: window.authManager.username
                });
                
                if (!specificationId) {
                    console.error('No specification ID provided');
                    showErrorMessage('Error: No specification ID provided. Please navigate from the My Specifications page.');
                    return;
                }
                
                // Note: Authentication is optional for viewing specifications since the API allows public access
                console.log('DEBUG: User authentication status:', {
                    isAuthenticated: window.authManager.isAuthenticated,
                    accessToken: window.authManager.accessToken ? 'Present' : 'Not present'
                });
                
                // Load the specification from API
                loadSpecificationById(specificationId);
            });

            async function loadSpecificationById(specificationId) {
                try {
                    console.log('Loading specification by ID:', specificationId);
                    showLoadingIndicator();
                    
                    // Try to get the specification from API (no authentication required for public viewing)
                    const response = await authenticatedFetch(`${AUTH_CONFIG.baseUrl}/specifications/${specificationId}`, {
                        method: 'GET'
                        // Removed forceAuth: true to allow unauthenticated access
                    });

                    console.log('DEBUG: API Response status:', response.status);

                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error('Specification not found. It may have been deleted or you may not have permission to view it.');
                        } else if (response.status === 403) {
                            throw new Error('Access denied. You do not have permission to view this specification.');
                        } else {
                            throw new Error(`Failed to load specification: HTTP ${response.status}`);
                        }
                    }

                    currentSpecification = await response.json();
                    console.log('DEBUG: Loaded specification:', currentSpecification);
                    
                    if (!currentSpecification) {
                        throw new Error('No specification data received from server');
                    }
                    
                    // Populate the page with specification data
                    await populateSpecificationData(currentSpecification);
                    
                    hideLoadingIndicator();
                    
                } catch (error) {
                    console.error('Error loading specification:', error);
                    hideLoadingIndicator();
                    showErrorMessage(`Failed to load specification: ${error.message}`);
                }
            }

            async function populateSpecificationData(spec) {
                try {
                    console.log('Populating specification data:', spec);
                    
                    // Create summary table at the top
                    createSummaryTable(spec);
                    
                    // Populate Identifying Information tab
                    populateIdentifyingInformation(spec);
                    
                    // Populate Specification Model tab (Core Invoice Model, Extension Components, Additional Requirements)
                    await populateSpecificationModel(spec);
                    
                    // Populate Supporting Artefacts tab
                    populateSupportingArtefacts(spec);
                    
                    // Set up edit button functionality
                    setupEditButton(spec);
                    
                } catch (error) {
                    console.error('Error populating specification data:', error);
                    showErrorMessage(`Error displaying specification: ${error.message}`);
                }
            }

            function createSummaryTable(spec) {
                const detailsTableContainer = document.getElementById("detailsTableContainer");
                detailsTableContainer.innerHTML = ''; // Clear existing content
                
                const table = document.createElement("table");
                table.id = "detailsTable";
                table.style.width = "100%";
                table.style.border = "1px solid #ccc";
                table.style.borderCollapse = "collapse";
                
                // Create header row
                const headerRow = table.insertRow();
                const headers = ['Name', 'Purpose', 'Type', 'Sector', 'Country', 'Implementation Date', 'Status'];
                headers.forEach(header => {
                    const th = document.createElement("th");
                    th.textContent = header;
                    th.style.border = "1px solid #ccc";
                    th.style.padding = "8px";
                    th.style.backgroundColor = "#f5f5f5";
                    headerRow.appendChild(th);
                });
                
                // Create data row
                const dataRow = table.insertRow();
                const values = [
                    spec.specificationName || 'N/A',
                    spec.purpose || 'N/A',
                    spec.specificationType || 'N/A',
                    spec.sector || 'N/A',
                    spec.country || 'N/A',
                    spec.dateOfImplementation ? new Date(spec.dateOfImplementation).toLocaleDateString() : 'N/A',
                    spec.registrationStatus || spec.implementationStatus || 'N/A'
                ];
                
                values.forEach(value => {
                    const td = dataRow.insertCell();
                    td.textContent = value;
                    td.style.border = "1px solid #ccc";
                    td.style.padding = "8px";
                });
                
                detailsTableContainer.appendChild(table);
            }

            function populateIdentifyingInformation(spec) {
                // General Information
                document.getElementById("specificationName").textContent = spec.specificationName || 'N/A';
                document.getElementById("governingEntity").textContent = spec.governingEntity || 'N/A';
                document.getElementById("contactInformation").textContent = spec.contactInformation || 'N/A';
                document.getElementById("sector").textContent = spec.sector || 'N/A';
                document.getElementById("country").textContent = spec.country || 'N/A';
                document.getElementById("purpose").textContent = spec.purpose || 'N/A';
                
                // Technical Information
                document.getElementById("specificationIdentifier").textContent = spec.specificationIdentifier || 'N/A';
                document.getElementById("specificationVersion").textContent = spec.specificationVersion || 'N/A';
                document.getElementById("implementationDate").textContent = spec.dateOfImplementation ? 
                    new Date(spec.dateOfImplementation).toLocaleDateString() : 'N/A';
                document.getElementById("coreVersion").textContent = spec.coreVersion || 'N/A';
                document.getElementById("underlyingSpecification").textContent = spec.underlyingSpecificationIdentifier || 'N/A';
                document.getElementById("specificationSourceLink").textContent = spec.specificationSourceLink || 'N/A';
                document.getElementById("preferredSyntax").textContent = spec.preferredSyntax || 'N/A';
            }

            async function populateSpecificationModel(spec) {
                try {
                    console.log('DEBUG: Populating specification model with data:', {
                        specificationCores: spec.specificationCores,
                        specificationExtensionComponents: spec.specificationExtensionComponents,
                        additionalRequirements: spec.additionalRequirements
                    });
                    
                    // Populate Core Invoice Model table
                    const coreTableBody = document.querySelector("#coreInvoiceModelTable tbody");
                    coreTableBody.innerHTML = ''; // Clear existing rows
                    
                    const coreItems = spec.specificationCores || [];
                    console.log('DEBUG: Core items found:', coreItems.length);
                    
                    if (coreItems.length > 0) {
                        coreItems.forEach(item => {
                            const row = coreTableBody.insertRow();
                            row.insertCell().textContent = item.businessTermID || 'N/A';
                            row.insertCell().textContent = item.coreBusinessTerm || 'N/A';
                            row.insertCell().textContent = item.typeOfChange || 'Core Element';
                        });
                    } else {
                        const row = coreTableBody.insertRow();
                        const cell = row.insertCell();
                        cell.colSpan = 3;
                        cell.textContent = 'No Core Invoice Model elements selected';
                        cell.style.textAlign = 'center';
                        cell.style.fontStyle = 'italic';
                        cell.style.color = '#666';
                    }
                    
                    // Populate Extension Component table
                    const extensionTableBody = document.querySelector("#extensionComponentTable tbody");
                    extensionTableBody.innerHTML = ''; // Clear existing rows
                    
                    const extensionItems = spec.specificationExtensionComponents || [];
                    console.log('DEBUG: Extension items found:', extensionItems.length);
                    
                    if (extensionItems.length > 0) {
                        extensionItems.forEach(item => {
                            const row = extensionTableBody.insertRow();
                            row.insertCell().textContent = item.businessTermID || 'N/A';
                            row.insertCell().textContent = item.extBusinessTerm || 'N/A';
                            row.insertCell().textContent = item.extensionComponentID || 'Extension Component';
                        });
                    } else {
                        const row = extensionTableBody.insertRow();
                        const cell = row.insertCell();
                        cell.colSpan = 3;
                        cell.textContent = 'No Extension Component Data Model elements selected';
                        cell.style.textAlign = 'center';
                        cell.style.fontStyle = 'italic';
                        cell.style.color = '#666';
                    }
                    
                    // Populate Additional Requirements table
                    const additionalTableBody = document.querySelector("#additionalRequirementsTable tbody");
                    additionalTableBody.innerHTML = ''; // Clear existing rows
                    
                    const additionalItems = spec.additionalRequirements || [];
                    console.log('DEBUG: Additional requirements found:', additionalItems.length);
                    
                    if (additionalItems.length > 0) {
                        additionalItems.forEach(item => {
                            const row = additionalTableBody.insertRow();
                            row.insertCell().textContent = item.businessTermID || 'N/A';
                            row.insertCell().textContent = item.businessTermName || 'N/A';
                            row.insertCell().textContent = item.typeOfChange || 'Additional Requirement';
                        });
                    } else {
                        const row = additionalTableBody.insertRow();
                        const cell = row.insertCell();
                        cell.colSpan = 3;
                        cell.textContent = 'No Additional Requirements specified';
                        cell.style.textAlign = 'center';
                        cell.style.fontStyle = 'italic';
                        cell.style.color = '#666';
                    }
                    
                } catch (error) {
                    console.error('Error populating specification model:', error);
                    showErrorMessage('Error loading specification model data');
                }
            }

            function populateSupportingArtefacts(spec) {
                // Update the links in the Supporting Artefacts tab
                const specSourceLink = document.querySelector('#supportingArtefacts a[href*="loremipsum"]');
                if (specSourceLink && spec.specificationSourceLink) {
                    specSourceLink.href = spec.specificationSourceLink;
                    specSourceLink.textContent = spec.specificationSourceLink;
                }
                
                // For now, other links remain as placeholders since the API doesn't provide specific URLs
                // You would update these based on the actual data structure returned by the API
            }

            function setupEditButton(spec) {
                const editButton = document.getElementById("editSpecificationButton");
                if (editButton) {
                    // Use the global editSpecification function for consistency
                    editButton.addEventListener("click", function() {
                        if (spec.identityID) {
                            console.log('DEBUG: viewSpecification - Spec data for editing:', spec);
                            console.log('DEBUG: viewSpecification - Identity ID:', spec.identityID);
                            console.log('DEBUG: viewSpecification - Navigating to edit mode for specification:', spec.specificationName);
                            
                            // Set return page to viewSpecification
                            localStorage.setItem("returnToPage", "viewSpecification.html?id=" + spec.identityID);
                            
                            // Set breadcrumb context for edit workflow from view page
                            if (window.breadcrumbManager) {
                                const currentContext = window.breadcrumbManager.getContext();
                                const editContext = {
                                    source: currentContext ? currentContext.source : 'registry',
                                    action: 'edit',
                                    currentPage: 'IdentifyingInformation.html',
                                    specId: spec.identityID,
                                    specIdentityId: spec.identityID
                                };
                                window.breadcrumbManager.setContext(editContext);
                            }
                            
                            // Call the global editSpecification function
                            editSpecification(spec.identityID);
                        } else {
                            console.error('DEBUG: viewSpecification - No identityID found in spec:', spec);
                            alert("Cannot edit: Specification ID not available.");
                        }
                    });
                }
            }

            // Utility functions for loading states and error handling
            function showLoadingIndicator() {
                const detailsContainer = document.getElementById("detailsTableContainer");
                detailsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;"><i class="fa-solid fa-spinner fa-spin"></i> Loading specification...</div>';
            }

            function hideLoadingIndicator() {
                // Loading indicator will be replaced by actual content in createSummaryTable
            }

            function showErrorMessage(message) {
                const detailsContainer = document.getElementById("detailsTableContainer");
                detailsContainer.innerHTML = `
                    <div style="background: #fee; border: 1px solid #fcc; border-radius: 5px; padding: 15px; margin: 10px 0; color: #c33;">
                        <i class="fa-solid fa-exclamation-triangle"></i> <strong>Error:</strong> ${message}
                    </div>
                `;
                
                // Also clear the tabs since they won't have valid data
                document.getElementById("specificationName").textContent = 'N/A';
                document.getElementById("governingEntity").textContent = 'N/A';
                document.getElementById("sector").textContent = 'N/A';
                document.getElementById("country").textContent = 'N/A';
                document.getElementById("purpose").textContent = 'N/A';
                document.getElementById("specificationIdentifier").textContent = 'N/A';
                document.getElementById("specificationVersion").textContent = 'N/A';
                document.getElementById("implementationDate").textContent = 'N/A';
                document.getElementById("coreVersion").textContent = 'N/A';
                document.getElementById("underlyingSpecification").textContent = 'N/A';
                document.getElementById("specificationSourceLink").textContent = 'N/A';
                document.getElementById("preferredSyntax").textContent = 'N/A';
                
                // Clear tables
                const coreTableBody = document.querySelector("#coreInvoiceModelTable tbody");
                const extensionTableBody = document.querySelector("#extensionComponentTable tbody");
                const additionalTableBody = document.querySelector("#additionalRequirementsTable tbody");
                
                if (coreTableBody) coreTableBody.innerHTML = '';
                if (extensionTableBody) extensionTableBody.innerHTML = '';
                if (additionalTableBody) additionalTableBody.innerHTML = '';
            }

            // Tab switching logic (separate function to avoid conflicts)
            function showTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.classList.remove('active');
                });
                document.getElementById(tabId).classList.add('active');
                event.target.classList.add('active');
            }
        </script>
        
        <script>
            // Initialize the sidebar and authentication when the page loads
            document.addEventListener('DOMContentLoaded', function() {
                // Initialize auth manager
                window.authManager.init();
                
                // Initialize sidebar
                window.sidebarManager.initializeSidebar(window.authManager);
                
                // Initialize breadcrumb system
                window.breadcrumbManager.init();
                
                // Set breadcrumb context for this page (view specification)
                // For testing, let's set a default context if no spec is selected
                let viewingSpecId = localStorage.getItem("selectedSpecification") || 
                                   localStorage.getItem("viewSpecificationId") ||
                                   'DEMO_SPEC_001';
                
                console.log('DEBUG: viewSpecification - viewingSpecId:', viewingSpecId);
                
                // Always set a context for testing
                const context = {
                    currentPage: 'viewSpecification.html',
                    specId: viewingSpecId,
                    action: 'view'
                };
                
                // Determine source from referrer
                const referrer = document.referrer;
                console.log('DEBUG: viewSpecification - referrer:', referrer);
                
                if (referrer.includes('eInvoicingSpecificationRegistry.html')) {
                    context.source = 'registry';
                } else if (referrer.includes('mySpecifications.html')) {
                    context.source = 'mySpecs';
                } else {
                    context.source = 'registry'; // Default to registry for view pages
                }
                
                console.log('DEBUG: viewSpecification - setting breadcrumb context:', context);
                window.breadcrumbManager.setContext(context);
            });
        </script>
    </body>
</html>