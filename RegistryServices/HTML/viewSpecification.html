<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
        <link rel="stylesheet" href="../CSS/style.css">

        <!-- AuthManager.js provides global AuthManager and AUTH_CONFIG; initialization is now handled centrally -->
        <script src="../JS/auth/authManager.js"></script>
        <script>
        // Ensure global authManager is always initialized
        if (!window.authManager) {
            window.authManager = new window.AuthManager();
            console.debug('[DEBUG] window.authManager initialized globally in viewSpecification.html');
        }
        </script>
        <script src="../JS/sidebarManager.js"></script>
        <script src="../JS/breadcrumbManager.js"></script>
        <script src="../JS/javascript.js"></script>
        <script src="../JS/dataManager.js"></script>

        <title>Registry Services</title>
        <style>
            #sidebarContainer {
                position: relative;
                z-index: 1000;
            }
            /* Model count summary containers for Specification Model tab */
            .model-count-summary {
                display: flex;
                gap: 24px;
                margin-bottom: 24px;
                margin-top: 0;
                align-items: center;
                justify-content: center;
                text-align: center;
                flex-wrap: wrap;
            }
            .model-count-box {
                min-width: 270px;
                height: 90px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                border-radius: 8px;
                color: #fff;
                font-family: inherit;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                text-align: center;
                margin-bottom: 16px;
                cursor: pointer;
                transition: box-shadow 0.2s, transform 0.2s, background 0.2s;
            }
            .model-count-box:hover {
                box-shadow: 0 4px 16px rgba(0,0,0,0.15);
                transform: scale(1.03);
                filter: brightness(1.08);
            }
            @media (max-width: 900px) {
                .model-count-box {
                    min-width: 180px;
                    height: 80px;
                    font-size: 0.95em;
                }
                .model-count-summary {
                    gap: 12px;
                }
            }
            @media (max-width: 600px) {
                .model-count-box {
                    min-width: 100px;
                    height: auto;
                    font-size: 0.9em;
                    padding: 10px 0;
                }
                .model-count-summary {
                    gap: 8px;
                }
            }
            .model-count-core {
                background: #0a9c1a;
            }
            .model-count-extension {
                background: #2576e6;
            }
            .model-count-additional {
                background: #d3a1b7;
            }
            .model-count-title {
                font-size: 1em;
                font-weight: 500;
                margin-bottom: 8px;
                text-align: center;
            }
            .model-count-value {
                font-size: 1.4em;
                font-weight: 600;
                text-align: center;
            }

/*********************************************************
 * Styling for the Edit button container        
 *********************************************************/
            .header-with-edit 
            {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
            }
            .edit-button-top-right 
            {
                padding: 5px 10px;
                font-size: 12px;
                color: #fff;
                background-color: #28a745;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                transition: background-color 0.3s ease;
            }
            .edit-button-top-right:hover 
            {
                background-color: #218838;
            }

            .action-buttons-container 
            {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .admin-only,
            .edit-button-top-right {
                display: none;
            }
            .tabs 
            {
                display: flex;
                gap: 0;
                margin-bottom: 16px;
                z-index: 10;
                position: relative;
            }
            .tab-button 
            {
                background: #f5f5f5;
                border: 1px solid #ccc;
                border-radius: 6px 6px 0 0;
                padding: 8px 24px;
                font-size: 1em;
                cursor: pointer;
                position: relative;
                z-index: 1;
                margin-right: -1px;
                transition: box-shadow 0.2s;
            }
            .tab-button.active 
            {
                background: #fff;
                border-bottom: 2px solid #0074d9;
                font-weight: bold;
                z-index: 2;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            }

            .table-title-container{
                padding: 10px 15px;
                color: #fff;
                border-radius: 5px 5px 0 0;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            .core-model-title {
                background-color: #0a9c1a;
            }
            .extension-model-title {
                background-color: #2576e6;
            }
            .additional-reqs-title {
                background-color: #d3a1b7;
            }
            .table-title-container h3 {
                margin: 0;
                font-size: 1.1em;
                font-weight: 500;
                text-align: left;
            }
            
        </style>
    </head>
    <body>
        <div id="sidebarContainer">
            <!-- Sidebar will be dynamically generated by sidebarManager.js -->
        </div>
        <!-- Return to Top Button -->
        <button id="returnToTopBtn" style="position: fixed; right: 32px; bottom: 32px; z-index: 9999; background: #2576e6; color: #fff; border: none; border-radius: 50px; padding: 12px 28px; font-size: 1.1em; box-shadow: 0 2px 8px rgba(0,0,0,0.12); cursor: pointer; opacity: 0.92; transition: background 0.2s, opacity 0.2s; display: none;">
            <i class="fa-solid fa-arrow-up"></i> Return to Top
        </button>

        <div class="page-Content">
            <div id="breadcrumbContainer" class="breadcrumb-container">
                <!-- Breadcrumb will be dynamically generated by breadcrumbManager.js -->
            </div>
            <div class="header-with-edit">
                <h1><i class="fa-solid fa-house"></i> View Specification</h1>
                <div class="action-buttons-container">
                <div class="admin-only">
                    <label for="registryStatusDropdown" style="font-size: 0.8em;">Registry Status:</label>
                    <select id="registryStatusDropdown" style="padding: 5px; border-radius: 4px; font-size: 0.8em;">
                        <option value="Submitted">Submitted</option>
                        <option value="Under Review">Under Review</option>
                        <option value="Verified">Verified</option>
                    </select>
                    <button id="updateStatusButton" class="view-button" style="margin-left: 0; font-size: 0.8em; padding: 5px 8px; ">Update Status</button>
                </div>
                <button id="editSpecificationButton" class="edit-button-top-right">Edit</button>
            </div>
            </div>
            <br/>
            <div id="detailsTableContainer"></div>
<!----------------------------------------------------------------------------
        The 3 tabs for the specification details
  ------------------------------------------------------------------------------>
            <div class="tabs">
                <button class="tab-button active" onclick="showTab('identifyingInfo')">Identifying Information</button>
                <button class="tab-button" onclick="showTab('specificationModel')">Specification Model</button>
                <button class="tab-button" onclick="showTab('supportingArtefacts')">Supporting Artefacts</button>
            </div>

<!----------------------------------------------------------------------------
        The content for each tab
        1/3 General Information
  ------------------------------------------------------------------------------>
            <div id="identifyingInfo" class="tab-content active">
                <div class="info-section">
                    <!-- General Information -->
                    <div class="info-table">
                        <h3>General Information</h3>
                        <div class="info-row">
                            <label>Specification Name:</label>
                            <span id="specificationName"></span>
                        </div>
                        <div class="info-row">
                            <label>Governing Entity:</label>
                            <span id="governingEntity"></span>
                        </div>
                        <div class="info-row">
                            <label>Contact Information:</label>
                            <span id="contactInformation">N/A</span>
                        </div>
                        <div class="info-row">
                            <label>Sector:</label>
                            <span id="sector"></span>
                        </div>
                        <div class="info-row">
                            <label>Country:</label>
                            <span id="country"></span>
                        </div>
                        <div class="info-row">
                            <label>Purpose:</label>
                            <span id="purpose"></span>
                        </div>
                    </div>

<!----------------------------------------------------------------------------
        Technical Information
  ------------------------------------------------------------------------------>
                    <div class="info-table">
                        <h3>Technical Information</h3>
                        <div class="info-row">
                            <label>Specification Identifier:</label>
                            <span id="specificationIdentifier"></span>
                        </div>
                        <div class="info-row">
                            <label>Specification Version:</label>
                            <span id="specificationVersion"></span>
                        </div>
                        <div class="info-row">
                            <label>Date of Implementation:</label>
                            <span id="implementationDate"></span>
                        </div>
                        <div class="info-row">
                            <label>Core Version:</label>
                            <span id="coreVersion"></span>
                        </div>
                        <div class="info-row">
                            <label>Underlying Specification:</label>
                            <span id="underlyingSpecification"></span>
                        </div>
                        <div class="info-row">
                            <label>Specification Source Link:</label>
                            <span id="specificationSourceLink"></span>
                        </div>
                        <div class="info-row">
                            <label>Preferred Syntax:</label>
                            <span id="preferredSyntax"></span>
                        </div>
                    </div>
                </div>
            </div>

<!----------------------------------------------------------------------------
        2/3 Specification Model tab
  ------------------------------------------------------------------------------>
            <div id="specificationModel" class="tab-content">
                <!-- Model count summary containers -->
                <div class="model-count-summary" id="modelCountSummary">
                    
                    <div class="model-count-box model-count-core" id="coreModelCountBox" onclick="document.getElementById('coreInvoiceModelTable').scrollIntoView({ behavior: 'smooth' });">
                        <div class="model-count-title">Core Invoice Data Model</div>
                        <div class="model-count-value" id="coreModelCount">0 elements</div>
                    </div>
                    <div class="model-count-box model-count-extension" id="extensionModelCountBox" onclick="document.getElementById('extensionComponentDataTable').scrollIntoView({ behavior: 'smooth' });">
                        <div class="model-count-title">Extension Component Data Model</div>
                        <div class="model-count-value" id="extensionModelCount">0 elements</div>
                    </div>
                    <div class="model-count-box model-count-additional" id="additionalModelCountBox" onclick="document.getElementById('additionalRequirementsTable').scrollIntoView({ behavior: 'smooth' });">
                        <div class="model-count-title">Additional Requirements</div>
                        <div class="model-count-value" id="additionalModelCount">0 elements</div>
                    </div>
                </div>
                <div class="info-section" style="display: flex; flex-direction: column; gap: 24px;">
                    <!-- Selected Core Invoice Model elements (first, stacked) -->
                    <div style="width: 100%;">
                        <div class="table-title-container core-model-title">
                            <h3>Selected Core Invoice Model elements</h3>
                            <button id="toggleCoreTableButton" class="show-more-btn" style="background-color: #fff; color: #217a36;">Show more</button>
                        </div>
                        <table id="coreInvoiceModelTable" class="styled-table" style="width: 100%; margin-top: 0; display: none;">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Level</th>
                                    <th>Cardinality</th>
                                    <th>Business Term</th>
                                    <th>Usage Note</th>
                                    <th>Business Rules</th>
                                    <th>Data Type</th>
                                    <th>Type of Change</th>
                                    <th>Actions</th>
                                    
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Rows are dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                    <!-- Selected Extension Component Data Model elements (second, stacked) -->
                    <div style="width: 100%;">
                        <div class="table-title-container extension-model-title">
                            <h3>Selected Extension Component Data Model elements</h3>
                            <button id="toggleExtensionTableButton" class="show-more-btn" style="background-color: #fff; color:#000080;">Show more</button>
                        </div>
                        <table id="extensionComponentDataTable" class="styled-table" style="width: 100%; margin-top: 0; display: none;">
                            <thead>
                                <tr>
                                    <th>Extension Component</th>
                                    <th>ID</th>
                                    <th>Level</th>
                                    <th>Cardinality</th>
                                    <th>Business Term</th>
                                    <th>Usage Note</th>
                                    <th>Justification</th>
                                    <th>Data Type</th>
                                    <th>Type of Extension</th>
                                    <th>Core Conformant/Rules broken</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Placeholder -->
                            </tbody>
                        </table>
                    </div>
                    <!-- Additional Requirements (third, stacked) -->
                    <div style="width: 100%;">
                        <div class="table-title-container additional-reqs-title">
                            <h3>Additional Requirements</h3>
                            <button id="toggleAdditionalTableButton" class="show-more-btn" style="background-color: #fff; color: #d3a1b7;">Show more</button>
                        </div>
                        <table id="additionalRequirementsTable" class="styled-table" style="width: 100%; margin-top: 0; display: none;">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Level</th>
                                    <th>Cardinality</th>
                                    <th>Business Term</th>
                                    <th>Description</th>
                                    <th>Usage Note</th>
                                    <th>Type of Change</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Placeholder for future content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

<!----------------------------------------------------------------------------
        3/3 Supporting Artefacts tab
  ------------------------------------------------------------------------------>
            <div id="supportingArtefacts" class="tab-content">
                <div class="info-section">
                    <div class="info-table">

<!----------------------------------------------------------------------------
        URL Links
  ------------------------------------------------------------------------------>
                        <h3>Links</h3>
                        <div class="info-row">
                            <label>Specification Source Link:</label>
                            <span>
                                <a href="https://www.eascdc.com/invoicing/specifications/agdas.v1" target="_blank">
                                    https://wwww.loremipsum.com
                                </a>
                            </span>
                        </div>
                        <div class="info-row">
                            <label>Codelist(s):</label>
                            <span>
                                <a href="https://www.eascdc.com/invoicing/specifications/agdas.v1/codelists" target="_blank">
                                    https://wwww.loremipsum.com
                                </a>
                            </span>
                        </div>
                        <div class="info-row">
                            <label>Validation Artefacts:</label>
                            <span>
                                <a href="https://www.eascdc.com/invoicing/specifications/agdas.v1/validation" target="_blank">
                                    https://wwww.loremipsum.com
                                </a>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

<!----------------------------------------------------------------------------
        Some exclusive JavaScript for this page
------------------------------------------------------------------------------>
        <script>
            let currentSpecification = null; // Store the current specification data

            document.addEventListener("DOMContentLoaded", function () {
                console.log('ViewSpecification page loaded');
                
                // Initialize authentication manager
                window.authManager.init();
                
                // Get specification ID from URL or localStorage
                const params = new URLSearchParams(window.location.search);
                const specificationId = params.get('id') || localStorage.getItem('viewSpecificationId');
                
                console.log('DEBUG: Specification ID:', specificationId);
                console.log('DEBUG: URL params:', Object.fromEntries(params.entries()));
                console.log('DEBUG: Auth state:', {
                    isAuthenticated: window.authManager.isAuthenticated,
                    accessToken: window.authManager.accessToken ? 'Present' : 'Not present',
                    username: window.authManager.username
                });
                
                if (!specificationId) {
                    console.error('No specification ID provided');
                    showErrorMessage('Error: No specification ID provided. Please navigate from the My Specifications page.');
                    return;
                }
                
                // Note: Authentication is optional for viewing specifications since the API allows public access
                console.log('DEBUG: User authentication status:', {
                    isAuthenticated: window.authManager.isAuthenticated,
                    accessToken: window.authManager.accessToken ? 'Present' : 'Not present'
                });
                
                // Load the specification from API
                loadSpecificationById(specificationId);
            });

            async function loadSpecificationById(specificationId) {
                try {
                    console.log('Loading specification by ID:', specificationId);
                    showLoadingIndicator();
                    
                    // Try to get the specification from API (no authentication required for public viewing)
                    const response = await window.authManager.authenticatedFetch(`${AUTH_CONFIG.baseUrl}/specifications/${specificationId}`, {
                        method: 'GET'
                        // Removed forceAuth: true to allow unauthenticated access
                    });

                    console.log('DEBUG: API Response status:', response.status);

                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error('Specification not found. It may have been deleted or you may not have permission to view it.');
                        } else if (response.status === 403) {
                            throw new Error('Access denied. You do not have permission to view this specification.');
                        } else {
                            throw new Error(`Failed to load specification: HTTP ${response.status}`);
                        }
                    }

                    currentSpecification = await response.json();
                    console.log('DEBUG: Loaded specification:', currentSpecification);
                    
                    if (!currentSpecification) {
                        throw new Error('No specification data received from server');
                    }
                    
                    // Populate the page with specification data
                    await populateSpecificationData(currentSpecification);
                    
                    setupRegistryStatusUpdateListener(currentSpecification);

                    setupCoreTableToggle();

                    hideLoadingIndicator();
                    
                } catch (error) {
                    console.error('Error loading specification:', error);
                    hideLoadingIndicator();
                    showErrorMessage(`Failed to load specification: ${error.message}`);
                }
            }

            function setupCoreTableToggle() {
                const toggleButton = document.getElementById('toggleCoreTableButton');
                const coreTable = document.getElementById('coreInvoiceModelTable');

                if (toggleButton && coreTable) {
                    toggleButton.addEventListener('click', function() {
                        const isHidden = coreTable.style.display === 'none';
                        coreTable.style.display = isHidden ? 'table' : 'none';
                        this.textContent = isHidden ? 'Show less' : 'Show more';
                    });
                }
            }
            
            function populateSummaryTable(spec) {
                const detailsTableContainer = document.getElementById("detailsTableContainer");
                if (!detailsTableContainer) return;
                detailsTableContainer.innerHTML = ''; // Clear existing content
                
                const table = document.createElement("table");
                table.id = "detailsTable";
                table.style.width = "100%";
                table.style.border = "1px solid #ccc";
                table.style.borderCollapse = "collapse";
                
                // Create header row
                const headerRow = table.insertRow();
                const headers = ['Name', 'Purpose', 'Type', 'Sector', 'Country', 'Implementation Date', 'Status'];
                headers.forEach(header => {
                    const th = document.createElement("th");
                    th.textContent = header;
                    th.style.border = "1px solid #ccc";
                    th.style.padding = "8px";
                    th.style.backgroundColor = "#f5f5f5";
                    headerRow.appendChild(th);
                });
                
                // Create data row
                const dataRow = table.insertRow();
                const values = [
                    spec.specificationName || 'N/A',
                    spec.purpose || 'N/A',
                    spec.specificationType || 'N/A',
                    spec.sector || 'N/A',
                    spec.country || 'N/A',
                    spec.dateOfImplementation ? new Date(spec.dateOfImplementation).toLocaleDateString() : 'N/A',
                    spec.registrationStatus || spec.implementationStatus || 'N/A'
                ];
                
                values.forEach(value => {
                    const td = dataRow.insertCell();
                    td.textContent = value;
                    td.style.border = "1px solid #ccc";
                    td.style.padding = "8px";
                });
                
                detailsTableContainer.appendChild(table);
            }

            async function populateSpecificationData(spec) {
                try {
                    console.log('Populating specification data:', spec);
                    
                    // Create summary table at the top
                    createSummaryTable(spec);
                    
                    // Populate Identifying Information tab
                    populateIdentifyingInformation(spec);
                    
                    // Populate Specification Model tab (Core Invoice Model, Extension Components, Additional Requirements)
                    await populateSpecificationModel(spec);
                    
                    // Populate Supporting Artefacts tab
                    populateSupportingArtefacts(spec);
                    
                    populateRegistryStatusDropdown(spec);
                    // Set up edit button functionality
                    setupEditButton(spec);

                    
                    
                } catch (error) {
                    console.error('Error populating specification data:', error);
                    showErrorMessage(`Error displaying specification: ${error.message}`);
                }
            }

            function createSummaryTable(spec) {
                const detailsTableContainer = document.getElementById("detailsTableContainer");
                detailsTableContainer.innerHTML = ''; // Clear existing content
                
                const table = document.createElement("table");
                table.id = "detailsTable";
                table.style.width = "100%";
                table.style.border = "1px solid #ccc";
                table.style.borderCollapse = "collapse";
                
                // Create header row
                const headerRow = table.insertRow();
                const headers = ['Name', 'Purpose', 'Type', 'Sector', 'Country', 'Implementation Date', 'Status'];
                headers.forEach(header => {
                    const th = document.createElement("th");
                    th.textContent = header;
                    th.style.border = "1px solid #ccc";
                    th.style.padding = "8px";
                    th.style.backgroundColor = "#f5f5f5";
                    headerRow.appendChild(th);
                });
                
                // Create data row
                const dataRow = table.insertRow();
                const values = [
                    spec.specificationName || 'N/A',
                    spec.purpose || 'N/A',
                    spec.specificationType || 'N/A',
                    spec.sector || 'N/A',
                    spec.country || 'N/A',
                    spec.dateOfImplementation ? new Date(spec.dateOfImplementation).toLocaleDateString() : 'N/A',
                    spec.registrationStatus || spec.implementationStatus || 'N/A'
                ];
                
                values.forEach(value => {
                    const td = dataRow.insertCell();
                    td.textContent = value;
                    td.style.border = "1px solid #ccc";
                    td.style.padding = "8px";
                });
                
                detailsTableContainer.appendChild(table);
            }

            function populateIdentifyingInformation(spec) {
                // General Information
                document.getElementById("specificationName").textContent = spec.specificationName || 'N/A';
                document.getElementById("governingEntity").textContent = spec.governingEntity || 'N/A';
                document.getElementById("contactInformation").textContent = spec.contactInformation || 'N/A';
                document.getElementById("sector").textContent = spec.sector || 'N/A';
                document.getElementById("country").textContent = spec.country || 'N/A';
                document.getElementById("purpose").textContent = spec.purpose || 'N/A';
                
                // Technical Information
                document.getElementById("specificationIdentifier").textContent = spec.specificationIdentifier || 'N/A';
                document.getElementById("specificationVersion").textContent = spec.specificationVersion || 'N/A';
                document.getElementById("implementationDate").textContent = spec.dateOfImplementation ? 
                    new Date(spec.dateOfImplementation).toLocaleDateString() : 'N/A';
                document.getElementById("coreVersion").textContent = spec.coreVersion || 'N/A';
                document.getElementById("underlyingSpecification").textContent = spec.underlyingSpecificationIdentifier || 'N/A';
                document.getElementById("specificationSourceLink").textContent = spec.specificationSourceLink || 'N/A';
                document.getElementById("preferredSyntax").textContent = spec.preferredSyntax || 'N/A';
            }

            async function populateSpecificationModel(spec) {
                try {
                    console.log('DEBUG: Populating specification model with data:', {
                        specificationCores: spec.specificationCores,
                        specificationExtensionComponents: spec.specificationExtensionComponents,
                        additionalRequirements: spec.additionalRequirements
                    });
                    
                    const allCoreModelElements = await fetchCoreInvoiceModelsFromAPI();
                    const selectedCoreDataMap = new Map((spec.specificationCores || []).map(item => [item.businessTermID, item]));
                    const selectedElements = allCoreModelElements.filter(el => selectedCoreDataMap.has(el.id));

                    populateCoreInvoiceTable(selectedElements, selectedCoreDataMap);
                        let coreCount = selectedElements.length;
                        document.getElementById('coreModelCount').textContent = `${coreCount} element${coreCount === 1 ? '' : 's'}`;
                  
                    // Populate Extension Component table
                    await populateExtensionTable(spec)
                    

                    // Populate Additional Requirements table
                    const additionalTableBody = document.querySelector("#additionalRequirementsTable tbody");
                    const additionalTable = document.getElementById("additionalRequirementsTable");
                    const toggleAdditionalButton = document.getElementById("toggleAdditionalTableButton");
                    
                    additionalTableBody.innerHTML = '';

                    const additionalItems = (spec.additionalRequirements || []).filter(item => {
                        return item && (item.businessTermID || item.businessTermName || item.typeOfChange);
                    });

                    let additionalCount = additionalItems.length;
                    document.getElementById('additionalModelCount').textContent = `${additionalCount} element${additionalCount === 1 ? '' : 's'}`;

                    if (additionalCount > 0) {
                        if (toggleAdditionalButton) toggleAdditionalButton.style.display = 'block';

                        additionalItems.forEach(item => {
                            const row = additionalTableBody.insertRow();
                            row.insertCell().textContent = item.businessTermID || 'N/A';
                            row.insertCell().textContent = item.level || 'N/A';
                            row.insertCell().textContent = item.cardinality || 'N/A';
                            row.insertCell().textContent = item.businessTermName || 'N/A';
                            row.insertCell().textContent = item.semanticDescription || 'N/A';
                            row.insertCell().textContent = item.usageNote || 'N/A';
                            row.insertCell().textContent = item.typeOfChange || 'Additional Requirement';
                        });
                    } else {
                        if (toggleAdditionalButton) toggleAdditionalButton.style.display = 'none';
                        const row = additionalTableBody.insertRow();
                        const cell = row.insertCell();
                        cell.colSpan = 7; // Updated colspan
                        cell.textContent = 'No Additional Requirements specified';
                        cell.style.textAlign = 'center';
                        cell.style.fontStyle = 'italic';
                        cell.style.color = '#666';
                    }

                    if (toggleAdditionalButton && additionalTable) {
                        toggleAdditionalButton.addEventListener('click', function() {
                            const isHidden = additionalTable.style.display === 'none';
                            additionalTable.style.display = isHidden ? 'table' : 'none';
                            this.textContent = isHidden ? 'Show less' : 'Show more';
                        });
                    }
                    
                } catch (error) {
                    console.error('Error populating specification model:', error);
                    showErrorMessage('Error loading specification model data');
                }
            }

            async function fetchCoreInvoiceModelsFromAPI() {
                try {
                    const response = await window.authManager.authenticatedFetch(`${AUTH_CONFIG.baseUrl}/coreinvoicemodels?pageSize=1000`, { method: 'GET' });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    return Array.isArray(data) ? data : (data.items || []);
                } catch (error) {
                    console.error("Error fetching Core Invoice Model data from API:", error);
                    return [];
                }
            }

            function populateCoreInvoiceTable(selectedElements, selectedDataMap) {
                const tableBody = document.querySelector("#coreInvoiceModelTable tbody");
                tableBody.innerHTML = '';

                if (selectedElements.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="9" style="text-align:center;font-style:italic;color:#666;">No Core Invoice Model elements selected.</td></tr>';
                    return;
                }

                function getNumericLevel(levelStr) { return (levelStr || '').split('+').length - 1; }

                const processedElements = selectedElements.map(item => ({
                    ...item,
                    NumericLevel: getNumericLevel(item.level),
                    typeOfChange: selectedDataMap.get(item.id)?.typeOfChange || 'N/A',
                    children: []
                })).sort((a, b) => a.rowPos - b.rowPos);

                const roots = [];
                const parentTracker = {};
                processedElements.forEach(item => {
                    const directParent = parentTracker[item.NumericLevel - 1];
                    if (item.NumericLevel === 1) roots.push(item);
                    else if (directParent) directParent.children.push(item);
                    else roots.push(item);
                    parentTracker[item.NumericLevel] = item;
                    for (let i = item.NumericLevel + 1; i <= 5; i++) delete parentTracker[i];
                });

                function renderRowAndChildren(item, container) {
                    console.log(
                    'renderRowAndChildren debug:',
                    {
                        itemId: item.id,
                        selectedDataMapKeys: Array.from(selectedDataMap.keys()),
                        specCoreData: selectedDataMap.get(item.id),
                        coreBusinessRules: selectedDataMap.get(item.id)?.coreBusinessRules,
                        itemObj: item
                    }
                    );
                    const tr = document.createElement('tr');
                    if (item.id.startsWith('BG')) tr.classList.add(item.NumericLevel === 1 ? 'level-1-bg' : 'level-2-bg');
                    if (item.NumericLevel > 1) tr.classList.add('child-row');
                    if (item.children.length > 0 && item.id.startsWith('BG')) tr.classList.add('has-children-parent-row');
                    if (item.NumericLevel > 1) tr.style.display = 'none';
                    
                    tr.innerHTML = `
                        <td>${item.id || 'N/A'}</td> <td>${item.level || 'N/A'}</td> <td>${selectedDataMap.get(item.id)?.cardinality || 'N/A'}</td>
                        <td><i class="fa-solid fa-circle-question semantic-tooltip" title="${item.semanticDescription || ''}"></i> ${item.businessTerm || 'N/A'}</td>
                        <td>${selectedDataMap.get(item.id)?.usageNote || 'N/A'}</td> <td>${selectedDataMap.get(item.id)?.coreBusinessRules || 'N/A'}</td> <td>${item.dataType || 'N/A'}</td>
                        <td>${selectedDataMap.get(item.id)?.typeOfChange || 'N/A'}</td> <td class="actions-cell"></td>
                    `;
                    container.appendChild(tr);

                    if (item.children.length > 0) {
                        const immediateChildTrs = item.children.map(child => renderRowAndChildren(child, container));
                        const showMoreBtn = document.createElement('button');
                        showMoreBtn.className = 'show-more-btn';
                        showMoreBtn.textContent = 'Show more';
                        showMoreBtn.onclick = () => {
                            const isHidden = immediateChildTrs[0].style.display === 'none';
                            immediateChildTrs.forEach(childTr => childTr.style.display = isHidden ? '' : 'none');
                            showMoreBtn.textContent = isHidden ? 'Show less' : 'Show more';
                        };
                        tr.querySelector('.actions-cell').appendChild(showMoreBtn);
                    }
                    return tr;
                }

                roots.forEach(root => renderRowAndChildren(root, tableBody));
            }
            
            function getNumericDepthFromLevel(levelStr) {
                if (!levelStr) return 0;
                if (levelStr.includes('+')) {
                    return levelStr.split('+').length - 1; 
                }
                const parts = levelStr.split('.');
                if (parts.length > 0 && parts.every(part => !isNaN(parseInt(part)) && String(parseInt(part)) === part)) {
                    return parts.length; 
                }
                return 0;
            }

            function renderExtensionRowAndChildren(item, container, componentName) {
                const row = document.createElement('tr');
                
                const isXG = (item.businessTermID || '').startsWith('XG');
                const isXT = (item.businessTermID || '').startsWith('XT');
                const isBG = (item.businessTermID || '').startsWith('BG');
                
                if (item.NumericDepth > 1) { 
                    row.classList.add('child-row');
                    row.style.display = 'none';
                }
                
                if (isXG) {
                    row.classList.add(item.NumericDepth === 1 ? 'level-1-xg' : 'level-2-xg');
                    if (item.NumericDepth === 1) row.classList.add('parent-row');
                } else if (isXT) {
                    row.classList.add('level-xt');
                } else if (isBG) {
                    row.classList.add(item.NumericDepth === 1 ? 'level-1-bg' : 'level-2-bg');
                    if (item.NumericDepth === 1) row.classList.add('parent-row');
                }

                if (item.children && item.children.length > 0) {
                    row.classList.add('has-children-parent-row');
                }
                
                const usageNoteCombined = [item.usageNoteCore, item.usageNoteExtension, item.semanticDescription]
                    .filter(Boolean).join(' | ');

                row.innerHTML = `
                    <td>${componentName || 'N/A'}</td>
                    <td>${item.businessTermID || 'N/A'}</td>
                    <td>${item.level || 'N/A'}</td>
                    <td>${item.cardinality || 'N/A'}</td>
                    <td><i class="fa-solid fa-circle-question semantic-tooltip" title="${usageNoteCombined}"></i> ${item.businessTerm || 'N/A'}</td>
                    <td>${usageNoteCombined}</td>
                    <td>${item.justification || 'N/A'}</td>
                    <td>${item.dataType || 'N/A'}</td>
                    <td>${item.extensionType || 'N/A'}</td>
                    <td>${item.conformanceType || 'N/A'}</td>
                    <td class="actions-cell"></td>
                `;
                container.appendChild(row);

                if (item.children && item.children.length > 0) {
                    const immediateChildTrs = item.children.map(child => renderExtensionRowAndChildren(child, container, componentName));
                    
                    const showMoreBtn = document.createElement('button');
                    showMoreBtn.className = 'show-more-btn';
                    showMoreBtn.textContent = 'Show more';
                    
                    showMoreBtn.onclick = () => {
                        const isHidden = immediateChildTrs[0].style.display === 'none';
                        immediateChildTrs.forEach(childTr => childTr.style.display = isHidden ? '' : 'none');
                        showMoreBtn.textContent = isHidden ? 'Show less' : 'Show more';
                    };
                    
                    row.querySelector('.actions-cell').appendChild(showMoreBtn);
                }
                
                return row;
            }

            async function populateExtensionTable(spec) {
                const tableBody = document.querySelector("#extensionComponentDataTable tbody");
                const table = document.getElementById("extensionComponentDataTable");
                const toggleButton = document.getElementById("toggleExtensionTableButton");
                const countElement = document.getElementById('extensionModelCount');

                let totalSelectedElements = spec.specificationExtensionComponents?.length || 0;
                countElement.textContent = `${totalSelectedElements} element${totalSelectedElements === 1 ? '' : 's'}`;
                
                tableBody.innerHTML = '';

                if (totalSelectedElements === 0) {
                    tableBody.innerHTML = '<tr><td colspan="11" style="text-align:center;font-style:italic;color:#666;">No Extension Component Data Model elements selected.</td></tr>';
                    if (toggleButton) toggleButton.style.display = 'none';
                    return;
                }

                if (toggleButton) toggleButton.style.display = 'block';

                if (toggleButton && table) {
                    toggleButton.addEventListener('click', function() {
                        const isHidden = table.style.display === 'none';
                        table.style.display = isHidden ? 'table' : 'none';
                        this.textContent = isHidden ? 'Show less' : 'Show more';
                    });
                }

                try {
                    const headersResponse = await window.authManager.authenticatedFetch(`${AUTH_CONFIG.baseUrl}/extensionmodels/headers`);
                    if (!headersResponse.ok) throw new Error('Failed to load extension component headers.');
                    const headers = await headersResponse.json();
                    const componentNames = new Map(headers.map(h => [h.id, h.name]));

                    const selectedByComponent = spec.specificationExtensionComponents.reduce((acc, el) => {
                        const id = el.extensionComponentID;
                        if (!acc[id]) acc[id] = [];
                        acc[id].push(el.businessTermID);
                        return acc;
                    }, {});

                    const componentIds = Object.keys(selectedByComponent);
                    const componentElementPromises = componentIds.map(id =>
                        window.authManager.authenticatedFetch(`${AUTH_CONFIG.baseUrl}/extensionmodels/elements/${id}`).then(res => res.json())
                    );

                    const allComponentElementsResponses = await Promise.all(componentElementPromises);

                    allComponentElementsResponses.forEach((componentAllElements, index) => {
                        const componentId = componentIds[index];
                        const selectedIdsForComponent = new Set(selectedByComponent[componentId]);

                        const elementsToRender = componentAllElements.filter(el => selectedIdsForComponent.has(el.businessTermID));
                        const componentName = componentNames.get(componentId) || componentId;
                        
                        const processedElements = elementsToRender.map(item => ({
                            ...item,
                            NumericDepth: getNumericDepthFromLevel(item.level || ''),
                            children: []
                        })).sort((a, b) => {
                             const levelA = (a.level || '').split('.').map(Number);
                             const levelB = (b.level || '').split('.').map(Number);
                             for (let i = 0; i < Math.min(levelA.length, levelB.length); i++) {
                                 if (levelA[i] !== levelB[i]) return levelA[i] - levelB[i];
                             }
                             return levelA.length - levelB.length;
                        });

                        const roots = [];
                        const parentTracker = {};
                        processedElements.forEach(item => {
                            const parent = parentTracker[item.NumericDepth - 1];
                            if (item.NumericDepth === 1) roots.push(item);
                            else if (parent) parent.children.push(item);
                            else roots.push(item);
                            parentTracker[item.NumericDepth] = item;
                            for (let i = item.NumericDepth + 1; i <= 10; i++) delete parentTracker[i];
                        });

                        roots.forEach(root => renderExtensionRowAndChildren(root, tableBody, componentName));
                    });

                } catch (error) {
                    console.error("Error populating extension component table:", error);
                    tableBody.innerHTML = `<tr><td colspan="11" style="text-align:center;font-style:italic;color:red;">Error loading extension elements: ${error.message}</td></tr>`;
                }
            }

            function populateSupportingArtefacts(spec) {
                // Update the links in the Supporting Artefacts tab
                const specSourceLink = document.querySelector('#supportingArtefacts a[href*="loremipsum"]');
                if (specSourceLink && spec.specificationSourceLink) {
                    specSourceLink.href = spec.specificationSourceLink;
                    specSourceLink.textContent = spec.specificationSourceLink;
                }
                
                // For now, other links remain as placeholders since the API doesn't provide specific URLs
                // You would update these based on the actual data structure returned by the API
            }

            function setupEditButton(spec) {
                const editButton = document.getElementById("editSpecificationButton");
                const adminOnlyElements = document.querySelectorAll('.admin-only');
                
                if (editButton) {
                    if (window.authManager.isAuthenticated) {
                        // Show edit button for authenticated users
                        editButton.style.display = 'inline-block';
                        
                        // Check if user is admin to show admin-only controls
                        if (window.authManager.userRole === 'Admin') {
                            adminOnlyElements.forEach(element => {
                                element.style.display = 'flex';
                                element.style.alignItems = 'center';
                                element.style.gap = '5px';
                            });
                            console.log('DEBUG: Admin controls shown - user is admin');
                        } else {
                            // Hide admin controls for non-admin users (submitters)
                            adminOnlyElements.forEach(element => {
                                element.style.display = 'none';
                            });
                            console.log('DEBUG: Admin controls hidden - user is not admin');
                        }
                        
                        console.log('DEBUG: Edit button shown - user authenticated');
                    } else {
                        // Hide everything for unauthenticated users
                        editButton.style.display = 'none';
                        adminOnlyElements.forEach(element => {
                            element.style.display = 'none';
                        });
                        console.log('DEBUG: Edit button and admin controls hidden - user not authenticated');
                        return;
                    }
                    
                    editButton.addEventListener("click", function() 
                    {
                        if (spec.identityID) 
                        {
                            console.log('DEBUG: viewSpecification - Spec data for editing:', spec);
                            console.log('DEBUG: viewSpecification - Identity ID:', spec.identityID);
                            
                            // Get the current breadcrumb context to determine the source
                            const breadcrumbContext = window.breadcrumbManager.getContext();
                            const source = breadcrumbContext ? breadcrumbContext.source : 'mySpecs'; // Default to mySpecs if context is missing
                            console.log(`DEBUG: viewSpecification - Starting edit from source: ${source}`);
                            
                            console.log('DEBUG: viewSpecification - Navigating to edit mode for specification:', spec.specificationName);
                            
                            // Set return page to viewSpecification
                            localStorage.setItem("returnToPage", `viewSpecification.html?id=${spec.identityID}`);
                            
                            // Call the global editSpecification function with the correct source
                            editSpecification(spec.identityID, source);
                        } 
                        else 
                        {
                            console.error('DEBUG: viewSpecification - No identityID found in spec:', spec);
                            alert("Cannot edit: Specification ID not available.");
                        }
                    });
                }
            }

            // Utility functions for loading states and error handling
            function showLoadingIndicator() 
            {
                const detailsContainer = document.getElementById("detailsTableContainer");
                detailsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;"><i class="fa-solid fa-spinner fa-spin"></i> Loading specification...</div>';
            }

            function hideLoadingIndicator() 
            {
                // Loading indicator will be replaced by actual content in createSummaryTable
            }

            function showErrorMessage(message) 
            {
                const detailsContainer = document.getElementById("detailsTableContainer");
                detailsContainer.innerHTML = `
                    <div style="background: #fee; border: 1px solid #fcc; border-radius: 5px; padding: 15px; margin: 10px 0; color: #c33;">
                        <i class="fa-solid fa-exclamation-triangle"></i> <strong>Error:</strong> ${message}
                    </div>
                `;
                
                // Also clear the tabs since they won't have valid data
                document.getElementById("specificationName").textContent = 'N/A';
                document.getElementById("governingEntity").textContent = 'N/A';
                document.getElementById("sector").textContent = 'N/A';
                document.getElementById("country").textContent = 'N/A';
                document.getElementById("purpose").textContent = 'N/A';
                document.getElementById("specificationIdentifier").textContent = 'N/A';
                document.getElementById("specificationVersion").textContent = 'N/A';
                document.getElementById("implementationDate").textContent = 'N/A';
                document.getElementById("coreVersion").textContent = 'N/A';
                document.getElementById("underlyingSpecification").textContent = 'N/A';
                document.getElementById("specificationSourceLink").textContent = 'N/A';
                document.getElementById("preferredSyntax").textContent = 'N/A';
                
                // Clear tables
                const coreTableBody = document.querySelector("#coreInvoiceModelTable tbody");
                const extensionTableBody = document.querySelector("#extensionComponentDataTable tbody");
                const additionalTableBody = document.querySelector("#additionalRequirementsTable tbody");
                
                if (coreTableBody) coreTableBody.innerHTML = '';
                if (extensionTableBody) extensionTableBody.innerHTML = '';
                if (additionalTableBody) additionalTableBody.innerHTML = '';
            }

            // Tab switching logic (separate function to avoid conflicts)
            function showTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(content => 
                {
                    content.classList.remove('active');
                });
                document.querySelectorAll('.tab-button').forEach(button => 
                {
                    button.classList.remove('active');
                });
                document.getElementById(tabId).classList.add('active');
                event.target.classList.add('active');
                
                // Show/hide return to top button based on active tab
                const returnToTopBtn = document.getElementById('returnToTopBtn');
                if (returnToTopBtn) {
                    if (tabId === 'specificationModel') {
                        returnToTopBtn.style.display = 'block';
                    } else {
                        returnToTopBtn.style.display = 'none';
                    }
                }
            }

            function populateRegistryStatusDropdown(spec) 
            {
                const dropdown = document.getElementById("registryStatusDropdown");
                if (dropdown && spec && (spec.registrationStatus || spec.implementationStatus)) {
                    const currentStatus = spec.registrationStatus || spec.implementationStatus;
                    dropdown.value = currentStatus;
                    console.log(`DEBUG: Registry Status dropdown populated with: ${currentStatus}`);
                } else if (dropdown) {
                    dropdown.value = ""; // Clear if no status
                    console.log('DEBUG: No status found for dropdown, setting to empty.');
                }
            }

            function setupRegistryStatusUpdateListener(spec) {
                const updateButton = document.getElementById("updateStatusButton");
                const dropdown = document.getElementById("registryStatusDropdown");

                if (updateButton && dropdown && spec && spec.identityID) {
                    updateButton.onclick = async () => {
                        const newStatus = dropdown.value;
                        if (!newStatus) {
                            alert("Please select a status to update.");
                            return;
                        }
                        if (newStatus === spec.registrationStatus) {
                            alert("Status is already set to " + newStatus + ". No update needed.");
                            return;
                        }

                        if (!confirm(`Are you sure you want to change the Registry Status to "${newStatus}"?`)) {
                            return;
                        }

                        try {
                            // Show a temporary "Updating..." state for the button
                            updateButton.textContent = 'Updating...';
                            updateButton.disabled = true;

                            // Use dataManager to update the status
                            const dataManager = new SpecificationDataManager();
                            await dataManager.updateSpecificationStatus(spec.identityID, newStatus);

                            alert(`Registry Status for "${spec.specificationName}" updated to "${newStatus}" successfully!`);
                            // Update the displayed status immediately without full page reload
                            currentSpecification.registrationStatus = newStatus;
                            populateSummaryTable(currentSpecification); // Update top summary table
                            populateRegistryStatusDropdown(currentSpecification); // Update dropdown again
                            
                        } catch (error) {
                            console.error('Error updating Registry Status:', error);
                            alert('Failed to update Registry Status: ' + error.message);
                        } finally {
                            // Restore button state
                            updateButton.textContent = 'Update Status';
                            updateButton.disabled = false;
                        }
                    };
                    console.log('DEBUG: Registry Status update listener attached.');
                    
                    // Initial visibility check for the button and dropdown on page load
                    // This relies on `isAdmin()` from javascript.js and `updateVisibilityWithRoles()`
                    const adminControlsDiv = document.querySelector('.header-with-edit .admin-only');
                    if (adminControlsDiv) {
                        // Ensure visibility is correctly applied after DOM is ready
                        setTimeout(() => {
                            // Check if isAdmin() is globally available and true
                            if (typeof isAdmin === 'function' && isAdmin(window.authManager)) {
                                adminControlsDiv.style.display = 'block';
                            } else {
                                adminControlsDiv.style.display = 'none';
                            }
                        }, 100); // Small delay to ensure `isAdmin` and `authManager` are fully initialized
                    }
                } else {
                    console.warn('DEBUG: Could not set up Registry Status update listener (elements or spec.identityID missing).');
                }
            }

// Fast travel click handlers for model count boxes
(function() {
    document.addEventListener("DOMContentLoaded", function () {
        const fastTravelMap = [
            { boxId: "coreModelCountBox", tableId: "coreInvoiceModelTable" },
            { boxId: "extensionModelCountBox", tableId: "extensionComponentDataTable" },
            { boxId: "additionalModelCountBox", tableId: "additionalRequirementsTable" }
        ];
        fastTravelMap.forEach(({ boxId, tableId }) => {
            const box = document.getElementById(boxId);
            if (box) {
                box.addEventListener("click", function () {
                    const table = document.getElementById(tableId);
                    if (table) {
                        table.scrollIntoView({ behavior: "smooth", block: "start" });
                    }
                });
            }
        });
    });
})();
        </script>
        <script>
        // Return to Top button functionality
        document.addEventListener("DOMContentLoaded", function () {
            const btn = document.getElementById("returnToTopBtn");
            if (btn) {
                btn.addEventListener("click", function () {
                    window.scrollTo({ top: 0, behavior: "smooth" });
                });
            }
        });
        </script>
        
        <script>
            // Initialize the sidebar and authentication when the page loads
            document.addEventListener('DOMContentLoaded', function() {
                // Initialize auth manager
                window.authManager.init();
                
                // Initialize sidebar
                window.sidebarManager.initializeSidebar(window.authManager);
                
                // Initialize breadcrumb system
                window.breadcrumbManager.init();
                
                // Set breadcrumb context for this page (view specification)
                // For testing, let's set a default context if no spec is selected
                let viewingSpecId = localStorage.getItem("selectedSpecification") || 
                                   localStorage.getItem("viewSpecificationId") ||
                                   'DEMO_SPEC_001';
                
                console.log('DEBUG: viewSpecification - viewingSpecId:', viewingSpecId);
                
                // Always set a context for testing
                const context = {
                    currentPage: 'viewSpecification.html',
                    specId: viewingSpecId,
                    action: 'view'
                };
                
                // Determine source from referrer
                const referrer = document.referrer;
                console.log('DEBUG: viewSpecification - referrer:', referrer);
                
                if (referrer.includes('eInvoicingSpecificationRegistry.html')) {
                    context.source = 'registry';
                } else if (referrer.includes('governingEntityView.html')) {
                    context.source = 'govEntity';
                    } else if (referrer.includes('mySpecifications.html')) {
                    context.source = 'mySpecs';
                } else {
                    context.source = 'registry'; // Default to registry for view pages
                }
                
                console.log('DEBUG: viewSpecification - setting breadcrumb context:', context);
                window.breadcrumbManager.setContext(context);
                
                // Initialize return to top button visibility (hidden by default since 'identifyingInfo' tab is active)
                const returnToTopBtn = document.getElementById('returnToTopBtn');
                if (returnToTopBtn) {
                    returnToTopBtn.style.display = 'none';
                }
            });
        </script>
    </body>
</html>