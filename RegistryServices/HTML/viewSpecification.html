<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css">
        <link rel="stylesheet" href="../CSS/style.css">

        <!-- AuthManager.js provides global AuthManager and AUTH_CONFIG; initialization is now handled centrally -->
        <script src="../JS/auth/authManager.js"></script>
        <script>
        // Ensure global authManager is always initialized
        if (!window.authManager) {
            window.authManager = new window.AuthManager();
            console.debug('[DEBUG] window.authManager initialized globally in viewSpecification.html');
        }
        </script>
        <script src="../JS/sidebarManager.js"></script>
        <script src="../JS/breadcrumbManager.js"></script>
        <script src="../JS/javascript.js"></script>
        <script src="../JS/dataManager.js"></script>

        <title>Registry Services</title>
        <style>
            #sidebarContainer {
                position: relative;
                z-index: 1000;
            }
            /* Model count summary containers for Specification Model tab */
            .model-count-summary {
                display: flex;
                gap: 24px;
                margin-bottom: 24px;
                margin-top: 0;
                align-items: center;
                justify-content: center;
                text-align: center;
                flex-wrap: wrap;
            }
            .model-count-box {
                min-width: 270px;
                height: 90px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                border-radius: 8px;
                color: #fff;
                font-family: inherit;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
                text-align: center;
                margin-bottom: 16px;
                cursor: pointer;
                transition: box-shadow 0.2s, transform 0.2s, background 0.2s;
            }
            .model-count-box:hover {
                box-shadow: 0 4px 16px rgba(0,0,0,0.15);
                transform: scale(1.03);
                filter: brightness(1.08);
            }
            @media (max-width: 900px) {
                .model-count-box {
                    min-width: 180px;
                    height: 80px;
                    font-size: 0.95em;
                }
                .model-count-summary {
                    gap: 12px;
                }
            }
            @media (max-width: 600px) {
                .model-count-box {
                    min-width: 100px;
                    height: auto;
                    font-size: 0.9em;
                    padding: 10px 0;
                }
                .model-count-summary {
                    gap: 8px;
                }
            }
            .model-count-core {
                background: #0a9c1a;
            }
            .model-count-extension {
                background: #2576e6;
            }
            .model-count-additional {
                background: #d3a1b7;
            }
            .model-count-title {
                font-size: 1em;
                font-weight: 500;
                margin-bottom: 8px;
                text-align: center;
            }
            .model-count-value {
                font-size: 1.4em;
                font-weight: 600;
                text-align: center;
            }

/*********************************************************
 * Styling for the Edit button container        
 *********************************************************/
            .header-with-edit 
            {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 10px;
            }
            .edit-button-top-right 
            {
                padding: 5px 10px;
                font-size: 12px;
                color: #fff;
                background-color: #28a745;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                transition: background-color 0.3s ease;
            }
            .edit-button-top-right:hover 
            {
                background-color: #218838;
            }

            .action-buttons-container 
            {
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .tabs 
            {
                display: flex;
                gap: 0;
                margin-bottom: 16px;
                z-index: 10;
                position: relative;
            }
            .tab-button 
            {
                background: #f5f5f5;
                border: 1px solid #ccc;
                border-radius: 6px 6px 0 0;
                padding: 8px 24px;
                font-size: 1em;
                cursor: pointer;
                position: relative;
                z-index: 1;
                margin-right: -1px;
                transition: box-shadow 0.2s;
            }
            .tab-button.active 
            {
                background: #fff;
                border-bottom: 2px solid #0074d9;
                font-weight: bold;
                z-index: 2;
                box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            }
        </style>
    </head>
    <body>
        <div id="sidebarContainer">
            <!-- Sidebar will be dynamically generated by sidebarManager.js -->
        </div>
        <!-- Return to Top Button -->
        <button id="returnToTopBtn" style="position: fixed; right: 32px; bottom: 32px; z-index: 9999; background: #2576e6; color: #fff; border: none; border-radius: 50px; padding: 12px 28px; font-size: 1.1em; box-shadow: 0 2px 8px rgba(0,0,0,0.12); cursor: pointer; opacity: 0.92; transition: background 0.2s, opacity 0.2s; display: none;">
            <i class="fa-solid fa-arrow-up"></i> Return to Top
        </button>

        <div class="page-Content">
            <div id="breadcrumbContainer" class="breadcrumb-container">
                <!-- Breadcrumb will be dynamically generated by breadcrumbManager.js -->
            </div>
            <div class="header-with-edit">
                <h1><i class="fa-solid fa-house"></i> View Specification</h1>
                <div class="action-buttons-container">
                <div class="admin-only" style="display: flex; align-items: center; gap: 5px;">
                    <label for="registryStatusDropdown" style="font-size: 0.8em;">Registry Status:</label>
                    <select id="registryStatusDropdown" style="padding: 5px; border-radius: 4px; font-size: 0.8em;">
                        <option value="Submitted">Submitted</option>
                        <option value="Under Review">Under Review</option>
                        <option value="Verified">Verified</option>
                    </select>
                    <button id="updateStatusButton" class="view-button" style="margin-left: 0; font-size: 0.8em; padding: 5px 8px; ">Update Status</button>
                </div>
                <button id="editSpecificationButton" class="edit-button-top-right">Edit</button>
            </div>
            </div>
            <br/>
            <div id="detailsTableContainer"></div>
<!----------------------------------------------------------------------------
        The 3 tabs for the specification details
  ------------------------------------------------------------------------------>
            <div class="tabs">
                <button class="tab-button active" onclick="showTab('identifyingInfo')">Identifying Information</button>
                <button class="tab-button" onclick="showTab('specificationModel')">Specification Model</button>
                <button class="tab-button" onclick="showTab('supportingArtefacts')">Supporting Artefacts</button>
            </div>

<!----------------------------------------------------------------------------
        The content for each tab
        1/3 General Information
  ------------------------------------------------------------------------------>
            <div id="identifyingInfo" class="tab-content active">
                <div class="info-section">
                    <!-- General Information -->
                    <div class="info-table">
                        <h3>General Information</h3>
                        <div class="info-row">
                            <label>Specification Name:</label>
                            <span id="specificationName"></span>
                        </div>
                        <div class="info-row">
                            <label>Governing Entity:</label>
                            <span id="governingEntity"></span>
                        </div>
                        <div class="info-row">
                            <label>Contact Information:</label>
                            <span id="contactInformation">N/A</span>
                        </div>
                        <div class="info-row">
                            <label>Sector:</label>
                            <span id="sector"></span>
                        </div>
                        <div class="info-row">
                            <label>Country:</label>
                            <span id="country"></span>
                        </div>
                        <div class="info-row">
                            <label>Purpose:</label>
                            <span id="purpose"></span>
                        </div>
                    </div>

<!----------------------------------------------------------------------------
        Technical Information
  ------------------------------------------------------------------------------>
                    <div class="info-table">
                        <h3>Technical Information</h3>
                        <div class="info-row">
                            <label>Specification Identifier:</label>
                            <span id="specificationIdentifier"></span>
                        </div>
                        <div class="info-row">
                            <label>Specification Version:</label>
                            <span id="specificationVersion"></span>
                        </div>
                        <div class="info-row">
                            <label>Date of Implementation:</label>
                            <span id="implementationDate"></span>
                        </div>
                        <div class="info-row">
                            <label>Core Version:</label>
                            <span id="coreVersion"></span>
                        </div>
                        <div class="info-row">
                            <label>Underlying Specification:</label>
                            <span id="underlyingSpecification"></span>
                        </div>
                        <div class="info-row">
                            <label>Specification Source Link:</label>
                            <span id="specificationSourceLink"></span>
                        </div>
                        <div class="info-row">
                            <label>Preferred Syntax:</label>
                            <span id="preferredSyntax"></span>
                        </div>
                    </div>
                </div>
            </div>

<!----------------------------------------------------------------------------
        2/3 Specification Model tab
  ------------------------------------------------------------------------------>
            <div id="specificationModel" class="tab-content">
                <!-- Model count summary containers -->
                <div class="model-count-summary" id="modelCountSummary">
                    <div class="model-count-box model-count-core" id="coreModelCountBox">
                        <div class="model-count-title">Core Invoice Data Model</div>
                        <div class="model-count-value" id="coreModelCount">0 elements</div>
                    </div>
                    <div class="model-count-box model-count-extension" id="extensionModelCountBox">
                        <div class="model-count-title">Extension Component Data Model</div>
                        <div class="model-count-value" id="extensionModelCount">0 elements</div>
                    </div>
                    <div class="model-count-box model-count-additional" id="additionalModelCountBox">
                        <div class="model-count-title">Additional Requirements</div>
                        <div class="model-count-value" id="additionalModelCount">0 elements</div>
                    </div>
                </div>
                <div class="info-section" style="display: flex; flex-direction: column; gap: 24px;">
                    <!-- Selected Core Invoice Model elements (first, stacked) -->
                    <div class="info-table" style="width: 100%;">
                        <h3>Selected Core Invoice Model elements</h3>
                        <table id="coreInvoiceModelTable" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Business Term</th>
                                    <th>Type of Change</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Rows are dynamically populated -->
                            </tbody>
                        </table>
                    </div>
                    <!-- Selected Extension Component Data Model elements (second, stacked) -->
                    <div class="info-table" style="width: 100%;">
                        <h3>Selected Extension Component Data Model elements</h3>
                        <table id="extensionComponentTable" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Business Term</th>
                                    <th>Extension Component</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Placeholder -->
                            </tbody>
                        </table>
                    </div>
                    <!-- Additional Requirements (third, stacked) -->
                    <div class="info-table" style="width: 100%;">
                        <h3>Additional Requirements</h3>
                        <table id="additionalRequirementsTable" style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Business Term</th>
                                    <th>Type of Change</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Placeholder for future content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

<!----------------------------------------------------------------------------
        3/3 Supporting Artefacts tab
  ------------------------------------------------------------------------------>
            <div id="supportingArtefacts" class="tab-content">
                <div class="info-section">
                    <div class="info-table">

<!----------------------------------------------------------------------------
        URL Links
  ------------------------------------------------------------------------------>
                        <h3>Links</h3>
                        <div class="info-row">
                            <label>Specification Source Link:</label>
                            <span>
                                <a href="https://www.eascdc.com/invoicing/specifications/agdas.v1" target="_blank">
                                    https://wwww.loremipsum.com
                                </a>
                            </span>
                        </div>
                        <div class="info-row">
                            <label>Codelist(s):</label>
                            <span>
                                <a href="https://www.eascdc.com/invoicing/specifications/agdas.v1/codelists" target="_blank">
                                    https://wwww.loremipsum.com
                                </a>
                            </span>
                        </div>
                        <div class="info-row">
                            <label>Validation Artefacts:</label>
                            <span>
                                <a href="https://www.eascdc.com/invoicing/specifications/agdas.v1/validation" target="_blank">
                                    https://wwww.loremipsum.com
                                </a>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

<!----------------------------------------------------------------------------
        Some exclusive JavaScript for this page
------------------------------------------------------------------------------>
        <script>
            let currentSpecification = null; // Store the current specification data

            document.addEventListener("DOMContentLoaded", function () {
                console.log('ViewSpecification page loaded');
                
                // Initialize authentication manager
                window.authManager.init();
                
                // Get specification ID from URL or localStorage
                const params = new URLSearchParams(window.location.search);
                const specificationId = params.get('id') || localStorage.getItem('viewSpecificationId');
                
                console.log('DEBUG: Specification ID:', specificationId);
                console.log('DEBUG: URL params:', Object.fromEntries(params.entries()));
                console.log('DEBUG: Auth state:', {
                    isAuthenticated: window.authManager.isAuthenticated,
                    accessToken: window.authManager.accessToken ? 'Present' : 'Not present',
                    username: window.authManager.username
                });
                
                if (!specificationId) {
                    console.error('No specification ID provided');
                    showErrorMessage('Error: No specification ID provided. Please navigate from the My Specifications page.');
                    return;
                }
                
                // Note: Authentication is optional for viewing specifications since the API allows public access
                console.log('DEBUG: User authentication status:', {
                    isAuthenticated: window.authManager.isAuthenticated,
                    accessToken: window.authManager.accessToken ? 'Present' : 'Not present'
                });
                
                // Load the specification from API
                loadSpecificationById(specificationId);
            });

            async function loadSpecificationById(specificationId) {
                try {
                    console.log('Loading specification by ID:', specificationId);
                    showLoadingIndicator();
                    
                    // Try to get the specification from API (no authentication required for public viewing)
                    const response = await window.authManager.authenticatedFetch(`${AUTH_CONFIG.baseUrl}/specifications/${specificationId}`, {
                        method: 'GET'
                        // Removed forceAuth: true to allow unauthenticated access
                    });

                    console.log('DEBUG: API Response status:', response.status);

                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error('Specification not found. It may have been deleted or you may not have permission to view it.');
                        } else if (response.status === 403) {
                            throw new Error('Access denied. You do not have permission to view this specification.');
                        } else {
                            throw new Error(`Failed to load specification: HTTP ${response.status}`);
                        }
                    }

                    currentSpecification = await response.json();
                    console.log('DEBUG: Loaded specification:', currentSpecification);
                    
                    if (!currentSpecification) {
                        throw new Error('No specification data received from server');
                    }
                    
                    // Populate the page with specification data
                    await populateSpecificationData(currentSpecification);
                    
                    setupRegistryStatusUpdateListener(currentSpecification);

                    hideLoadingIndicator();
                    
                } catch (error) {
                    console.error('Error loading specification:', error);
                    hideLoadingIndicator();
                    showErrorMessage(`Failed to load specification: ${error.message}`);
                }
            }

            function populateSummaryTable(spec) {
                const detailsTableContainer = document.getElementById("detailsTableContainer");
                if (!detailsTableContainer) return;
                detailsTableContainer.innerHTML = ''; // Clear existing content
                
                const table = document.createElement("table");
                table.id = "detailsTable";
                table.style.width = "100%";
                table.style.border = "1px solid #ccc";
                table.style.borderCollapse = "collapse";
                
                // Create header row
                const headerRow = table.insertRow();
                const headers = ['Name', 'Purpose', 'Type', 'Sector', 'Country', 'Implementation Date', 'Status'];
                headers.forEach(header => {
                    const th = document.createElement("th");
                    th.textContent = header;
                    th.style.border = "1px solid #ccc";
                    th.style.padding = "8px";
                    th.style.backgroundColor = "#f5f5f5";
                    headerRow.appendChild(th);
                });
                
                // Create data row
                const dataRow = table.insertRow();
                const values = [
                    spec.specificationName || 'N/A',
                    spec.purpose || 'N/A',
                    spec.specificationType || 'N/A',
                    spec.sector || 'N/A',
                    spec.country || 'N/A',
                    spec.dateOfImplementation ? new Date(spec.dateOfImplementation).toLocaleDateString() : 'N/A',
                    spec.registrationStatus || spec.implementationStatus || 'N/A'
                ];
                
                values.forEach(value => {
                    const td = dataRow.insertCell();
                    td.textContent = value;
                    td.style.border = "1px solid #ccc";
                    td.style.padding = "8px";
                });
                
                detailsTableContainer.appendChild(table);
            }

            async function populateSpecificationData(spec) {
                try {
                    console.log('Populating specification data:', spec);
                    
                    // Create summary table at the top
                    createSummaryTable(spec);
                    
                    // Populate Identifying Information tab
                    populateIdentifyingInformation(spec);
                    
                    // Populate Specification Model tab (Core Invoice Model, Extension Components, Additional Requirements)
                    await populateSpecificationModel(spec);
                    
                    // Populate Supporting Artefacts tab
                    populateSupportingArtefacts(spec);
                    
                    populateRegistryStatusDropdown(spec);
                    // Set up edit button functionality
                    setupEditButton(spec);

                    
                    
                } catch (error) {
                    console.error('Error populating specification data:', error);
                    showErrorMessage(`Error displaying specification: ${error.message}`);
                }
            }

            function createSummaryTable(spec) {
                const detailsTableContainer = document.getElementById("detailsTableContainer");
                detailsTableContainer.innerHTML = ''; // Clear existing content
                
                const table = document.createElement("table");
                table.id = "detailsTable";
                table.style.width = "100%";
                table.style.border = "1px solid #ccc";
                table.style.borderCollapse = "collapse";
                
                // Create header row
                const headerRow = table.insertRow();
                const headers = ['Name', 'Purpose', 'Type', 'Sector', 'Country', 'Implementation Date', 'Status'];
                headers.forEach(header => {
                    const th = document.createElement("th");
                    th.textContent = header;
                    th.style.border = "1px solid #ccc";
                    th.style.padding = "8px";
                    th.style.backgroundColor = "#f5f5f5";
                    headerRow.appendChild(th);
                });
                
                // Create data row
                const dataRow = table.insertRow();
                const values = [
                    spec.specificationName || 'N/A',
                    spec.purpose || 'N/A',
                    spec.specificationType || 'N/A',
                    spec.sector || 'N/A',
                    spec.country || 'N/A',
                    spec.dateOfImplementation ? new Date(spec.dateOfImplementation).toLocaleDateString() : 'N/A',
                    spec.registrationStatus || spec.implementationStatus || 'N/A'
                ];
                
                values.forEach(value => {
                    const td = dataRow.insertCell();
                    td.textContent = value;
                    td.style.border = "1px solid #ccc";
                    td.style.padding = "8px";
                });
                
                detailsTableContainer.appendChild(table);
            }

            function populateIdentifyingInformation(spec) {
                // General Information
                document.getElementById("specificationName").textContent = spec.specificationName || 'N/A';
                document.getElementById("governingEntity").textContent = spec.governingEntity || 'N/A';
                document.getElementById("contactInformation").textContent = spec.contactInformation || 'N/A';
                document.getElementById("sector").textContent = spec.sector || 'N/A';
                document.getElementById("country").textContent = spec.country || 'N/A';
                document.getElementById("purpose").textContent = spec.purpose || 'N/A';
                
                // Technical Information
                document.getElementById("specificationIdentifier").textContent = spec.specificationIdentifier || 'N/A';
                document.getElementById("specificationVersion").textContent = spec.specificationVersion || 'N/A';
                document.getElementById("implementationDate").textContent = spec.dateOfImplementation ? 
                    new Date(spec.dateOfImplementation).toLocaleDateString() : 'N/A';
                document.getElementById("coreVersion").textContent = spec.coreVersion || 'N/A';
                document.getElementById("underlyingSpecification").textContent = spec.underlyingSpecificationIdentifier || 'N/A';
                document.getElementById("specificationSourceLink").textContent = spec.specificationSourceLink || 'N/A';
                document.getElementById("preferredSyntax").textContent = spec.preferredSyntax || 'N/A';
            }

            async function populateSpecificationModel(spec) {
                try {
                    console.log('DEBUG: Populating specification model with data:', {
                        specificationCores: spec.specificationCores,
                        specificationExtensionComponents: spec.specificationExtensionComponents,
                        additionalRequirements: spec.additionalRequirements
                    });
                    
                    // Populate Core Invoice Model table
                    const coreTableBody = document.querySelector("#coreInvoiceModelTable tbody");
                    coreTableBody.innerHTML = '';
                    const coreItems = spec.specificationCores || [];
                    let coreCount = 0;
                    if (coreItems.length > 0) {
                        coreItems.forEach(item => {
                            const row = coreTableBody.insertRow();
                            row.insertCell().textContent = item.businessTermID || 'N/A';
                            row.insertCell().textContent = item.coreBusinessTerm || 'N/A';
                            row.insertCell().textContent = item.typeOfChange || 'Core Element';
                        });
                        coreCount = coreItems.length;
                    } else {
                        const row = coreTableBody.insertRow();
                        const cell = row.insertCell();
                        cell.colSpan = 3;
                        cell.textContent = 'No Core Invoice Model elements selected';
                        cell.style.textAlign = 'center';
                        cell.style.fontStyle = 'italic';
                        cell.style.color = '#666';
                        coreCount = 0;
                    }
                    document.getElementById('coreModelCount').textContent = `${coreCount} element${coreCount === 1 ? '' : 's'}`;

                    // Populate Extension Component table
                    const extensionTableBody = document.querySelector("#extensionComponentTable tbody");
                    extensionTableBody.innerHTML = '';
                    const extensionItems = spec.specificationExtensionComponents || [];
                    let extensionCount = 0;
                    if (extensionItems.length > 0) {
                        extensionItems.forEach(item => {
                            const row = extensionTableBody.insertRow();
                            row.insertCell().textContent = item.businessTermID || 'N/A';
                            row.insertCell().textContent = item.extBusinessTerm || 'N/A';
                            row.insertCell().textContent = item.extensionComponentID || 'Extension Component';
                        });
                        extensionCount = extensionItems.length;
                    } else {
                        const row = extensionTableBody.insertRow();
                        const cell = row.insertCell();
                        cell.colSpan = 3;
                        cell.textContent = 'No Extension Component Data Model elements selected';
                        cell.style.textAlign = 'center';
                        cell.style.fontStyle = 'italic';
                        cell.style.color = '#666';
                        extensionCount = 0;
                    }
                    document.getElementById('extensionModelCount').textContent = `${extensionCount} element${extensionCount === 1 ? '' : 's'}`;

                    // Populate Additional Requirements table
                    const additionalTableBody = document.querySelector("#additionalRequirementsTable tbody");
                    additionalTableBody.innerHTML = '';
                    const additionalItems = (spec.additionalRequirements || []).filter(item => {
                        // Only count rows with at least one non-empty property
                        return item && (item.businessTermID || item.businessTermName || item.typeOfChange);
                    });
                    let additionalCount = 0;
                    if (additionalItems.length > 0) {
                        additionalItems.forEach(item => {
                            const row = additionalTableBody.insertRow();
                            row.insertCell().textContent = item.businessTermID || 'N/A';
                            row.insertCell().textContent = item.businessTermName || 'N/A';
                            row.insertCell().textContent = item.typeOfChange || 'Additional Requirement';
                        });
                        additionalCount = additionalItems.length;
                    } else {
                        const row = additionalTableBody.insertRow();
                        const cell = row.insertCell();
                        cell.colSpan = 3;
                        cell.textContent = 'No Additional Requirements specified';
                        cell.style.textAlign = 'center';
                        cell.style.fontStyle = 'italic';
                        cell.style.color = '#666';
                        additionalCount = 0;
                    }
                    document.getElementById('additionalModelCount').textContent = `${additionalCount} element${additionalCount === 1 ? '' : 's'}`;
                    
                } catch (error) {
                    console.error('Error populating specification model:', error);
                    showErrorMessage('Error loading specification model data');
                }
            }

            function populateSupportingArtefacts(spec) {
                // Update the links in the Supporting Artefacts tab
                const specSourceLink = document.querySelector('#supportingArtefacts a[href*="loremipsum"]');
                if (specSourceLink && spec.specificationSourceLink) {
                    specSourceLink.href = spec.specificationSourceLink;
                    specSourceLink.textContent = spec.specificationSourceLink;
                }
                
                // For now, other links remain as placeholders since the API doesn't provide specific URLs
                // You would update these based on the actual data structure returned by the API
            }

            function setupEditButton(spec) {
                const editButton = document.getElementById("editSpecificationButton");
                if (editButton) {
                    // SCRUM - 151: Hide Edit button for unauthenticated users
                    if (!window.authManager.isAuthenticated) {
                        editButton.style.display = 'none';
                        console.log('DEBUG: Edit button hidden - user not authenticated');
                        return;
                    }
                    
                    editButton.style.display = 'inline-block';
                    
                    editButton.addEventListener("click", function() 
                    {
                        if (spec.identityID) 
                        {
                            console.log('DEBUG: viewSpecification - Spec data for editing:', spec);
                            console.log('DEBUG: viewSpecification - Identity ID:', spec.identityID);
                            console.log('DEBUG: viewSpecification - Navigating to edit mode for specification:', spec.specificationName);
                            
                            // Set return page to viewSpecification
                            localStorage.setItem("returnToPage", "viewSpecification.html?id=" + spec.identityID);
                            
                            // Set breadcrumb context for edit workflow from view page
                            if (window.breadcrumbManager) 
                            {
                                const currentContext = window.breadcrumbManager.getContext();
                                const editContext = 
                                {
                                    source: currentContext ? currentContext.source : 'registry',
                                    action: 'edit',
                                    currentPage: 'IdentifyingInformation.html',
                                    specId: spec.identityID,
                                    specIdentityId: spec.identityID
                                };
                                window.breadcrumbManager.setContext(editContext);
                            }
                            
                            // Call the global editSpecification function
                            editSpecification(spec.identityID);
                        } 
                        else 
                        {
                            console.error('DEBUG: viewSpecification - No identityID found in spec:', spec);
                            alert("Cannot edit: Specification ID not available.");
                        }
                    });
                }
            }

            // Utility functions for loading states and error handling
            function showLoadingIndicator() 
            {
                const detailsContainer = document.getElementById("detailsTableContainer");
                detailsContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;"><i class="fa-solid fa-spinner fa-spin"></i> Loading specification...</div>';
            }

            function hideLoadingIndicator() 
            {
                // Loading indicator will be replaced by actual content in createSummaryTable
            }

            function showErrorMessage(message) 
            {
                const detailsContainer = document.getElementById("detailsTableContainer");
                detailsContainer.innerHTML = `
                    <div style="background: #fee; border: 1px solid #fcc; border-radius: 5px; padding: 15px; margin: 10px 0; color: #c33;">
                        <i class="fa-solid fa-exclamation-triangle"></i> <strong>Error:</strong> ${message}
                    </div>
                `;
                
                // Also clear the tabs since they won't have valid data
                document.getElementById("specificationName").textContent = 'N/A';
                document.getElementById("governingEntity").textContent = 'N/A';
                document.getElementById("sector").textContent = 'N/A';
                document.getElementById("country").textContent = 'N/A';
                document.getElementById("purpose").textContent = 'N/A';
                document.getElementById("specificationIdentifier").textContent = 'N/A';
                document.getElementById("specificationVersion").textContent = 'N/A';
                document.getElementById("implementationDate").textContent = 'N/A';
                document.getElementById("coreVersion").textContent = 'N/A';
                document.getElementById("underlyingSpecification").textContent = 'N/A';
                document.getElementById("specificationSourceLink").textContent = 'N/A';
                document.getElementById("preferredSyntax").textContent = 'N/A';
                
                // Clear tables
                const coreTableBody = document.querySelector("#coreInvoiceModelTable tbody");
                const extensionTableBody = document.querySelector("#extensionComponentTable tbody");
                const additionalTableBody = document.querySelector("#additionalRequirementsTable tbody");
                
                if (coreTableBody) coreTableBody.innerHTML = '';
                if (extensionTableBody) extensionTableBody.innerHTML = '';
                if (additionalTableBody) additionalTableBody.innerHTML = '';
            }

            // Tab switching logic (separate function to avoid conflicts)
            function showTab(tabId) {
                document.querySelectorAll('.tab-content').forEach(content => 
                {
                    content.classList.remove('active');
                });
                document.querySelectorAll('.tab-button').forEach(button => 
                {
                    button.classList.remove('active');
                });
                document.getElementById(tabId).classList.add('active');
                event.target.classList.add('active');
                
                // Show/hide return to top button based on active tab
                const returnToTopBtn = document.getElementById('returnToTopBtn');
                if (returnToTopBtn) {
                    if (tabId === 'specificationModel') {
                        returnToTopBtn.style.display = 'block';
                    } else {
                        returnToTopBtn.style.display = 'none';
                    }
                }
            }

            function populateRegistryStatusDropdown(spec) 
            {
                const dropdown = document.getElementById("registryStatusDropdown");
                if (dropdown && spec && (spec.registrationStatus || spec.implementationStatus)) {
                    const currentStatus = spec.registrationStatus || spec.implementationStatus;
                    dropdown.value = currentStatus;
                    console.log(`DEBUG: Registry Status dropdown populated with: ${currentStatus}`);
                } else if (dropdown) {
                    dropdown.value = ""; // Clear if no status
                    console.log('DEBUG: No status found for dropdown, setting to empty.');
                }
            }

            function setupRegistryStatusUpdateListener(spec) {
                const updateButton = document.getElementById("updateStatusButton");
                const dropdown = document.getElementById("registryStatusDropdown");

                if (updateButton && dropdown && spec && spec.identityID) {
                    updateButton.onclick = async () => {
                        const newStatus = dropdown.value;
                        if (!newStatus) {
                            alert("Please select a status to update.");
                            return;
                        }
                        if (newStatus === spec.registrationStatus) {
                            alert("Status is already set to " + newStatus + ". No update needed.");
                            return;
                        }

                        if (!confirm(`Are you sure you want to change the Registry Status to "${newStatus}"?`)) {
                            return;
                        }

                        try {
                            // Show a temporary "Updating..." state for the button
                            updateButton.textContent = 'Updating...';
                            updateButton.disabled = true;

                            // Use dataManager to update the status
                            const dataManager = new SpecificationDataManager();
                            await dataManager.updateSpecificationStatus(spec.identityID, newStatus);

                            alert(`Registry Status for "${spec.specificationName}" updated to "${newStatus}" successfully!`);
                            // Update the displayed status immediately without full page reload
                            currentSpecification.registrationStatus = newStatus;
                            populateSummaryTable(currentSpecification); // Update top summary table
                            populateRegistryStatusDropdown(currentSpecification); // Update dropdown again
                            
                        } catch (error) {
                            console.error('Error updating Registry Status:', error);
                            alert('Failed to update Registry Status: ' + error.message);
                        } finally {
                            // Restore button state
                            updateButton.textContent = 'Update Status';
                            updateButton.disabled = false;
                        }
                    };
                    console.log('DEBUG: Registry Status update listener attached.');
                    
                    // Initial visibility check for the button and dropdown on page load
                    // This relies on `isAdmin()` from javascript.js and `updateVisibilityWithRoles()`
                    const adminControlsDiv = document.querySelector('.header-with-edit .admin-only');
                    if (adminControlsDiv) {
                        // Ensure visibility is correctly applied after DOM is ready
                        setTimeout(() => {
                            // Check if isAdmin() is globally available and true
                            if (typeof isAdmin === 'function' && isAdmin(window.authManager)) {
                                adminControlsDiv.style.display = 'block';
                            } else {
                                adminControlsDiv.style.display = 'none';
                            }
                        }, 100); // Small delay to ensure `isAdmin` and `authManager` are fully initialized
                    }
                } else {
                    console.warn('DEBUG: Could not set up Registry Status update listener (elements or spec.identityID missing).');
                }
            }

// Fast travel click handlers for model count boxes
(function() {
    document.addEventListener("DOMContentLoaded", function () {
        const fastTravelMap = [
            { boxId: "coreModelCountBox", tableId: "coreInvoiceModelTable" },
            { boxId: "extensionModelCountBox", tableId: "extensionComponentTable" },
            { boxId: "additionalModelCountBox", tableId: "additionalRequirementsTable" }
        ];
        fastTravelMap.forEach(({ boxId, tableId }) => {
            const box = document.getElementById(boxId);
            if (box) {
                box.addEventListener("click", function () {
                    const table = document.getElementById(tableId);
                    if (table) {
                        table.scrollIntoView({ behavior: "smooth", block: "start" });
                    }
                });
            }
        });
    });
})();
        </script>
        <script>
        // Return to Top button functionality
        document.addEventListener("DOMContentLoaded", function () {
            const btn = document.getElementById("returnToTopBtn");
            if (btn) {
                btn.addEventListener("click", function () {
                    window.scrollTo({ top: 0, behavior: "smooth" });
                });
            }
        });
        </script>
        
        <script>
            // Initialize the sidebar and authentication when the page loads
            document.addEventListener('DOMContentLoaded', function() {
                // Initialize auth manager
                window.authManager.init();
                
                // Initialize sidebar
                window.sidebarManager.initializeSidebar(window.authManager);
                
                // Initialize breadcrumb system
                window.breadcrumbManager.init();
                
                // Set breadcrumb context for this page (view specification)
                // For testing, let's set a default context if no spec is selected
                let viewingSpecId = localStorage.getItem("selectedSpecification") || 
                                   localStorage.getItem("viewSpecificationId") ||
                                   'DEMO_SPEC_001';
                
                console.log('DEBUG: viewSpecification - viewingSpecId:', viewingSpecId);
                
                // Always set a context for testing
                const context = {
                    currentPage: 'viewSpecification.html',
                    specId: viewingSpecId,
                    action: 'view'
                };
                
                // Determine source from referrer
                const referrer = document.referrer;
                console.log('DEBUG: viewSpecification - referrer:', referrer);
                
                if (referrer.includes('eInvoicingSpecificationRegistry.html')) {
                    context.source = 'registry';
                } else if (referrer.includes('mySpecifications.html')) {
                    context.source = 'mySpecs';
                } else {
                    context.source = 'registry'; // Default to registry for view pages
                }
                
                console.log('DEBUG: viewSpecification - setting breadcrumb context:', context);
                window.breadcrumbManager.setContext(context);
                
                // Initialize return to top button visibility (hidden by default since 'identifyingInfo' tab is active)
                const returnToTopBtn = document.getElementById('returnToTopBtn');
                if (returnToTopBtn) {
                    returnToTopBtn.style.display = 'none';
                }
            });
        </script>
    </body>
</html>