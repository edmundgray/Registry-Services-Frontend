<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <link rel="stylesheet" href="../CSS/style.css">
        
        <script src="../JS/javascript.js"></script>
        
        <title>Governing Entities</title>
    </head>
    <body>
<!----------------------------------------------------------------------------
            Sidebar
  ------------------------------------------------------------------------------>
        <div class="sidebar">
            <ul>
                <li>
                    <a class="logo">
                        <span class="icon">
                            <img src="../Images/genericLogo.png" alt="Sidebar Logo" style="width: 40px; height: 40px;">
                        </span>
                        <span class="text">Registry Services</span>
                    </a>
                </li>
                <li>
                    <a href="eInvoicingSpecificationRegistry.html">
                        <span class="icon"><i class="fa-solid fa-house"></i></span>
                        <span class="text">eInvoicing Specification Registry</span>
                    </a>
                </li>
                <li class="protected">
                    <a href="governingEntityList.html">
                        <span class="icon"><i class="fa-solid fa-building"></i></span>
                        <span class="text">Governing Entities</span>
                    </a>
                </li>
                <li class="protected">
                    <a href="mySpecifications.html">
                        <span class="icon"><i class="fa-solid fa-folder"></i></span>
                        <span class="text">My Specifications</span>
                    </a>
                </li>
                <li class="protected">
                    <a href="#">
                        <span class="icon"><i class="fa-solid fa-file-medical"></i></span>
                        <span class="text">Add New Specification</span>
                    </a>
                </li>
                <li class="child-element protected">
                    <a href="IdentifyingInformation.html">
                        <span class="icon"><i class="fa-solid fa-info"></i></span>
                        <span class="text">Identifying Information</span>
                    </a>
                </li>
                <li class="child-element">
                    <a href="coreInvoiceModel.html">
                        <span class="icon"><i class="fa-solid fa-car"></i></span>
                        <span class="text">Core Invoice Model</span>
                    </a>
                </li>
                <li class="child-element">
                    <a href="ExtensionComponentDataModel.html">
                        <span class="icon"><i class="fa-solid fa-trailer"></i></span>
                        <span class="text">Extension Component Data Model</span>
                    </a>
                </li>
                <li class="child-element protected">
                    <a href="additionalRequirements.html">
                        <span class="icon"><i class="fa-solid fa-circle-plus"></i></span>
                        <span class="text">Additional Requirements</span>
                    </a>
                </li>
                <li class="child-element protected">
                    <a href="specificationPreview.html">
                        <span class="icon"><i class="fa-solid fa-square-check"></i></span>
                        <span class="text">Specification Preview</span>
                    </a>
                </li>
                <li id="loginLogoutItem">
                    <a href="#" onclick="toggleLogin()">
                        <span class="icon"><i class="fa-solid fa-right-from-bracket"></i></span>
                        <span class="text" id="loginLogoutButton">Logout</span>
                    </a>
                </li>
            </ul>
        </div>

<!----------------------------------------------------------------------------
            Governing Entities Table
  ------------------------------------------------------------------------------>
        <div class="page-Content">
            <h1 id="entityTitle"><i class="fa-solid fa-building"></i> Viewing Governing Entity</h1>
            <br/>
            <button onclick="window.location.href='governingEntityList.html';">Return to Governing Entity List</button>

            <div id="entityDetails"></div>
            <div id="specificationsSection"></div>
            <div id="usersSection"></div>
        </div>
<script>
    // This function makes the 'Edit' button work.
    function startEdit(event) {
        const button = event.target;
        const specName = button.getAttribute('data-spec-name');
        const specParams = button.getAttribute('data-spec-params');

        if (specName) {
            localStorage.setItem("selectedSpecification", specName);
            localStorage.setItem("editSpecData", specParams);
            window.location.href = "IdentifyingInformation.html";
        } else {
            alert("Cannot edit: Specification name not found.");
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        // Parse URL to get entity details
        const params = new URLSearchParams(window.location.search);
        const entity = {
            Created: params.get("Created") || "",
            GoverningEntity: params.get("GoverningEntity") || "",
            NoOfUsers: params.get("NoOfUsers") || "",
            NoOfSpecifications: params.get("NoOfSpecifications") || "",
            InProgress: params.get("InProgress") || ""
        };

        // Set the page title
        document.getElementById("entityTitle").innerHTML =
            `<i class="fa-solid fa-building"></i> Viewing ${entity.GoverningEntity} Governing Entity`;

        // --- Restoring the "Entity Details" table ---
        const entityTable = `
            <table class="styled-table" style="max-width:900px;">
                <thead>
                    <tr>
                        <th>Created</th>
                        <th>Sector</th>
                        <th>Country</th>
                        <th>Primary Contact Name</th>
                        <th>Primary Contact Information</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>${entity.Created}</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        `;
        document.getElementById("entityDetails").innerHTML = entityTable;

        // --- This is the corrected "Specifications" table ---
        const specificationsTable = `
            <h2 style="margin:24px 0 8px 0;font-size:20px;">Specifications</h2>
            <table class="styled-table" id="specificationsTable" style="font-size:13px;">
                <thead>
                    <tr>
                        <th>Created/Modified</th>
                        <th>Name</th>
                        <th>Purpose</th>
                        <th>Implementation Date</th>
                        <th>Type</th>
                        <th>Sector</th>
                        <th>Country</th>
                        <th>Preferred Syntax</th>
                        <th>Conformance level</th>
                        <th>Registry Status</th>
                        <th>Last Modified by</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        `;
        document.getElementById("specificationsSection").innerHTML = specificationsTable;
        
        const tbody = document.querySelector('#specificationsTable tbody');
        const allSpecs = JSON.parse(localStorage.getItem("specifications") || "[]");
        const entitySpecs = allSpecs.filter(s => s.governingEntity === entity.GoverningEntity);
        
        tbody.innerHTML = '';
        entitySpecs.forEach(spec => {
            const tr = document.createElement('tr');
            
            const queryParams = new URLSearchParams({
                "Name": spec.specName || "",
                "Governing Entity": spec.governingEntity || "",
                "Purpose": spec.purpose || "",
                "Implementation Date": spec.implDate || "",
                "Sector": spec.sector || "",
                "Country": spec.country || "",
                "Preferred Syntax": spec.preferredSyntax || "",
                "Specification Identifier": spec.specId || "",
                "Specification Version": spec.specVersion || "",
                "Contact Information": spec.contactInfo || "",
                "Core Version": spec.coreVersion || "",
                "Underlying Specification": spec.underlyingSpec || "",
                "Specification Source Link": spec.sourceLink || "",
                "IDs": JSON.stringify(spec.coreInvoiceModelIds || [])
            }).toString();


        let actionButtonHtml = '';

        if (spec.registryStatus === 'In Progress') {
            actionButtonHtml = `<button class="view-button" onclick="startEdit(event)" data-spec-name="${spec.specName}" data-spec-params='${queryParams}'>Edit</button>`;
        } else {
            actionButtonHtml = `<button class="view-button" onclick="window.location.href='viewSpecification.html?${queryParams}'">View</button>`;
        }

        if (spec.registryStatus === 'Submitted') {
            tr.classList.add("submitted-row");
        }

        tr.innerHTML = `
                <td>${spec.implDate || 'N/A'}</td>
                <td>${spec.specName || ''}</td>
                <td>${spec.purpose || ''}</td>
                <td>${spec.implDate || ''}</td>
                <td>CIUS</td>
                <td>${spec.sector || ''}</td>
                <td>${spec.country || ''}</td>
                <td>${spec.preferredSyntax || ''}</td>
                <td>${spec.conformanceLevel || ''}</td>
                <td>${spec.registryStatus || ''}</td>
                <td>Admin</td>
                <td>${actionButtonHtml}</td>
            `;
            tbody.appendChild(tr);
        });

        // --- Restoring the "Users" table ---
        const usersTable = `
            <h2 style="margin:24px 0 8px 0;font-size:20px;">Users</h2>
            <table class="styled-table" style="font-size:13px;max-width:900px;">
                <thead>
                    <tr>
                        <th>Joined</th>
                        <th>Name</th>
                        <th>Contact Information</th>
                        <th>Contributor</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        `;
        document.getElementById("usersSection").innerHTML = usersTable;

        // Admin functionality for 'New Specification' button
        const userRole = localStorage.getItem("userRole") || "EndUser";
        if (userRole === "Admin") {
            document.getElementById("adminNewSpecContainer").innerHTML = `
                <button class="view-button" id="newSpecBtn">New Specification</button>
            `;
            document.getElementById("newSpecBtn").onclick = function() {
                localStorage.setItem("newSpecGoverningEntity", entity.GoverningEntity);
                window.location.href = "IdentifyingInformation.html";
            };
        }
    });
</script>
    </body>
</html>