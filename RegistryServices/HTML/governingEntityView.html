<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
        <link rel="stylesheet" href="../CSS/style.css">
        
        <script src="../JS/javascript.js"></script>
        
        <title>Governing Entities</title>
    </head>
    <body>
<!----------------------------------------------------------------------------
            Sidebar
  ------------------------------------------------------------------------------>
        <div class="sidebar">
            <ul>
                <li>
                    <a class="logo">
                        <span class="icon">
                            <img src="../Images/genericLogo.png" alt="Sidebar Logo" style="width: 40px; height: 40px;">
                        </span>
                        <span class="text">Registry Services</span>
                    </a>
                </li>
                <li>
                    <a href="eInvoicingSpecificationRegistry.html">
                        <span class="icon"><i class="fa-solid fa-house"></i></span>
                        <span class="text">eInvoicing Specification Registry</span>
                    </a>
                </li>
                <li class="protected">
                    <a href="governingEntityList.html">
                        <span class="icon"><i class="fa-solid fa-building"></i></span>
                        <span class="text">Governing Entities</span>
                    </a>
                </li>
                <li class="protected">
                    <a href="mySpecifications.html">
                        <span class="icon"><i class="fa-solid fa-folder"></i></span>
                        <span class="text">My Specifications</span>
                    </a>
                </li>
                <li class="protected">
                    <a href="#">
                        <span class="icon"><i class="fa-solid fa-file-medical"></i></span>
                        <span class="text">Add New Specification</span>
                    </a>
                </li>
                <li class="child-element protected">
                    <a href="IdentifyingInformation.html">
                        <span class="icon"><i class="fa-solid fa-info"></i></span>
                        <span class="text">Identifying Information</span>
                    </a>
                </li>
                <li class="child-element">
                    <a href="coreInvoiceModel.html">
                        <span class="icon"><i class="fa-solid fa-car"></i></span>
                        <span class="text">Core Invoice Model</span>
                    </a>
                </li>
                <li class="child-element">
                    <a href="ExtensionComponentDataModel.html">
                        <span class="icon"><i class="fa-solid fa-trailer"></i></span>
                        <span class="text">Extension Component Data Model</span>
                    </a>
                </li>
                <li class="child-element protected">
                    <a href="additionalRequirements.html">
                        <span class="icon"><i class="fa-solid fa-circle-plus"></i></span>
                        <span class="text">Additional Requirements</span>
                    </a>
                </li>
                <li class="child-element protected">
                    <a href="specificationPreview.html">
                        <span class="icon"><i class="fa-solid fa-square-check"></i></span>
                        <span class="text">Specification Preview</span>
                    </a>
                </li>
                <li id="loginLogoutItem">
                    <a href="#" onclick="toggleLogin()">
                        <span class="icon"><i class="fa-solid fa-right-from-bracket"></i></span>
                        <span class="text" id="loginLogoutButton">Logout</span>
                    </a>
                </li>
            </ul>
        </div>
<script>
if (localStorage.userRole === "Admin") {
    const sidebar = document.querySelector('.sidebar ul');
    if (sidebar) {
        const li = document.createElement('li');
        li.className = "child-element protected";
        li.innerHTML = `
            <a href="ExtensionComponentDataModelAdmin.html">
                <span class="icon"><i class="fa-solid fa-eye"></i></span>
                <span class="text">VIEW EXTENSION COMPONENT DATA MODEL (ADMIN)</span>
            </a>
        `;
        sidebar.appendChild(li);
    }
}
</script>

<!----------------------------------------------------------------------------
            Governing Entities Table
  ------------------------------------------------------------------------------>
        <div class="page-Content">
            <h1 id="entityTitle"><i class="fa-solid fa-building"></i> Viewing Governing Entity</h1>
            <br/>
            <button onclick="window.location.href='governingEntityList.html';">Return to Governing Entity List</button>
            <div id="adminNewSpecContainer"></div>
            <div id="entityDetails"></div>
            <div id="specificationsSection"></div>
            <div id="usersSection"></div>
        </div>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        // Parse the URL parameters to get the Governing Entity details
        const params = new URLSearchParams(window.location.search);
        const entity = {
            Created: params.get("Created") || "",
            GoverningEntity: params.get("GoverningEntity") || "",
            NoOfUsers: params.get("NoOfUsers") || "",
            NoOfSpecifications: params.get("NoOfSpecifications") || "",
            InProgress: params.get("InProgress") || ""
        };

        // Set the title
        document.getElementById("entityTitle").innerHTML =
            `<i class="fa-solid fa-building"></i> Viewing ${entity.GoverningEntity} Governing Entity`;

        // Main entity info table (matching mockup columns)
        const entityTable = `
            <table class="styled-table" style="max-width:900px;">
                <thead>
                    <tr>
                        <th>Created</th>
                        <th>Sector</th>
                        <th>Country</th>
                        <th>Primary Contact Name</th>
                        <th>Primary Contact Information</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>${entity.Created}</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    </tr>
                </tbody>
            </table>
        `;
        document.getElementById("entityDetails").innerHTML = entityTable;

        // Specifications table with columns (matching mockup)
        const specificationsTable = `
            <h2 style="margin:24px 0 8px 0;font-size:20px;">Specifications</h2>
            <table class="styled-table" id="specificationsTable" style="font-size:13px;">
                <thead>
                    <tr>
                        <th>Created/Modified</th>
                        <th>Name</th>
                        <th>Purpose</th>
                        <th>Implementation Date</th>
                        <th>Type</th>
                        <th>Sector</th>
                        <th>Country</th>
                        <th>Preferred Syntax</th>
                        <th>Conformance level</th>
                        <th>Registry Status</th>
                        <th>Last Modified by</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data rows go here -->
                </tbody>
            </table>
        `;
        document.getElementById("specificationsSection").innerHTML = specificationsTable;

        // Users table with columns (matching mockup)
        const usersTable = `
            <h2 style="margin:24px 0 8px 0;font-size:20px;">Users</h2>
            <table class="styled-table" style="font-size:13px;max-width:900px;">
                <thead>
                    <tr>
                        <th>Joined</th>
                        <th>Name</th>
                        <th>Specifications submitted</th>
                        <th>In Progress</th>
                        <th>Contact Information</th>
                        <th>Contributor</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Data rows go here -->
                </tbody>
            </table>
        `;
        document.getElementById("usersSection").innerHTML = usersTable;

        // New JavaScript code for Admin functionality
        const entityName = params.get("GoverningEntity") || "";
        // Only show for Admin
        const userRole = localStorage.getItem("userRole") || "EndUser";
        if (userRole === "Admin") {
            document.getElementById("adminNewSpecContainer").innerHTML = `
                <button class="view-button" id="newSpecBtn">New Specification</button>
            `;
            document.getElementById("newSpecBtn").onclick = function() {
                // Save Governing Entity context for prefill
                localStorage.setItem("newSpecGoverningEntity", entityName);
                window.location.href = "IdentifyingInformation.html";
            };
        }

        // Specifications table population based on localStorage data
        const tbody = document.querySelector('#specificationsTable tbody');
        let specs = JSON.parse(localStorage.getItem("specifications") || "[]");
        let entitySpecs = specs.filter(s =>
            s.governingEntity === entityName &&
            (s.registryStatus === "Submitted" || s.registryStatus === "In Progress")
        );
        console.log("entityName:", entityName);
        console.log("All specs:", specs);
        console.log("Filtered specs:", entitySpecs);
        tbody.innerHTML = '';
        entitySpecs.forEach(spec => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${new Date().toLocaleDateString()}</td>
                <td>${spec.specName || ""}</td>
                <td>${spec.purpose || ""}</td>
                <td>${spec.implDate || ""}</td>
                <td>CIUS</td>
                <td>${spec.sector || ""}</td>
                <td>${spec.country || ""}</td>
                <td>${spec.preferredSyntax || ""}</td>
                <td></td>
                <td>${spec.registryStatus || ""}</td>
                <td>Admin</td>
            `;
            tbody.appendChild(tr);
        });

        document.addEventListener("DOMContentLoaded", function() {
            // Get Governing Entity name from URL param
            const params = new URLSearchParams(window.location.search);
            const currentEntity = params.get("GoverningEntity") || "";

            // Load specifications from localStorage
            const allSpecs = JSON.parse(localStorage.getItem("specifications") || "[]");

            // Filter for this Governing Entity (case/whitespace-insensitive)
            const matchingSpecs = allSpecs.filter(s =>
                s.governingEntity &&
                s.governingEntity.trim().toLowerCase() === currentEntity.trim().toLowerCase()
            );

            // Get the table body
            const specsTableBody = document.querySelector("#specificationsTable tbody");
            specsTableBody.innerHTML = "";

            if (matchingSpecs.length === 0) {
                const row = specsTableBody.insertRow();
                const cell = row.insertCell();
                cell.colSpan = 11;
                cell.textContent = "No specifications found.";
            } else {
                matchingSpecs.forEach(spec => {
                    const row = specsTableBody.insertRow();
                    row.insertCell().textContent = new Date().toLocaleDateString(); // Created/Modified
                    row.insertCell().textContent = spec.specName || "";
                    row.insertCell().textContent = spec.purpose || "";
                    row.insertCell().textContent = spec.implDate || "";
                    row.insertCell().textContent = "CIUS"; // Type (hardcoded)
                    row.insertCell().textContent = spec.sector || "";
                    row.insertCell().textContent = spec.country || "";
                    row.insertCell().textContent = spec.preferredSyntax || "";
                    row.insertCell().textContent = spec.conformanceLevel || ""; // Conformance level (empty for now)
                    row.insertCell().textContent = spec.registryStatus || "";
                    row.insertCell().textContent = "Admin"; // Last Modified by (hardcoded)
                });
            }
        });
    });
</script>
    </body>
</html>